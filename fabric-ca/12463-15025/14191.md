<strong>Project</strong>: fabric-ca<br><strong>Branch</strong>: master<br><strong>ID</strong>: 14191<br><strong>Subject</strong>: [FAB-6328] Fix cleanup of unit-tests temp files<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 10/4/2017, 8:31:50 AM<br><strong>LastUpdated</strong>: 1/7/2018, 1:40:33 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-6328] Fix cleanup of unit-tests temp files

This change introduces a more systematic policy of removing files
generated by each test so that they do not pollute the environment
they are run in and they are effectively independent from one
another. This includes both files created locally and in os.TempDir.

For instance, before this change one cannot run TestCLIClient twice:

$ go test -v -run ^TestCLIClient\$
=== RUN   TestCLIClient
--- PASS: TestCLIClient (8.56s)
	client_test.go:223: GetCAInfo error Failed to create keystore
directory: mkdir /home/lehors/Projects/Go/src/github.com/hyperledger/
fabric-ca/lib/: invalid argument
[...]
	client_test.go:436: Client Enroll error Failure generating CS
R: Invalid algorithm: dsa
PASS
ok  	github.com/hyperledger/fabric-ca/lib	8.575s
lehors:~/Projects/Go/src/github.com/hyperledger/fabric-ca/lib
$ go test -v -run ^TestCLIClient\$
=== RUN   TestCLIClient
--- FAIL: TestCLIClient (2.49s)
	client_test.go:223: GetCAInfo error Failed to create keystore
 directory: mkdir /home/lehors/Projects/Go/src/github.com/hyperledger
/fabric-ca/lib/: invalid argument
	client_test.go:231: GetCAInfo error address localhost:[:7054:
 too many colons in address
	client_test.go:240: GetCAInfo error POST failure of request:
POST http:///cainfo
		Authorization:
		{}: Post http:///cainfo: http: no Host in request URL
	client_test.go:255: CheckEnrollment error <nil>
	client_test.go:257: testRegister check enrollment should have
 failed - client not enrolled
FAIL
exit status 1
FAIL	github.com/hyperledger/fabric-ca/lib	2.496s

The reason for the failure on the second run is merely that the first
run left some temporary directory behind that trips the second run.

With this change, all files and directories created by each test are
deleted at the end of each test, even when the test fails half way
through.

Patch-set #2: Fixed format errors. :-/
Patch-set #3: Rebased

Change-Id: Icb7da9df150774387762cbc116a3445ffde02b7d
Signed-off-by: Arnaud J Le Hors <lehors@us.ibm.com>
Signed-off-by: Keith Smith <bksmith@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Reviewed</strong>: 10/4/2017, 8:31:50 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 8:31:58 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/1960/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 8:42:56 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/1952/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 8:49:07 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/1952/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/1952/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-ca-verify-x86_64/1952

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/1960/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/1960/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-ca-verify-s390x/1960</pre><strong>Reviewer</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Reviewed</strong>: 10/4/2017, 9:28:37 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 9:28:48 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/1961/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 9:32:58 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/1953/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/4/2017, 10:08:01 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/1953/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-ca-verify-x86_64/1953

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/1961/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-ca-verify-s390x/1961</pre><strong>Reviewer</strong>: AnilKumar Ambati - aambati@hotmail.com<br><strong>Reviewed</strong>: 10/11/2017, 4:22:15 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(3 comments)</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/9/2017, 11:41:36 AM<br><strong>Message</strong>: <pre>Removed reviewer Keith Kee.</pre><strong>Reviewer</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Reviewed</strong>: 11/23/2017, 7:12:20 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/23/2017, 7:12:29 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2348/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/23/2017, 7:17:19 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2319/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/23/2017, 8:09:34 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2348/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/2348

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2319/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/2319</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 12/10/2017, 7:09:33 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 12/13/2017, 6:15:30 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Reviewed</strong>: 12/13/2017, 6:44:29 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(5 comments)</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/3/2018, 10:18:15 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:18:27 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2497/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:19:18 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2468/ (2/2)</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/3/2018, 10:22:05 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:22:12 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2498/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:22:15 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2469/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:22:16 AM<br><strong>Message</strong>: <pre>Patch Set 4: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2468/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2468/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/2468

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2497/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2497/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/2497</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/3/2018, 10:23:26 AM<br><strong>Message</strong>: <pre>Patch Set 5:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:23:32 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2499/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:23:36 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2470/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 10:23:47 AM<br><strong>Message</strong>: <pre>Patch Set 5: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2469/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2469/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/2469

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2498/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2498/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/2498</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/3/2018, 10:27:12 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(4 comments)

Rebased and fixed all occurrences of passing a directory name instead filename to newCA</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2018, 11:14:41 AM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/2470/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/2470

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/2499/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/2499</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 1/6/2018, 9:21:12 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Arnaud J Le Hors and AnilKumar Ambati: would you be so kind as to taking another look at the latest to confirm that you have no other suggestions or objections here?

Thank you, J</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/7/2018, 4:51:02 AM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 1/7/2018, 12:34:29 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 1/7/2018, 12:34:31 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jonathan Levi (HACERA)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/7/2018, 1:40:33 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-merge-s390x/378/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-merge-s390x/378

https://jenkins.hyperledger.org/job/fabric-ca-merge-x86_64/378/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-merge-x86_64/378</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Created</strong>: 10/4/2017, 8:31:50 AM<br><strong>UnmergedRevision</strong>: 08b300ef772355236f18931a0419cb7b6cfb0992<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 10/4/2017, 8:49:07 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Created</strong>: 10/4/2017, 9:28:37 AM<br><strong>UnmergedRevision</strong>: 9cfb42c91c5f8fc8959050c625d124a295630d10<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 10/4/2017, 10:08:01 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Created</strong>: 11/23/2017, 7:12:20 AM<br><strong>UnmergedRevision</strong>: ea99fff7fd2e97bd9e2d694d66faaa65a3cd98d4<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/23/2017, 8:09:34 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Created</strong>: 1/3/2018, 10:18:15 AM<br><strong>UnmergedRevision</strong>: e55945ffee9b3449b6354d69997aab5b5e6ac3e8<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/3/2018, 10:22:16 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Created</strong>: 1/3/2018, 10:22:05 AM<br><strong>GitHubMergedRevision</strong>: [ba154578696eb762981a0e7c6129cd562a69dbea](https://github.com/hyperledger/fabric-ca/commit/ba154578696eb762981a0e7c6129cd562a69dbea)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/3/2018, 11:14:41 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Approved</strong>: 1/7/2018, 12:34:29 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jonathan Levi (HACERA)<br><strong>Merged</strong>: 1/7/2018, 12:34:31 PM<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 1/7/2018, 4:51:02 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>