<strong>Project</strong>: fabric-ca<br><strong>Branch</strong>: master<br><strong>ID</strong>: 28464<br><strong>Subject</strong>: [FABC-785] Add metrics for server APIs<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/3/2019, 12:43:15 PM<br><strong>LastUpdated</strong>: 1/23/2019, 4:24:23 PM<br><strong>CommitMessage</strong>:<br><pre>[FABC-785] Add metrics for server APIs

Added rate, error, and duration metrics for server
APIs

Change-Id: Ia7ec7860ac4b8b177d49f84e1290000b53a67813
Signed-off-by: Saad Karim <skarim@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/3/2019, 12:43:15 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 12:43:28 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3612/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 12:46:13 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/929/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 12:46:23 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3508/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 1:47:14 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3508/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/3508

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/929/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/929

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3612/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/3612</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/3/2019, 8:30:14 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 8:30:25 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3624/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 8:32:45 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/943/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 8:33:00 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3522/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/3/2019, 9:25:49 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/943/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/943

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3522/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/3522

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3624/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/3624</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/14/2019, 4:05:33 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3: Patch Set 2 was rebased.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 4:05:42 PM<br><strong>Message</strong>: <pre>Patch Set 3: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3636/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 4:07:14 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/957/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 4:07:54 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3535/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2019, 4:52:29 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/957/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/957

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3535/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/3535

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3636/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/3636</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 1/14/2019, 5:19:17 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(5 comments)</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/15/2019, 7:33:57 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review-1

(1 comment)</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2019, 11:22:44 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2019, 11:22:47 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(6 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 11:22:56 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3643/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 11:25:30 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/964/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 11:25:58 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-rtd-verify-job/249/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 11:28:02 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3542/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 12:04:54 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/964/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/964

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3542/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/3542

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3643/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/3643

https://jenkins.hyperledger.org/job/fabric-ca-rtd-verify-job/249/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-rtd-verify-job/249</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2019, 12:08:38 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 12:08:46 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3646/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 12:09:34 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/966/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 12:10:31 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-rtd-verify-job/251/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 12:10:49 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3544/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 1:05:05 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/966/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/966

https://jenkins.hyperledger.org/job/fabric-ca-rtd-verify-job/251/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-rtd-verify-job/251

https://jenkins.hyperledger.org/job/fabric-ca-verify-x86_64/3544/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-x86_64/3544

https://jenkins.hyperledger.org/job/fabric-ca-verify-s390x/3646/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-s390x/3646</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2019, 9:55:48 PM<br><strong>Message</strong>: <pre>Patch Set 5:

reverify-e2e</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 9:58:23 PM<br><strong>Message</strong>: <pre>Patch Set 5: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/973/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2019, 10:17:30 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-ca-verify-end-2-end-x86_64/973/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-verify-end-2-end-x86_64/973</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/21/2019, 12:23:24 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/22/2019, 2:23:57 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/22/2019, 2:24:41 PM<br><strong>Message</strong>: <pre>Patch Set 5:

LGTM but Matt had some comments as well.  Looks like they were addressed but will let him commit</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 1/23/2019, 3:39:15 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Keith Smith</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2019, 4:24:23 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-ca-merge-end-2-end-x86_64/195/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-merge-end-2-end-x86_64/195

https://jenkins.hyperledger.org/job/fabric-ca-merge-s390x/599/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-merge-s390x/599

https://jenkins.hyperledger.org/job/fabric-ca-merge-x86_64/600/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-ca-merge-x86_64/600</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Uploader</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Created</strong>: 1/3/2019, 12:43:15 PM<br><strong>UnmergedRevision</strong>: [1cbe9ac01e67cf98e4fc165cb8f04998a4f3e04b](https://github.com/hyperledger-gerrit-archive/fabric-ca/commit/1cbe9ac01e67cf98e4fc165cb8f04998a4f3e04b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/3/2019, 1:47:14 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Uploader</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Created</strong>: 1/3/2019, 8:30:14 PM<br><strong>UnmergedRevision</strong>: [d6156005e18ee20e0104a48c9ee3c00473787c15](https://github.com/hyperledger-gerrit-archive/fabric-ca/commit/d6156005e18ee20e0104a48c9ee3c00473787c15)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/3/2019, 9:25:49 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Uploader</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Created</strong>: 1/14/2019, 4:05:33 PM<br><strong>UnmergedRevision</strong>: [12ccc2d9ede1b831745a2fca428b123455489a42](https://github.com/hyperledger-gerrit-archive/fabric-ca/commit/12ccc2d9ede1b831745a2fca428b123455489a42)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2019, 4:52:29 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Approved</strong>: 1/15/2019, 7:33:57 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [lib/metrics.go#L7](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L7)<br><strong>Comment</strong>: <pre>Since metrics apply only to the server, I recommend putting this in the lib/server package (or in a lib/server/metrics package in the spirit of having small packages).  No reason to make the go SDK any bigger for something it isn't going to use.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics.go#L7](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L7)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics.go#L27](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L27)<br><strong>Comment</strong>: <pre>Should this be the status code from the response?

If we include the status code, doesn't that give us an easy way to determine success and failure? In prom, we can see anything between 200 >= code < 400 is good.

Basically, not sure we need to know if it's a count or error count.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics.go#L27](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L27)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics.go#L35](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L35)<br><strong>Comment</strong>: <pre>This should include the status code from the response.

A 401 (regardless of the API) is probably going to return very quick because it doesn't do anything. That will skew some of the stats for successful calls.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics.go#L35](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics.go#L35)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics_test.go#L54](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics_test.go#L54)<br><strong>Comment</strong>: <pre>Looks like we're using literals for most things (and we probably should in tests). Seems we should be consistent and make this the literal "/test" as well.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/metrics_test.go#L54](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/metrics_test.go#L54)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [lib/server.go#L506](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/server.go#L506)<br><strong>Comment</strong>: <pre>Are we doing a defer because of panics? Doesn't seem any other reason for it.

If we do get a panic, I assume we're handling it and not terminating because if we terminate, the duration will never get recorded anyway.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/server.go#L506](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/server.go#L506)<br><strong>Comment</strong>: <pre>Yeah, the defer was not really needed.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [lib/serverendpoint.go#L55](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/serverendpoint.go#L55)<br><strong>Comment</strong>: <pre>This is really unfortunately. I think I know why you're doing this here instead of middleware but it really does break the abstraction.

Take a look at https://github.com/felixge/httpsnoop or https://github.com/prometheus/client_golang/blob/master/prometheus/promhttp/delegator_1_8.go for examples of others have worked around this.

TBD if we want to go with one of these approaches.</pre><strong>Commenter</strong>: Saad Karim - skarim@us.ibm.com<br><strong>CommentLine</strong>: [lib/serverendpoint.go#L55](https://github.com/hyperledger-gerrit-archive/fabric-ca/blob/12ccc2d9ede1b831745a2fca428b123455489a42/lib/serverendpoint.go#L55)<br><strong>Comment</strong>: <pre>Done. Using httpsnoop allows us to capture all the metrics in one location.</pre></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Uploader</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Created</strong>: 1/16/2019, 11:22:44 AM<br><strong>UnmergedRevision</strong>: [5b9e4c25ad125e4d19626fc5c1fdbc1dd54f89c4](https://github.com/hyperledger-gerrit-archive/fabric-ca/commit/5b9e4c25ad125e4d19626fc5c1fdbc1dd54f89c4)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/16/2019, 12:04:54 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Uploader</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Created</strong>: 1/16/2019, 12:08:38 PM<br><strong>GitHubMergedRevision</strong>: [3e4b58b20eb67b3a534c0985ea08894c623e8329](https://github.com/hyperledger-gerrit-archive/fabric-ca/commit/3e4b58b20eb67b3a534c0985ea08894c623e8329)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/16/2019, 10:17:30 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Approved</strong>: 1/21/2019, 12:23:24 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Keith Smith<br><strong>Merged</strong>: 1/23/2019, 3:39:15 PM<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 1/22/2019, 2:23:57 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>