<strong>Project</strong>: fabric-cop<br><strong>Branch</strong>: master<br><strong>ID</strong>: 2531<br><strong>Subject</strong>: Improve COP CLI error messages<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 11/16/2016, 10:30:14 AM<br><strong>LastUpdated</strong>: 11/20/2016, 12:43:38 AM<br><strong>CommitMessage</strong>:<br><pre>Improve COP CLI error messages

The COP CLI error messages had garbage and didn't report useful information.
These changes fixes the formatting issue and also improves usability by reporting
better error messages.

See https://jira.hyperledger.org/browse/FAB-1132

Change-Id: I63f3acfde5c21c476844c8d287554eda8252bc96
Signed-off-by: Keith Smith <bksmith@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/16/2016, 10:30:14 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 10:33:59 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/32/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 10:39:58 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/32/ : FAILURE</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/16/2016, 10:45:59 AM<br><strong>Message</strong>: <pre>Patch Set 1:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 10:46:51 AM<br><strong>Message</strong>: <pre>Patch Set 1: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/33/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 10:52:18 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/33/ : SUCCESS</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/16/2016, 11:15:55 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 11:16:56 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/34/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 11:24:00 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/34/ : SUCCESS</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/16/2016, 12:47:53 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Ashutosh Kumar - ashutosh_kumar@hotmail.com<br><strong>Reviewed</strong>: 11/16/2016, 1:05:59 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(2 comments)</pre><strong>Reviewer</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Reviewed</strong>: 11/16/2016, 1:56:22 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+1</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 11/18/2016, 2:18:27 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(10 comments)

Hi Keith,

First of all, thanks for this - the added tests and the clearer messages/docs - are clearly an improvement!

My review contains three parts, in order of (ascending) importance :

1. Error messages:
As you are improving error messages, can we have a quick run-down and start all the Debug/Log messages begin with a capital letter (for consistency)?

2. A few inline suggestions/requests below. I have tried to elaborate and explain the reasoning.

3. Vendor'ed changes:
IMHO, we should not be updating "vendor"ed packages, inline. I have made a few suggestions below, but it might be also good before taking any alternative, to check whether we really need to add that method to CloudFlare's vendor'ed code?

Thank you, Jonathan</pre><strong>Reviewer</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Reviewed</strong>: 11/18/2016, 3:54:33 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(1 comment)</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/19/2016, 10:54:14 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/19/2016, 10:55:14 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/48/</pre><strong>Reviewer</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Reviewed</strong>: 11/19/2016, 10:56:45 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(10 comments)

Addressed all comments in patch set 3</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/19/2016, 11:01:35 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-cop-verify-x86_64/48/ : SUCCESS</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 11/19/2016, 1:45:56 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 11/20/2016, 12:35:45 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2

Thank you Keith</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 11/20/2016, 12:35:48 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jonathan Levi</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/20/2016, 12:36:49 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-cop-merge-x86_64/3/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/20/2016, 12:43:38 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-cop-merge-x86_64/3/ : FAILURE</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Uploader</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Created</strong>: 11/16/2016, 10:30:14 AM<br><strong>UnmergedRevision</strong>: [95bc06780893cc1842b0f817dc30148c5e3e6c69](https://github.com/hyperledger-gerrit-archive/fabric-cop/commit/95bc06780893cc1842b0f817dc30148c5e3e6c69)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/16/2016, 10:52:18 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Uploader</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Created</strong>: 11/16/2016, 11:15:55 AM<br><strong>UnmergedRevision</strong>: [7bf01ad68a3d130255fd5a187eef5b992f111ca8](https://github.com/hyperledger-gerrit-archive/fabric-cop/commit/7bf01ad68a3d130255fd5a187eef5b992f111ca8)<br><br><strong>Approver</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Approved</strong>: 11/18/2016, 3:54:33 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/16/2016, 11:24:00 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Approved</strong>: 11/18/2016, 2:18:27 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Saad Karim - skarim@us.ibm.com<br><strong>Approved</strong>: 11/16/2016, 1:56:22 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [cli/client/enroll.go#L50](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/client/enroll.go#L50)<br><strong>Comment</strong>: <pre>Please can we update this too?</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/client/enroll.go#L50](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/client/enroll.go#L50)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Ashutosh Kumar - ashutosh_kumar@hotmail.com<br><strong>CommentLine</strong>: [cli/client/enroll.go#L109](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/client/enroll.go#L109)<br><strong>Comment</strong>: <pre>Should not we give generic error message to user and log message for debugging purposes ?</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/client/enroll.go#L109](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/client/enroll.go#L109)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [cli/server/auth.go#L117](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/auth.go#L117)<br><strong>Comment</strong>: <pre>Please will it be possible to start each printed sentence with a capital letter?</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/server/auth.go#L117](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/auth.go#L117)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [cli/server/auth.go#L127](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/auth.go#L127)<br><strong>Comment</strong>: <pre>We should probably check the returned error, prior to using the returned "body"...
You should probably move the check in line 127-129 one line up.</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/server/auth.go#L127](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/auth.go#L127)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [cli/server/enroll.go#L83](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/enroll.go#L83)<br><strong>Comment</strong>: <pre>There is some "terminology war" in Golang these days regarding whether Golang is OOP.... are these actually "constructors" (as they are not really part of the class/struct), etc.

How about something along these lines,

// NewEnrollUser returns an pointer to an allocated enroll struct, populated with the DB information (that set in the config) or nil on error.</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/server/enroll.go#L83](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/enroll.go#L83)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [cli/server/enroll.go#L89](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/enroll.go#L89)<br><strong>Comment</strong>: <pre>BTW: GetDB() can "throw" right?</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [cli/server/enroll.go#L89](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/cli/server/enroll.go#L89)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [lib/client.go#L206](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L206)<br><strong>Comment</strong>: <pre>Noting that you are overwriting the err returned from the Unmarshaling...
We are entering the 'else' clause if either "err != nil"... or [if len() <= 0 ]

Is this OK? We might want to simulate/add a few tests to verify these.</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [lib/client.go#L208](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L208)<br><strong>Comment</strong>: <pre>1. Capital S (for Server). Sorry ;-)... but more importantly,

2. I'm not sure it is "Server error", since we are in the client, etc..

The standard states for example that 400+ class of status code is "intended for situations in which the client seems to have erred." ...but I know what you mean. You refer to cases where the server response is, say, non-compliant AND when Status is not OK ? If I got this right, then see 3) below:

3. We are overriding err here. How about we print out the response (and not only the error from json.Unmarshal())</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [lib/client.go#L208](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L208)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Ashutosh Kumar - ashutosh_kumar@hotmail.com<br><strong>CommentLine</strong>: [lib/client.go#L234](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L234)<br><strong>Comment</strong>: <pre>Does port needs to be hard coded ? Can we make it configurable ?</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [lib/client.go#L234](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L234)<br><strong>Comment</strong>: <pre>Good point Ash, I agree.

Keith: even if we choose not to have it configurable at this point, we can put it in a variable so that it's clearer (e.g. that port 8888 is being used)</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [lib/client.go#L234](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L234)<br><strong>Comment</strong>: <pre>This was code that I copied from CFSSL.  The default port for CFSSL is 8888.  I'll make this a const along with a comment.</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [lib/client.go#L242](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L242)<br><strong>Comment</strong>: <pre>Just to check: Is this the preferred logic? (e.g., if the scheme was not specified, then we use "http" ?</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [lib/client.go#L242](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/lib/client.go#L242)<br><strong>Comment</strong>: <pre>This was from CFSSL.  I'd be hesitant to change it without understanding fully any reprocussions.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [vendor/github.com/cloudflare/cfssl/errors/http.go#L48](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/vendor/github.com/cloudflare/cfssl/errors/http.go#L48)<br><strong>Comment</strong>: <pre>Just a small question if I may- is there a PR on https://github.com/cloudflare/cfssl/pulls to add this method? because if there isn't- each time we update the folder in the vendor, it'd break the build, and we'll need to do a new PR here on gerrit.</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [vendor/github.com/cloudflare/cfssl/errors/http.go#L48](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/vendor/github.com/cloudflare/cfssl/errors/http.go#L48)<br><strong>Comment</strong>: <pre>I don't believe we should be changing the code under the vendor package. If we really need to, I suggest to either have our own clone (say, on github) and vendor that, or to import it locally and check it in outside the vendor'ed directory (which is much less preferable).

But whatever we choose, it should not be updated "inline" and there are many good reasons for it (one of them highlighted by Yacov above, indeed).

Given the two options (github or a local, non-vendor'ed directory checked-in under the same branch) I wonder if we really need this (inline) change to the vendor'ed code?</pre><strong>Commenter</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>CommentLine</strong>: [vendor/github.com/cloudflare/cfssl/errors/http.go#L48](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/vendor/github.com/cloudflare/cfssl/errors/http.go#L48)<br><strong>Comment</strong>: <pre>we should under no circumstance be modifying vendored code. submit a change upstream and lobby for it to be merged and a new version published.</pre><strong>Commenter</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>CommentLine</strong>: [vendor/github.com/cloudflare/cfssl/errors/http.go#L48](https://github.com/hyperledger-gerrit-archive/fabric-cop/blob/7bf01ad68a3d130255fd5a187eef5b992f111ca8/vendor/github.com/cloudflare/cfssl/errors/http.go#L48)<br><strong>Comment</strong>: <pre>Reverting change</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Uploader</strong>: Keith Smith - keithsmithlfid@gmail.com<br><strong>Created</strong>: 11/19/2016, 10:54:14 AM<br><strong>GitHubMergedRevision</strong>: [46ce6bee1a4908acf32c70c2e00c0500cc56812e](https://github.com/hyperledger-gerrit-archive/fabric-cop/commit/46ce6bee1a4908acf32c70c2e00c0500cc56812e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/19/2016, 11:01:35 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Approved</strong>: 11/20/2016, 12:35:45 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jonathan Levi (HACERA)<br><strong>Merged</strong>: 11/20/2016, 12:35:48 AM<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 11/19/2016, 1:45:56 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>