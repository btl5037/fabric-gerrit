<strong>Project</strong>: fabric-sdk-node<br><strong>Branch</strong>: master<br><strong>ID</strong>: 3885<br><strong>Subject</strong>: BCCSP PKCS11 implementation for node.js SDK<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Gong Su - gong_su@hotmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/11/2017, 10:28:55 PM<br><strong>LastUpdated</strong>: 1/23/2017, 11:19:43 PM<br><strong>CommitMessage</strong>:<br><pre>BCCSP PKCS11 implementation for node.js SDK

[FAB-283] PKCS11 implementation for BlockChain Crypto Service
Provider (BCCSP).

Patch 9:  Converted test case to a 'tape' suite
Patch 10: Don't specify CKA_VALUE_LEN when importing AES key (for SoftHSMv2 to work)

Change-Id: Ie1952942dbe67448211e1d3968b9aaf2bf82c576
Signed-off-by: Gong Su <gongsugongsu@gmail.com>
Signed-off-by: Jim Zhang <jzhang@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/11/2017, 10:28:55 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/11/2017, 10:29:56 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/251/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/11/2017, 10:33:12 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/251/ : FAILURE</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/13/2017, 10:06:48 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Notice the build failure?</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/13/2017, 11:55:00 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 11:55:55 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/252/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 11:58:54 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/252/ : FAILURE</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/13/2017, 12:06:41 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 12:07:37 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/253/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 12:11:14 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/253/ : FAILURE</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/13/2017, 12:13:46 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 12:14:59 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/254/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 12:19:06 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/254/ : SUCCESS</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/13/2017, 3:08:04 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/13/2017, 9:14:58 PM<br><strong>Message</strong>: <pre>Patch Set 4:

> (2 comments)

Tamas made it clear that wrap/unwrap is only necessary for pub/priv keys. For AES key you don't need it. I've tested using the imported AES key to encrypt and decrypt and that works. I haven't compared the results of encrypting using the software key and the imported key. We may do that when I get around.</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 11:17:12 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)

A few more comments. Mainly thinking how keys 'survive' across sessions/execution.</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/16/2017, 11:30:22 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 3:21:44 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/16/2017, 4:29:11 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review-1

thanks Gong for this work. Before going into more in-depth review first thing we need is enhancing the headless-tests.js to drive these new functions with a software HSM mockup library</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/16/2017, 10:12:48 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/16/2017, 11:02:02 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 11:02:59 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/264/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 11:06:51 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/264/ : SUCCESS</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 12:18:51 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)

A few more comments as I am making way through the same code on the golang side..</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 12:32:10 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 12:34:51 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 1:32:58 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 2:04:09 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 2:14:22 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 2:28:10 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 3:56:35 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review-1

(2 comments)

see comments below. also are you working on unit tests? -1 is for the lack of unit tests to try this stuff out.</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 4:06:44 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 9:55:51 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 10:05:21 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 11:02:23 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(3 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/17/2017, 11:34:01 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(2 comments)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 11:53:29 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(2 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 12:17:56 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(2 comments)</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/18/2017, 12:34:33 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(2 comments)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 12:59:36 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 5:50:56 AM<br><strong>Message</strong>: <pre>Patch Set 5:

> (2 comments)
 > 
 > see comments below. also are you working on unit tests? -1 is for
 > the lack of unit tests to try this stuff out.

No I'm not working on the unit tests. I have my own simple functional tests but I don't know the headless test suite well enough to make changes for the unit tests.</pre><strong>Reviewer</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>Reviewed</strong>: 1/18/2017, 8:58:58 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

I talked to Ramesh and Gari, Ramesh will submit a change to Greg for baseimage to contain softhsm. That way people can run run `make unit-tests` without having to install softhsm themselves.
Ramesh knows that you need that to get this item approved (and that you installed softhsm, if he has config questions, if I am unreachable for the next few days)</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 10:13:41 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 1:51:59 PM<br><strong>Message</strong>: <pre>Patch Set 5: -Code-Review

(1 comment)

> (1 comment)

yeah any request from the SDK to the network, including queries, must be signed so you'd need the private key corresponding to the app user's ecert</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/18/2017, 2:24:27 PM<br><strong>Message</strong>: <pre>Patch Set 5:

> No I'm not working on the unit tests. I have my own simple
 > functional tests but I don't know the headless test suite well
 > enough to make changes for the unit tests.

I realized softhsm install is not a simple "npm install softhsm", so the test should be written in a separate file to be run with discretion, like in a CI job specifically set up with the libraries. if you share you test code here i can help wrapping it in a proper node.js test case we use.</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 8:59:52 AM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 9:00:48 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/280/</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 9:02:40 AM<br><strong>Message</strong>: <pre>Patch Set 5:

> > No I'm not working on the unit tests. I have my own simple
 > > functional tests but I don't know the headless test suite well
 > > enough to make changes for the unit tests.
 > 
 > I realized softhsm install is not a simple "npm install softhsm",
 > so the test should be written in a separate file to be run with
 > discretion, like in a CI job specifically set up with the
 > libraries. if you share you test code here i can help wrapping it
 > in a proper node.js test case we use.

When you say "share your test code here" do you mean I just copy and paste my test code in the reply here or is there some way to upload the code somewhere? Thanks.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 9:04:34 AM<br><strong>Message</strong>: <pre>Patch Set 6: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/280/ : SUCCESS</pre><strong>Reviewer</strong>: Elli Androulaki - lli@zurich.ibm.com<br><strong>Reviewed</strong>: 1/19/2017, 10:29:50 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Hi guys, 

Is this ready for review? If so, please add FAB-283 to the front, and post a message on fabric-pr-review for maintainers to take a look at it.

Thanks!
Elli</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 11:29:19 AM<br><strong>Message</strong>: <pre>Patch Set 6:

> When you say "share your test code here" do you mean I just copy
 > and paste my test code in the reply here or is there some way to
 > upload the code somewhere? Thanks.

yes you can upload it in a file under test/unit and include it in this changeset. i can make further updates to this changeset so it'll go in together.</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 9:51:19 PM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 9:52:12 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/286/</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 9:52:52 PM<br><strong>Message</strong>: <pre>Patch Set 6:

> > When you say "share your test code here" do you mean I just copy
 > > and paste my test code in the reply here or is there some way to
 > > upload the code somewhere? Thanks.
 > 
 > yes you can upload it in a file under test/unit and include it in
 > this changeset. i can make further updates to this changeset so
 > it'll go in together.

OK thanks. I just pushed another patch set with the code in test/unit/pkcs11-tests.js</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 9:55:47 PM<br><strong>Message</strong>: <pre>Patch Set 7: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/286/ : FAILURE</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/19/2017, 11:29:29 PM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 11:30:27 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/287/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2017, 11:34:13 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/287/ : SUCCESS</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 12:25:16 AM<br><strong>Message</strong>: <pre>Uploaded patch set 9.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 12:26:15 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/305/</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 12:28:27 AM<br><strong>Message</strong>: <pre>Patch Set 9:

> Uploaded patch set 9.

Gong, the converted test suite can run with only one failure. I couldn't find how to set the SoftHSM2 library properly to allow AES key import test to run to completion. Can you add some comments to the comment section on the top of the file, on how to configure the library?</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 12:29:57 AM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/305/ : FAILURE</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 5:25:04 AM<br><strong>Message</strong>: <pre>Patch Set 9:

(1 comment)</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 9:23:55 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Gong, this is how I do it: first download the latest content by going to the gerrit web UI and click "Download" dropdown in the top right corner, then click the button next to the "Cherry pick" link. This will copy a git command that downloads the latest. Just paste it in your command line. Then "git checkout -b 3885" to create a new branch for further changes. After you make your change in that new branch, commit it and then checkout master. I would first make sure the master branch is in sync with the remote (git reset --hard origin/master, of course make sure to properly dispose of your local changes on master if any) I then use "git merge --squash 3885" to merge the updates into master and then you can upload the whole thing with the normal "git push origin HEAD:refs/for/master" command. As long as you leave the Change-Id value the same, it'll be appended to 3885 as a patch.</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 9:07:42 PM<br><strong>Message</strong>: <pre>Uploaded patch set 10.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 9:08:41 PM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/312/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 9:12:26 PM<br><strong>Message</strong>: <pre>Patch Set 10: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/312/ : FAILURE</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 9:12:56 PM<br><strong>Message</strong>: <pre>Patch Set 10:

> Gong, this is how I do it: first download the latest content by
 > going to the gerrit web UI and click "Download" dropdown in the top
 > right corner, then click the button next to the "Cherry pick" link.
 > This will copy a git command that downloads the latest. Just paste
 > it in your command line. Then "git checkout -b 3885" to create a
 > new branch for further changes. After you make your change in that
 > new branch, commit it and then checkout master. I would first make
 > sure the master branch is in sync with the remote (git reset --hard
 > origin/master, of course make sure to properly dispose of your
 > local changes on master if any) I then use "git merge --squash
 > 3885" to merge the updates into master and then you can upload the
 > whole thing with the normal "git push origin HEAD:refs/for/master"
 > command. As long as you leave the Change-Id value the same, it'll
 > be appended to 3885 as a patch.

Hi Jim, thanks for the instructions but all these git fiddling makes me nervous. :-) I ran the cherry pick command you said from the download menu (had to do the git reset --hard origin/master first, otherwise getting an error). After that I "git checkout -b 3885" and made the change (comment out line 606) and "git commit --amend" (to keep the changeID the same). Then I just did "git review" and it seems to work.</pre><strong>Reviewer</strong>: Gong Su - gong_su@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 9:16:51 PM<br><strong>Message</strong>: <pre>Uploaded patch set 11.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 9:17:49 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/313/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 9:22:00 PM<br><strong>Message</strong>: <pre>Patch Set 11: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-verify-x86_64/313/ : SUCCESS</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 11:14:14 PM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review+2 Verified+1</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 11:14:56 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jim Zhang</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 11:15:50 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-node-merge-x86_64/89/</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 1/23/2017, 11:17:28 PM<br><strong>Message</strong>: <pre>Patch Set 11:

After Ramesh obtains a Jenkins vm that has SoftHSM2 installed and slots configured, it can enhance the CI Job to launch the separate test pkcs11-tests.js.

at some point, we should have a single test suite for all CryptoSuite implementations that drives the APIs and switch among the impls via configuration settings. but this is good initial step</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 11:19:43 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-node-merge-x86_64/89/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/11/2017, 10:28:55 PM<br><strong>UnmergedRevision</strong>: [6d5d410e5a7fdcd8e76289383b8ceec8f9c382cd](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/6d5d410e5a7fdcd8e76289383b8ceec8f9c382cd)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/11/2017, 10:33:12 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/13/2017, 11:55:00 AM<br><strong>UnmergedRevision</strong>: [ca2a1eb6da014ddfbcfbbbcec20e2584f0ed17a5](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/ca2a1eb6da014ddfbcfbbbcec20e2584f0ed17a5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/13/2017, 11:58:54 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/13/2017, 12:06:41 PM<br><strong>UnmergedRevision</strong>: [78d1f801c50d5a385ede47e5278f71c5c851fd1a](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/78d1f801c50d5a385ede47e5278f71c5c851fd1a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/13/2017, 12:11:14 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/13/2017, 12:13:46 PM<br><strong>UnmergedRevision</strong>: [ac0e00d0c262ea11e14e07d297d762c3f1f0fd05](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/13/2017, 12:19:06 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Approved</strong>: 1/16/2017, 4:29:11 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L9](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05//COMMIT_MSG#L9)<br><strong>Comment</strong>: <pre>Link to https://jira.hyperledger.org/browse/FAB-283</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L269](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L269)<br><strong>Comment</strong>: <pre>_pkcs11GenerateECKeyPair I think, or add rsa template as well. bccsp also is supposed to create rsa keys.. not sure if anyone is using it, but code is there on golang side.</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L269](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L269)<br><strong>Comment</strong>: <pre>Not sure what you mean.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L269](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L269)<br><strong>Comment</strong>: <pre>The function signature implies support for ECC+RSA</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L269](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L269)<br><strong>Comment</strong>: <pre>OK I think RSA parameters are sufficiently different to warrant its own function instead of overloading _pkcs11GenerateKeyPair. I'll change it to _pkcs11GenerateECKeyPair as you suggested.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L269](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L269)<br><strong>Comment</strong>: <pre>Thanks</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>not hardcoded to true?</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>CKA_PRIVATE does NOT mean the key is a private key. It means whether the key is publicly accessible or not. If you don't login with a PIN, you cannot create CKA_PRIVATE=true object.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>On the golang side, I always assume you are logged in. PIN is a vestigial feature here, doesnt offer extra protection, just make it part of initialization.

Login is already sufficiently complicated, I would recommend same assumption here (well and making sure the code actually obeys that)

Not sure how many 'multithreading' issues you've run into (and maybe we talked about this already) that you are supposed to just log into the first sessions and the rest appear to be all loged in too? Thats what oasis spec says and thats why I use golang channels to share-out/reuse sessions across threads.

Or is all that a moot point because nodejs is single-threaded... lucky you!?</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>No you don't have to login with a PIN. As soon as you connect to the card, you have a session. You can do everything except: 1. your objects are always ephemeral (i.e., your CKA_TOKEN=true is ignored), and 2. your objects are always in publicly accessible storage (i.e., your CKA_PRIVATE=true is ignored). It's pretty simple and this is the behavior spelled out in the PKCS11 spec so I think that's what needs to be done.

I think I read somewhere that node.js process is single threaded by design so I guess lucky me.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>But ignoring the CKA_TOKEN=true.. thats bad for persistent keys though. In 0.6 we made all keys persistent by default, thats why I was originally confused. Took me your reminder to remember.. The 1.0 bccsp passes an 'Ephemeral' flag. From sw js version there is also an equivalent: https://github.com/hyperledger/fabric-sdk-node/blob/master/hfc/lib/impl/CryptoSuite_ECDSA_AES.js#L126</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>Well, CKA_TOKEN=true only gets ignored if you don't login with a PIN. So if you want to generate non-ephmeral keys, you always have to login with a PIN. That's the behavior the spec says.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>Yep capish. What I don't see a way to prevent is if an app requests a non-ephemeral key (i.e. ecert), calls this function, and we generate an ephpemeral key anyway, because we havent logged in yet. then on restart, we can no longer reload the app with the same ecert.</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L275](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L275)<br><strong>Comment</strong>: <pre>That's pretty simple to deal with. Just check if the session is a logged in session and throw an error if it's not and the user asks for non-ephermal key. In fact, if you are not logged in and try to set CKA_PRIVATE=true, PKCS11 call will fail (I think I've tested this but can't remember exactly). But unfortunately with CKA_TOKEN=true, it just gets silently ignored if you are not logged in. But like I said, it's simple enough to check.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>Why is this commented out? Typo? Without setting CKA_ID, _pkcs11SkiToHandle will not find anything  across sessions/executions</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>Because CKA_ID is already set with randomly generated bits above at the time the key is created.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>I see.. clever. Well..

I was tempted to do exactly that in 0.6. Just spent an hour of Tamas's time discussing this.

There is a reason for this. SKI = SubjectKeyIdentifier which is spec'ed out ("See SignerInfo in CMS, RFC 3852, Section 5.3. We only use SignerInfo's identified by signer SKI (version 3). The ECDSA format of SignerInfo signature fields is in RFC 5753, Section 7.2.") 

Keith also pointed me at RFC 7093 and the fact that CFSSL uses SKI/AKI

While we don't plug BCCSP + CFSSL (yet?), it is a good idea to do the same thing: SHA1(PubKey)

Have a look at https://github.com/hyperledger/fabric-cop/blob/master/vendor/github.com/cloudflare/cfssl/signer/signer.go#L213
// ComputeSKI derives an SKI from the certificate's public key in a
// standard manner. This is done by computing the SHA-1 digest of the
// SubjectPublicKeyInfo component of the certificate.
func ComputeSKI(template *x509.Certificate) ([]byte, error) {
	pub := template.PublicKey
	encodedPub, err := x509.MarshalPKIXPublicKey(pub)
	if err != nil {
		return nil, err
	}

	var subPKI subjectPublicKeyInfo
	_, err = asn1.Unmarshal(encodedPub, &subPKI)
	if err != nil {
		return nil, err
	}

	pubHash := sha1.Sum(subPKI.SubjectPublicKey.Bytes)
	return pubHash[:], nil
}</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>I was doing SKI=sha256(ecpt) before but figured why make another trip to the card just for setting some random bits. Fine, I can revert back to the old behavior.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>Please do SHA1 instead. 'fixing' to SHA1 on the golang side too. Thats what CFSSL appears to be doing.. If we are gonna try and match the behaviour..

Yeah, I was thinking exactly the same thing, why go out to the card again, thats just bad for performance.. in pkcs11 defence, I think that that call doesnt actually go the the card, just a pkcs11 library call. There are plenty of calls like that. Though there possibly might be a disk store call I imagine to update the keystore..</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>New code I just pushed uses SHA1.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L337](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L337)<br><strong>Comment</strong>: <pre>Thanks</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L533](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L533)<br><strong>Comment</strong>: <pre>I know we talked about this one and you are waiting for me&Tamas to get you opencryptoki.. meanwhile.. this function appears not to be critical for functionality I think.. well, the software equivalent is empty (https://github.com/hyperledger/fabric-sdk-node/blob/master/hfc/lib/impl/CryptoSuite_ECDSA_AES.js#L154) so this is a good question for Jim.

JIM: How is TCert and HMAC derivation done in SDK? do you need it?

On other hand, the long-term goal is to mimic the golang version, https://github.com/hyperledger/fabric/blob/master/bccsp/sw/impl.go#L221

Notice the ability to derive ECC keys as well as AES keys. Even without opencryptoki extensions, I suspect your CreateObject trick will make short work out of the keyderivation (though you might have to do a few operations in software perhaps..)</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L880](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/ac0e00d0c262ea11e14e07d297d762c3f1f0fd05/hfc/lib/impl/bccsp_pkcs11.js#L880)<br><strong>Comment</strong>: <pre>This looks suspicious to me, but if you tested this then I will take your word. Should check with Tamas really... He suggested this morning when I talked to him after the scrum that key-import can be implemented with CKA_UNWRAP. Which means you would have to first wrap the key and THEN send it to the card.. This is really a backdoor and a card policy can disable this.

Convincing test case would take a key-import with sw csp and hardware csp, encrypt the same payload and byte-compare the encrypted results.</pre></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/16/2017, 11:02:02 PM<br><strong>UnmergedRevision</strong>: [3c5b123e7272c3826e022b2b81d478ddcc7968c3](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/3c5b123e7272c3826e022b2b81d478ddcc7968c3)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/16/2017, 11:06:51 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>After testing my code with SoftHSMv2, I think hardcoding to the last slot is problematic. SoftHSMv2 uses the first slot. So I plan to change my code to scan for a slot that has both CKF_USER_PIN_INITIALIZED bit and CKF_TOKEN_INITIALIZED set and use that slot.
I don't know enough about the HSM slot stuff whether this is reasonable or whether the slot should also be part of the constructor parameter (overriding the scanning). But I think at least scanning is better for hardcoding a slot.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>Actually.. now that I learned (a bit) more about the crypto card.. lets make the slot a config parameter too. What if there are multiple cards?</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>If slot is not specified, scan the list of the slots, the first one that has both CKF_USER_PIN_INITIALIZED (0x00000008) bit and CKF_TOKEN_INITIALIZED (0x00000400) bit set (an eligible slot) will be used. That's what I'm going to do.

If you want to make it fancy, use the first eligible slot if the user didn't specify a PIN. Otherwise, try to login with the PIN until you succeed. Of course, the user could have given a wrong PIN so you revert back to the first eligible slot after failing all eligible slots.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>I say just keep it simple. This IS security code. Slot should always be specified. PIN should always be correct. Should always log in. If any condition not met "fail fast" and crash. I don't think anyone really expects such slot scaning, in fact, that would make me nervous that I am taking over somebody elses card if its somehow collocated on the same machine, creating a backdoor</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>I'm fine with mandating a slot. But I'm not sure with mandating a PIN. If I simply want to take advantage of the crypto card to do some "ephemeral" stuff, why do I have to login with a PIN? Since having the PIN in your code/memory, etc. would expose you to risks of leaking the PIN.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>Please mandate a PIN too. PIN is not a security feature for crypto cards, its a vestigial feature in PKCS11 intended for smart card readers. Nothing is leaked here. (Had this discussion with Tamas, if that makes you feel any better)
Also, bccsp is supposed to do both ephemeral and non-ephemeral keys, you dont know which ones you will be getting requests for. Mostly I expect persistent keys to be used. There will ALWAYS be at least one persistent key (the signing key or the ECert) and the rest could be derived/ephemeral..</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>No, it doesn't make me feel any better. :-) I'm not a security person but I happen to think the "vestigial feature in PKCS11" makes a lot of sense. If I just want to, say, verify a lot of signatures with pub keys (where everything is ephemeral and nothing is secret), why must I login with a PIN? And what do you mean nothing is leaked? I put my PIN in the code, code gets passed onto someone else and oops I forget to take out the PIN. And PIN stays in memory, someone can be scanning the memory (you don't need me to tell you those kind of attacks).

As for the ephemeral issue, as I argued before, it's a simple case of throwing error if someone specifies ephemeral=false without specifying PIN (or wrong PIN).

So no, I'm not convinced why we should mandate a PIN. But if you guys insist on it, I can do that but I need to speak my words. :-)</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>You are absolutely correct from pure a pkcs11 standpoint, about the ephemeral=false usecase. About the pin.. if you have access to scan the memory, you are also scanning the plaintext in memory, which is what you are after...
Whats more important is that the usecase of only-ephemeral does not apply to fabric. ALL sessions will need to load at least one key from keystore or store one there. Thats what I am trying to explain.</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L147](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L147)<br><strong>Comment</strong>: <pre>Well, losing your PIN is a lot more damaging than losing plaintext since I can get all your keys with your PIN. In any case, I wasn't paying too much attention to the "ALWAYS be at least one persistent key" part since I wasn't sure that's the case. But if you are sure it covers all use cases then I'll take your words for it and that certainly can't function without a correct PIN.</pre><strong>Commenter</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L443](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L443)<br><strong>Comment</strong>: <pre>ecdsa signature malleability resistance - needs special handling on the S value of the raw signature, see https://gerrit.hyperledger.org/r/#/c/2983/ (golang) and https://gerrit.hyperledger.org/r/#/c/4079/ (node.js software-based ecdsa bccsp)</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L443](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L443)<br><strong>Comment</strong>: <pre>Vlad, I suppose this has to be done in software, the crypto card doesn't support this, correct?</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L443](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L443)<br><strong>Comment</strong>: <pre>Yes, though Tamas and Angelo did talk about this. Ask Tamas for code for this. Or how to do it..</pre><strong>Commenter</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L641](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L641)<br><strong>Comment</strong>: <pre>only applicable to software-based impl. should be removed</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L641](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L641)<br><strong>Comment</strong>: <pre>Do you mean the use of keystore? or the opts.ephemeral? Actually, the opts.ephemeral flag maps pretty well to pkcs11 as well.. it means 'key is alive/available during program execution' and when the executable is restarted, ephemeral keys will need to be regenerated (not sure if we actually use this feature really, but its there, potentially for TCerts).

This maps to a pkcs11 session. session dies at the end of the execution and ephemeral keys are lost.

PKCS11/opencryptoki does use a keystore behind the scenes, encrypted with master key. 

I think that comment is still applicable.</pre><strong>Commenter</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L641](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L641)<br><strong>Comment</strong>: <pre>Vlad, that makes sense. thanks for the detailed explanation. so "KeyValueStore" specifically refers to the interface, which is not needed here. I think it'll be clearer if we say "Per PKCS11 spec if opts.ephemeral is false, the generated key will be saved across PKCS11 sessions by the HSM hardware".</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L841](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L841)<br><strong>Comment</strong>: <pre>Can we cleanup around here? Either leave this empty and implement in a separate set, or try for what we already know how Tamas will implement this..or best yet, do it in software (just copy the code from the SW implementation) and finish off with a keyimport, that way it also works with softhsm in builds.

Have a look at the golang sw version of this function, there are three types of key types as input.</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L841](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L841)<br><strong>Comment</strong>: <pre>I'm not going to do software implementation here since it's PKCS11. :-) I'll cleanup.</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L841](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L841)<br><strong>Comment</strong>: <pre>Matter of perspective really.. I was thinking of this provider as 'somewhat' PKCS11! :D As in, get Signing done by the card, everything after is 'gravy'.. In fact I expected you to run into a lot more problems so that we would have to leave a lot more functions in software (like I did in 0.6). 
One could still argue that our handling of AES key import is borderline-legal and it should be left as software-keys till fabric is redesigned to use key-agreement (or some such) to create such keys...</pre><strong>Commenter</strong>: Volodymyr Paprotski - vpaprots@ca.ibm.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L881](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L881)<br><strong>Comment</strong>: <pre>You had mentioned that this was not working on softhsm? Pls let Ramesh know what needs changing if/when you do. Tamas thought it had something to do with policy? Havent seen a 'policy' for softhsm, but then havent looked at the config beyond changing where softhsm stores keys.</pre><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L881](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/3c5b123e7272c3826e022b2b81d478ddcc7968c3/hfc/lib/impl/bccsp_pkcs11.js#L881)<br><strong>Comment</strong>: <pre>I don't have much time to play with SoftHSMv2. But yeah it must be some sort of policy setting.</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/19/2017, 8:59:52 AM<br><strong>UnmergedRevision</strong>: [26fbf0f49ca3c5b8649df56f03d52d66229c8e40](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/26fbf0f49ca3c5b8649df56f03d52d66229c8e40)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/19/2017, 9:04:34 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/19/2017, 9:51:19 PM<br><strong>UnmergedRevision</strong>: [04869b012f401d81d140ecc56941b8bb4a6e5e3d](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/04869b012f401d81d140ecc56941b8bb4a6e5e3d)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/19/2017, 9:55:47 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Gong Su - gong_su@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/19/2017, 11:29:29 PM<br><strong>UnmergedRevision</strong>: [e92f6d3690d9eae1e4a1934ec9e5e06a67178a0d](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/e92f6d3690d9eae1e4a1934ec9e5e06a67178a0d)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/19/2017, 11:34:13 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Uploader</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Created</strong>: 1/23/2017, 12:25:16 AM<br><strong>UnmergedRevision</strong>: [f50302c65b731e4567051b48ed477ccfa2726168](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/f50302c65b731e4567051b48ed477ccfa2726168)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 12:29:57 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Gong Su - gong_su@hotmail.com<br><strong>CommentLine</strong>: [hfc/lib/impl/bccsp_pkcs11.js#L606](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/blob/f50302c65b731e4567051b48ed477ccfa2726168/hfc/lib/impl/bccsp_pkcs11.js#L606)<br><strong>Comment</strong>: <pre>Hi Jim, after playing a bit with SoftHSMv2, it turns out that SoftHSMv2 prohibits specifying CKA_VALUE_LEN (while crypto card doesn't seem to care). So if you just remove this line importing AES key will also work with SoftHSMv2. I'm not very familiar with gerrit. How do I get your latest patch set to make further changes? Do I just "git pull"? Thanks.</pre></blockquote><h3>PatchSet Number: 10</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/23/2017, 9:07:42 PM<br><strong>UnmergedRevision</strong>: [cbbbfca6e2125d6ba976ef003ae1bf4e4a07d3aa](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/cbbbfca6e2125d6ba976ef003ae1bf4e4a07d3aa)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 9:12:26 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 11</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Uploader</strong>: Gong Su - gong_su@hotmail.com<br><strong>Created</strong>: 1/23/2017, 9:16:51 PM<br><strong>GitHubMergedRevision</strong>: [2c1b874ea97280dd493b4535316da7bbaaa91295](https://github.com/hyperledger-gerrit-archive/fabric-sdk-node/commit/2c1b874ea97280dd493b4535316da7bbaaa91295)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 9:22:00 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Approved</strong>: 1/23/2017, 11:14:14 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jim Zhang<br><strong>Merged</strong>: 1/23/2017, 11:14:56 PM<br><br><strong>Approver</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Approved</strong>: 1/23/2017, 11:14:14 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote>