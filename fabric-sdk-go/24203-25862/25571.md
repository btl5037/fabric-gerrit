<strong>Project</strong>: fabric-sdk-go<br><strong>Branch</strong>: master<br><strong>ID</strong>: 25571<br><strong>Subject</strong>: [FABG-721] HSM Resilience in internal/fabric/bccsp<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/15/2018, 12:01:05 PM<br><strong>LastUpdated</strong>: 8/17/2018, 5:09:02 PM<br><strong>CommitMessage</strong>:<br><pre>[FABG-721] HSM Resilience in internal/fabric/bccsp

Clear all session, recreate session and relogin for following errors

CKR_OBJECT_HANDLE_INVALID, CKR_USER_NOT_LOGGED_IN(if login fails after x amount of times then panic)
CKR_TOKEN_NOT_PRESENT, CKR_DEVICE_ERROR, CKR_GENERAL_ERROR, CKR_SESSION_HANDLE_INVALID or CKR_SESSION_CLOSED

Panic for following errors

CKR_DEVICE_MEMORY, CKR_DEVICE_REMOVED


Change-Id: I773eeb596f55ffd0b03f8a0f3378218ba9b77d8f
Signed-off-by: Sudesh Shetty <sudesh.shetty@securekey.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 12:01:05 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 12:01:11 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3601/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 12:04:46 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3586/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 12:11:46 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3586/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-x86_64/3586

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3601/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-s390x/3601</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/15/2018, 12:47:25 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/15/2018, 12:49:48 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 12:50:46 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 12:55:12 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/15/2018, 1:00:22 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/15/2018, 1:01:30 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 3:33:49 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 3:33:49 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 3:33:59 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3603/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 3:37:09 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3588/ (2/2)</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/15/2018, 3:45:49 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/15/2018, 3:45:51 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3588/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-x86_64/3588

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3603/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-s390x/3603</pre><strong>Reviewer</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Reviewed</strong>: 8/16/2018, 5:14:38 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/16/2018, 5:14:47 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3610/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/16/2018, 5:18:02 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3595/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/16/2018, 5:26:13 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-x86_64/3595/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-x86_64/3595

https://jenkins.hyperledger.org/job/fabric-sdk-go-tests-verify-s390x/3610/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-sdk-go-tests-verify-s390x/3610</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 4:58:33 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 5:00:15 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 5:01:20 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 5:08:33 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 5:08:58 PM<br><strong>Message</strong>: <pre>Patch Set 3:

next patch needs to move this code into its own package and include tests.</pre><strong>Reviewer</strong>: Troy Ronda - troy@troyronda.com<br><strong>Reviewed</strong>: 8/17/2018, 5:09:02 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Troy Ronda</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Uploader</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Created</strong>: 8/15/2018, 12:01:05 PM<br><strong>UnmergedRevision</strong>: [b78f166e806c57a99fa002252be31e08ed796699](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/commit/b78f166e806c57a99fa002252be31e08ed796699)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/15/2018, 12:11:46 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L7](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699//COMMIT_MSG#L7)<br><strong>Comment</strong>: <pre>don't we need a patch file?</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L7](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699//COMMIT_MSG#L7)<br><strong>Comment</strong>: <pre>also should upstream fabric also get a CR with this change? (patch is okay in the mean time, but would make sense to improve the fabric bccsp).</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L7](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699//COMMIT_MSG#L7)<br><strong>Comment</strong>: <pre>Yes, was planning to push it after code review. I didn't want to update patch file again and again for each review comments. Just to save time. Once this gets merged, I will push patch file in next commit.</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L7](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699//COMMIT_MSG#L7)<br><strong>Comment</strong>: <pre>Will create a sub task in this story and will work on it.
We still need to finalise list of error codes since Biljana said we may need to put this logic for more error codes.
I created a task to discuss and finalise error codes to be handled.</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L136](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L136)<br><strong>Comment</strong>: <pre>Suggest logging the error condition & error code. Seems like info or warning to me.</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L214](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L214)<br><strong>Comment</strong>: <pre>Lower case s</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L214](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L214)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L220](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L220)<br><strong>Comment</strong>: <pre>hmmm... panic...</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L220](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L220)<br><strong>Comment</strong>: <pre>That's what ops team asked for these errors, As I can see load lib function from 'fabric/bccsp/pkcs11' also panic in some error situations.</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232)<br><strong>Comment</strong>: <pre>Are these sessions still valid after you do the reload mechanism above?</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232)<br><strong>Comment</strong>: <pre>You are right, we may need to flush 'csp.sessions' when we reload everything.

But not sure what to do for old sessions being returned after reload. Any suggestions?</pre><strong>Commenter</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/b78f166e806c57a99fa002252be31e08ed796699/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L232)<br><strong>Comment</strong>: <pre>as per this behaviour, old session being added back to pool. If in case they are stale or invalid, reload lib will happen again.</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Uploader</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Created</strong>: 8/15/2018, 3:33:49 PM<br><strong>UnmergedRevision</strong>: [5d5a52e8b01d259bb0302244f7028a2afd708ce7](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/commit/5d5a52e8b01d259bb0302244f7028a2afd708ce7)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/15/2018, 3:45:51 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Uploader</strong>: Sudesh Shetty - sudesh.shetty@securekey.com<br><strong>Created</strong>: 8/16/2018, 5:14:38 PM<br><strong>GitHubMergedRevision</strong>: [2b73bc23e447b781014693b1d03e46e35cfecc1a](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/commit/2b73bc23e447b781014693b1d03e46e35cfecc1a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/16/2018, 5:26:13 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Troy Ronda - troy@troyronda.com<br><strong>Approved</strong>: 8/17/2018, 5:08:33 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Troy Ronda<br><strong>Merged</strong>: 8/17/2018, 5:09:02 PM<br><br><h2>Comments</h2><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L92](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/2b73bc23e447b781014693b1d03e46e35cfecc1a/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L92)<br><strong>Comment</strong>: <pre>adding new locks doesn't seem in-line with this package, where they used a channel to put/get sessions.</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L122](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/2b73bc23e447b781014693b1d03e46e35cfecc1a/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L122)<br><strong>Comment</strong>: <pre>these changes are getting too big for patches - seems like we need a package in the SDK for all this logic.</pre><strong>Commenter</strong>: Troy Ronda - troy@troyronda.com<br><strong>CommentLine</strong>: [internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L122](https://github.com/hyperledger-gerrit-archive/fabric-sdk-go/blob/2b73bc23e447b781014693b1d03e46e35cfecc1a/internal/github.com/hyperledger/fabric/bccsp/pkcs11/pkcs11.go#L122)<br><strong>Comment</strong>: <pre>I'm also concerned that due to this, we don't have tests around this logic.</pre></blockquote>