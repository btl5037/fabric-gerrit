<strong>Project</strong>: fabric-test<br><strong>Branch</strong>: master<br><strong>ID</strong>: 17017<br><strong>Subject</strong>: [FAB-6446] improve verification of upgrade steps<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Assignee</strong>: Naga Venkata Sai Surya Teja Lanka - suryalnvs@gmail.com<br><strong>Created</strong>: 1/19/2018, 8:56:20 PM<br><strong>LastUpdated</strong>: 1/23/2018, 10:14:38 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-6446] improve verification of upgrade steps

+ This does not fix all of fab-6446, which is huge,
but rather adds depth in the form of many invokes
and queries with each step of the way through the
upgrade.feature file.
+ Standardizes the formatting of comments and the
symbol naming conventions throughout the file.
+ Got 4 scenarios working.
+ cd .../fabric-test/feature-upgrade and follow
instructions in README.md to execute within
behave_venv:
 $ behave -k features/upgrade.feature
 ...
 1 feature passed, 0 failed, 0 skipped
 1 scenario passed, 0 failed, 0 skipped
 264 steps passed, 0 failed, 0 skipped, 0 undefined
 Took 9m44.002s

Change-Id: I006f71eb8e016231207c1ea25ee5a8b6eb07f510
Signed-off-by: Scott Zwierzynski <scottz@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/19/2018, 8:56:20 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/19/2018, 8:56:42 PM<br><strong>Message</strong>: <pre>Assignee added: Naga Surya Lanka <suryalnvs@gmail.com></pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2018, 8:58:27 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/698/</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/19/2018, 9:03:59 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2018, 9:07:06 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/699/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2018, 9:37:08 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/698/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-test-verify-x86_64/698</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/19/2018, 10:11:48 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/699/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-test-verify-x86_64/699</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/21/2018, 4:48:39 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/21/2018, 4:52:06 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/701/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/21/2018, 5:53:40 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/701/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-test-verify-x86_64/701</pre><strong>Reviewer</strong>: Naga Venkata Sai Surya Teja Lanka - suryalnvs@gmail.com<br><strong>Reviewed</strong>: 1/22/2018, 2:06:22 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1</pre><strong>Reviewer</strong>: Naga Venkata Sai Surya Teja Lanka - suryalnvs@gmail.com<br><strong>Reviewed</strong>: 1/22/2018, 2:13:44 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 1/22/2018, 8:18:40 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(5 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2018, 12:06:19 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(6 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2018, 12:09:58 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2018, 12:13:15 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/705/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2018, 1:21:06 AM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/705/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-test-verify-x86_64/705</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 1/23/2018, 8:39:41 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 1/23/2018, 8:40:26 AM<br><strong>Message</strong>: <pre>Patch Set 4:

There's a good amount of clean up that's needed, but I'll merge to move forward.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 1/23/2018, 8:40:29 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Latitia Haskins</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2018, 10:14:38 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Unstable 

https://jenkins.hyperledger.org/job/fabric-test-merge-x86_64/145/ : UNSTABLE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-test-merge-x86_64/145/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-test-merge-x86_64/145</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Uploader</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Created</strong>: 1/19/2018, 8:56:20 PM<br><strong>UnmergedRevision</strong>: [ea9ab13ed5872cd30664dd99f3824687f6a95296](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/ea9ab13ed5872cd30664dd99f3824687f6a95296)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/19/2018, 9:37:08 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Uploader</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Created</strong>: 1/19/2018, 9:03:59 PM<br><strong>UnmergedRevision</strong>: [33ce85cdfdf8320ab2b71a3a7a57f3f8ebf54909](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/33ce85cdfdf8320ab2b71a3a7a57f3f8ebf54909)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/19/2018, 10:11:48 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Uploader</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Created</strong>: 1/21/2018, 4:48:39 PM<br><strong>UnmergedRevision</strong>: [e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/21/2018, 5:53:40 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Naga Venkata Sai Surya Teja Lanka - suryalnvs@gmail.com<br><strong>Approved</strong>: 1/22/2018, 2:06:22 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L21](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L21)<br><strong>Comment</strong>: <pre>comment this out so it decomposes the network between runs</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L21](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L21)<br><strong>Comment</strong>: <pre>Agree, but I'd like to work on this separately, because currently there is an OSError in the python library during the decompose which I do not fully understand. In the bootstrap callback decomposing(), it seems to be trying remove a file but has inadequate permissions - however when I look afterwards, the orderer1 directory tree is not even there. It seems an issue like this might have been fixed in python 3.5 (https://bugs.python.org/issue22040, which points to issue19643)... but we are using python 2.7.

  File "/opt/gopath/src/github.com/hyperledger/fabric-test/feature-upgrade/steps/bootstrap_util.py", line 1098, in decomposing
  shutil.rmtree(self.getVolumePath(composition.projectName))
  File "/usr/lib/python2.7/shutil.py", line 247, in rmtree
    rmtree(fullname, ignore_errors, onerror)
  File "/usr/lib/python2.7/shutil.py", line 247, in rmtree
    rmtree(fullname, ignore_errors, onerror)
  File "/usr/lib/python2.7/shutil.py", line 247, in rmtree
    rmtree(fullname, ignore_errors, onerror)
  File "/usr/lib/python2.7/shutil.py", line 252, in rmtree
    onerror(os.remove, fullname, sys.exc_info())
  File "/usr/lib/python2.7/shutil.py", line 250, in rmtree
    os.remove(fullname)
OSError: [Errno 13] Permission denied: '/var/hyperledger/bddtests/volumes/orderer/1e8d3c86fff311e7a58102c9fd7cbfce/orderer1/filestore/index/CURRENT'</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L488](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L488)<br><strong>Comment</strong>: <pre>Do we have a bug open for adding in the ability for the network to be sure that all orderers are at the same version before turning on version specific capabilities? I would think that this should be possible since the orderers should know about each other already. The question is how can they be aware of what version they are running...</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L488](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L488)<br><strong>Comment</strong>: <pre>No. I thought the same thing, and discussed with jyellick, who says the orderers (for kafka service) actually do not talk to each other - but just to the kafkas. After 1.1, further upgrades will cause non-upgraded orderers to panic, much like the peers do today, to avoid fork. But the 1.0 orderers are not smart enough to do that without the capabilities framework in place (which is part of v1.1 itself). We can add a test step for this in future releases.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L600](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L600)<br><strong>Comment</strong>: <pre>??? Does this line always assume that you have multiple orderers? From how it reads I would assume that this line would be uncommented if you have more than 1 orderer.</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L600](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L600)<br><strong>Comment</strong>: <pre>I edited the line. This step will get hit when taking down <orderer1>. The only question is whether or not it equals <orderer0>.</pre><strong>Commenter</strong>: Naga Venkata Sai Surya Teja Lanka - suryalnvs@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L608](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L608)<br><strong>Comment</strong>: <pre>delete</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L608](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L608)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L821](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L821)<br><strong>Comment</strong>: <pre>When you say remove do you mean "stop" the chaincode containers?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L821](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L821)<br><strong>Comment</strong>: <pre>Yes; it means: docker rm and docker rmi.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L821](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L821)<br><strong>Comment</strong>: <pre>The wording for this is weird, but we can rework later with the rest of this.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L982](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L982)<br><strong>Comment</strong>: <pre>What do you mean by fixup?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature-upgrade/features/upgrade.feature#L982](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/e5bdf9ce06a48e8a37acfb1bfbc5c6afcb5ae6e0/feature-upgrade/features/upgrade.feature#L982)<br><strong>Comment</strong>: <pre>reworded</pre></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Uploader</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Created</strong>: 1/23/2018, 12:09:58 AM<br><strong>GitHubMergedRevision</strong>: [219782b1d9b67437b984f7d53eec334643b5812d](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/219782b1d9b67437b984f7d53eec334643b5812d)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2018, 1:21:06 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Approved</strong>: 1/23/2018, 8:39:41 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Latitia Haskins<br><strong>Merged</strong>: 1/23/2018, 8:40:29 AM<br><br></blockquote>