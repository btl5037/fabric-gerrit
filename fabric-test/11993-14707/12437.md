<strong>Project</strong>: fabric-test<br><strong>Branch</strong>: master<br><strong>ID</strong>: 12437<br><strong>Subject</strong>: [FAB-4770] Taking down kafka topic leaders<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/14/2017, 2:03:49 PM<br><strong>LastUpdated</strong>: 8/31/2017, 8:29:31 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-4770] Taking down kafka topic leaders

This adds functionality and test for bouncing
kafka brokers within a kafka based orderer
service.

Change-Id: I3e15008dcd31817a5c671dc04dfbaf85cde15561
Signed-off-by: Latitia M Haskins <latitia.haskins@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 2:03:49 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 2:05:25 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 3:19:52 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 3:20:05 PM<br><strong>Message</strong>: <pre>Removed Verified+1 by Latitia Haskins <latitia.haskins@gmail.com>
</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 5:03:49 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 6:06:05 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3: Patch Set 2 was rebased.</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/14/2017, 6:09:47 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(3 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/14/2017, 6:32:47 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(6 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/14/2017, 6:57:22 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review-1</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/16/2017, 2:01:54 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(9 comments)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/16/2017, 3:15:01 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/16/2017, 6:48:05 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+1</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/16/2017, 9:26:53 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified-1

Two tests failed: 
1.  FAB-4770 (after stop 2nd partition leader, I see this confusing error message, which is very bad on all accounts):
     When a user invokes on the chaincode named "mycc" with args ["invoke","a","b","10"]                                                                                       # steps/endorser_impl.py:107 1.247s
    Then a user receives an error response of SERVICE_UNAVAILABLE                                                                                                             # steps/endorser_impl.py:186 0.000s
      Assertion Failed: There was not an error response: 
 ...
      Error: proposal failed (err: rpc error: code = Unknown desc = chaincode error (status: 500, message: Cannot create ledger from genesis block, due to LedgerID already exists))


2.  smoke.feature:38  Test access to the fabric protobuf files
      Traceback (most recent call last):
        File "/usr/local/lib/python2.7/dist-packages/behave/model.py", line 1456, in run
          match.run(runner.context)
        File "/usr/local/lib/python2.7/dist-packages/behave/model.py", line 1903, in run
          self.func(context, *args, **kwargs)
      TypeError: step_impl() takes exactly 2 arguments (1 given)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/17/2017, 4:51:14 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/17/2017, 6:41:00 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/17/2017, 7:02:42 PM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review-1

(4 comments)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/18/2017, 10:44:38 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(4 comments)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/18/2017, 10:58:28 AM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/18/2017, 5:50:21 PM<br><strong>Message</strong>: <pre>Patch Set 7: Verified-1 Code-Review+1

(1 comment)

Looks better, but sometimes still fails for me on the invoke after the 2nd KB is stopped. Per our discussion, it looks like we need to verify more things and the deployment step because a peer had not successfully joined. Not sure why this became a problem at this particular invoke step.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/21/2017, 11:25:35 AM<br><strong>Message</strong>: <pre>Patch Set 7:

I think adding more verifications after a deploy is out of the scope of this CR. I think that is a separate issue from this kafka test and has the potential to grow even more. I'd like to keep the scope of this change as small as we can.

That said, I am curious as to why this seems to fail for you at times. I am hoping that @kostas can chime in as to the test validity.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 8/21/2017, 7:09:31 PM<br><strong>Message</strong>: <pre>Patch Set 7:

> Patch Set 7:
> 
> I think adding more verifications after a deploy is out of the scope of this CR. I think that is a separate issue from this kafka test and has the potential to grow even more. I'd like to keep the scope of this change as small as we can.
> 
> That said, I am curious as to why this seems to fail for you at times. I am hoping that @kostas can chime in as to the test validity.

(Hi everyone, not ignoring this, just out on vacation till next Wednesday. Will chime in when I get back.)</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/22/2017, 12:05:27 PM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/22/2017, 6:40:27 PM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+2

OK. Passed "behave -t daily" tests except one: FAB-4686 failed on the last step. Assertion Failed: Expected response was 970; received Query Result: 980</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/22/2017, 7:12:07 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified-1 Code-Review+1

Sorry; I mistakenly posted previous comment. Only FAB-4686 test failed, and it failed again when run individually. The steps look ok, but running the test produced a strange error (much like other tests have done):
 Error: Error sending transaction invoke: Got unexpected status: SERVICE_UNAVAILABLE -- Could not enqueue - version:1 response:<status:200 message:"OK" > payload:...  

And I noticed my CPU usages exceeded 100% during much of the test; and near the problem steps I saw that one CPU hit ceiling and pretty much stayed there the entire 240s waittime until the test ended, and "top" identified a zombie process during that 240sec wait period. A longer waittime did not help, either.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/25/2017, 10:22:06 AM<br><strong>Message</strong>: <pre>Uploaded patch set 9: Patch Set 8 was rebased.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/25/2017, 5:23:10 PM<br><strong>Message</strong>: <pre>Uploaded patch set 10.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/25/2017, 5:40:39 PM<br><strong>Message</strong>: <pre>Uploaded patch set 11.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/25/2017, 7:08:29 PM<br><strong>Message</strong>: <pre>Patch Set 11: Verified+1 Code-Review+2

Verified.
Sometimes test failed; we can open a bug against fabric later, if it does not consistently pass.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/25/2017, 7:08:42 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Scott Zwierzynski</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 8/31/2017, 8:29:31 AM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review+1

Late to the party but I said I'd look at it once I got back. This LGTM, thanks!</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1502733829<br><strong>GitHubRevision</strong>: [e2bf7c947dcdf3dad0b1f12df6e20a3b7acc2803](https://github.com/hyperledger/fabric-test/commit/e2bf7c947dcdf3dad0b1f12df6e20a3b7acc2803)<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1502733925<br><strong>GitHubRevision</strong>: [3c524368ebc697b00d316c1528bb957b1b5d29d4](https://github.com/hyperledger/fabric-test/commit/3c524368ebc697b00d316c1528bb957b1b5d29d4)<br><br><strong>Approver</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Approved</strong>: 8/14/2017, 5:03:49 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1502748365<br><strong>GitHubRevision</strong>: [ad9564b035a8d08921e2973e9cec4293f7b9477f](https://github.com/hyperledger/fabric-test/commit/ad9564b035a8d08921e2973e9cec4293f7b9477f)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/14/2017, 6:57:22 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1502910901<br><strong>GitHubRevision</strong>: [ee884870eed11a2dede80bc5a9240996b890f45b](https://github.com/hyperledger/fabric-test/commit/ee884870eed11a2dede80bc5a9240996b890f45b)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/16/2017, 6:48:05 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/16/2017, 9:26:53 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503003074<br><strong>GitHubRevision</strong>: [9041f47170af4a0962792754a0e60fde6b5e10bd](https://github.com/hyperledger/fabric-test/commit/9041f47170af4a0962792754a0e60fde6b5e10bd)<br><br></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503009660<br><strong>GitHubRevision</strong>: [7fe9ed0af3b56732f4d96031a1f9663cb8ce333c](https://github.com/hyperledger/fabric-test/commit/7fe9ed0af3b56732f4d96031a1f9663cb8ce333c)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/17/2017, 7:02:42 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503068308<br><strong>GitHubRevision</strong>: [7ff5bb02c0aa137d2bd4aaa5031b26e5c4130b06](https://github.com/hyperledger/fabric-test/commit/7ff5bb02c0aa137d2bd4aaa5031b26e5c4130b06)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/18/2017, 5:50:21 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/18/2017, 5:50:21 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503417927<br><strong>GitHubRevision</strong>: [9f11e7fbbc560e06c826efaa9d11bf5313862bd1](https://github.com/hyperledger/fabric-test/commit/9f11e7fbbc560e06c826efaa9d11bf5313862bd1)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/22/2017, 7:12:07 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/22/2017, 7:12:07 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503670926<br><strong>GitHubRevision</strong>: [8db08b2a8a0eb403b1e746c3cf0f4107a4997ef2](https://github.com/hyperledger/fabric-test/commit/8db08b2a8a0eb403b1e746c3cf0f4107a4997ef2)<br><br></blockquote><h3>PatchSet Number: 10</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503696190<br><strong>GitHubRevision</strong>: [a53b2a73b84f595633fe53f6edbafb3720e61402](https://github.com/hyperledger/fabric-test/commit/a53b2a73b84f595633fe53f6edbafb3720e61402)<br><br></blockquote><h3>PatchSet Number: 11</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Uploader</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Created</strong>: 1503697239<br><strong>GitHubRevision</strong>: [a419b3031f07f85b9cb61b4ebbbc82594cab9421](https://github.com/hyperledger/fabric-test/commit/a419b3031f07f85b9cb61b4ebbbc82594cab9421)<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 8/31/2017, 8:29:31 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/25/2017, 7:08:29 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Scott Zwierzynski<br><strong>Merged</strong>: 8/25/2017, 7:08:42 PM<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/25/2017, 7:08:29 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote>