<strong>Project</strong>: fabric-test<br><strong>Branch</strong>: master<br><strong>ID</strong>: 12447<br><strong>Subject</strong>: [FAB-4663] Gossip test: In non-leader peer<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/14/2017, 5:40:13 PM<br><strong>LastUpdated</strong>: 8/18/2017, 11:33:21 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-4663] Gossip test: In non-leader peer

Test to check if the Gossip component is able to function when a
non-leader peer goes down temporarily and comes back up, and meanwhile
there have been blocks that were generated.

Makes necessary changes in the behave implementation.

Change-Id: I499e4c397e854a2c45927e001e7ae6b85a47faca
Signed-off-by: Adnan Choudhury <adnan.choudhury@itpeoplecorp.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/14/2017, 5:40:13 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/16/2017, 9:30:44 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1

(2 comments)

suggestions for ease of use, and for more flexible use</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/16/2017, 2:53:01 PM<br><strong>Message</strong>: <pre>Patch Set 1:

> (2 comments)
 > 
 > suggestions for ease of use, and for more flexible use
1. Good point, "initial leader" would be more appropriate than "initial elected-peer"
2. Currently, if a query/invoke does not specify a peer, it goes to peer0Org1, as opposed to finding an active peer and using that. The reasoning behind it was that we want to be deterministic on which peer we want to act on. If we dynamically select active peer during each transaction, then the same statement can carry out two different operations depending on other factors, which would not be clear from the statement.</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/16/2017, 4:23:20 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/16/2017, 4:26:39 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(8 comments)</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/16/2017, 4:52:54 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/16/2017, 5:11:13 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/16/2017, 5:12:01 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(6 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 8/16/2017, 6:29:29 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+1</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/17/2017, 11:40:55 AM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

run command tested with: 
behave gossip.feature --no-capture --no-capture-stderr
Will also work with:
behave gossip.feature</pre><strong>Reviewer</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Reviewed</strong>: 8/18/2017, 10:55:37 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/18/2017, 11:33:05 AM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1 Code-Review+2

behave gossip.feature:
  1 feature passed, 0 failed, 0 skipped
  2 scenarios passed, 0 failed, 0 skipped
  66 steps passed, 0 failed, 0 skipped, 0 undefined
  Took 5m8.217s</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 8/18/2017, 11:33:21 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Latitia Haskins</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Uploader</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Created</strong>: 8/14/2017, 5:40:13 PM<br><strong>UnmergedRevision</strong>: [29d052b43eb543d825a6efdcbd12fcd2e7df415b](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/29d052b43eb543d825a6efdcbd12fcd2e7df415b)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/16/2017, 9:30:44 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/docker-compose/docker-compose-kafka.yml#L376](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/docker-compose/docker-compose-kafka.yml#L376)<br><strong>Comment</strong>: <pre>the default value for this should be in the .env file</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/docker-compose/docker-compose-kafka.yml#L376](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/docker-compose/docker-compose-kafka.yml#L376)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature/gossip.feature#L14](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/gossip.feature#L14)<br><strong>Comment</strong>: <pre>Shouldn't this be relative path to the submodule?
 ../fabric/examples/...</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/gossip.feature#L14](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/gossip.feature#L14)<br><strong>Comment</strong>: <pre>No, the path listed here is correct. This is the path that's mounted in the docker composition file to the desired chaincode directory.</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [feature/gossip.feature#L26](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/gossip.feature#L26)<br><strong>Comment</strong>: <pre>Points to ponder: First, this implies the testcase will work ONLY when using leader election in the peers. If so, then that should be a precondition stated at the beginning of testcase comments (since the testcase depends on this being the configuration of the Default network setup).
I do not understand why we are sending invokes specifically to a leader; is it ok to send to any other peer, including a nonLeader?
It seems to me the steps would work if you set your leaders. And it would also work if you send invokes to ANY peer (except the one that was stopped) in the specified org, so maybe we could simplify this for the user to avoid specifying a peer and let the backend find one (and ensure that it is up and can receive invokes).
Right now we have a function that finds a peer. Does that choice ensure the peer is operating, or does the user need to know which peer is the "default peer to use"? Maybe we need that function to choose a default peer to use ***which is up and running***. And then other functions to find a nonleader peer that is currently up, and another to find a leader peer that is up. Would that be sufficient allow you to write the scenarios required? I am not sure, because things get more complicated when you have to remember which peer we stopped, so you can start it again afterwards.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/gossip.feature#L26](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/gossip.feature#L26)<br><strong>Comment</strong>: <pre>I'm not totally following this, but you can add the following assert in the invoke and query methods in endorser_util.py "assert peer in context.composition.collectServiceNames(), "The peer '{0}' is not running".format(peer)"</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/steps/endorser_impl.py#L123](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_impl.py#L123)<br><strong>Comment</strong>: <pre>since you can only invoke on a peer, I would change this variable name to "peer", so that it's clear that this only happens on peers.</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/steps/endorser_impl.py#L123](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_impl.py#L123)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L249](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L249)<br><strong>Comment</strong>: <pre>Nit: Can you simplify this by using "not"? Adds to readability of the python code.

if not hasattr(context, 'initial_elected_leader'):</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L249](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L249)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L254](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L254)<br><strong>Comment</strong>: <pre>You can simplify this by using the "get_peers(context)" method, then your if statement will only be `if (org in container) and search_log(container, "Becoming a leader")`</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L254](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L254)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L262](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L262)<br><strong>Comment</strong>: <pre>Same nit</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L262](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L262)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L274](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L274)<br><strong>Comment</strong>: <pre>Nit: (Just a personal preference) Since this returns True or False, what do you think of naming this `isPresent`? This will add to readability.</pre><strong>Commenter</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>CommentLine</strong>: [feature/steps/endorser_util.py#L274](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/29d052b43eb543d825a6efdcbd12fcd2e7df415b/feature/steps/endorser_util.py#L274)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Uploader</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Created</strong>: 8/16/2017, 4:23:20 PM<br><strong>UnmergedRevision</strong>: [534a8e4ece5dedf47a282c9b4d53735cecfc3fb2](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/534a8e4ece5dedf47a282c9b4d53735cecfc3fb2)<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Uploader</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Created</strong>: 8/16/2017, 4:52:54 PM<br><strong>UnmergedRevision</strong>: [8cafd8197c51f32c5ac6a5106c1cb19bc8ba8616](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/8cafd8197c51f32c5ac6a5106c1cb19bc8ba8616)<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Uploader</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Created</strong>: 8/16/2017, 5:11:13 PM<br><strong>UnmergedRevision</strong>: [27575b9fbe194fd47fafcbcbfb6c8148e7ecf907](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/27575b9fbe194fd47fafcbcbfb6c8148e7ecf907)<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 8/16/2017, 6:29:29 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Approved</strong>: 8/17/2017, 11:40:55 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Uploader</strong>: Adnan C - adnan.choudhury@itpeoplecorp.com<br><strong>Created</strong>: 8/18/2017, 10:55:37 AM<br><strong>GitHubMergedRevision</strong>: [1b89acb70e9927c86049c25eb559509077204548](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/1b89acb70e9927c86049c25eb559509077204548)<br><br><strong>Approver</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Approved</strong>: 8/18/2017, 11:33:05 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Latitia Haskins<br><strong>Merged</strong>: 8/18/2017, 11:33:21 AM<br><br><strong>Approver</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Approved</strong>: 8/18/2017, 11:33:05 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote>