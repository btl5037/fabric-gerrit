<strong>Project</strong>: fabric-test<br><strong>Branch</strong>: master<br><strong>ID</strong>: 13749<br><strong>Subject</strong>: [FAB-5547] configure Makefile for CI tests<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 9/22/2017, 3:01:29 PM<br><strong>LastUpdated</strong>: 10/17/2017, 10:55:25 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-5547] configure Makefile for CI tests

Create a Makefile with CI targets to run tests from CI system.
this change removes lot of dependency from ci and test scripts are
maintained in fabric-test repo. From CI builder script, we have to
run "make ci-daily", "make ci-smoke" and "make ci-release"

Change-Id: Ib6dbdf79c05bde683090bef60fc1a5c0c554d4dd
Signed-off-by: rameshthoomu <rameshbabu.thoomu@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Reviewed</strong>: 9/22/2017, 3:01:29 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Reviewed</strong>: 9/22/2017, 3:02:49 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 3:06:14 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/76/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 4:08:28 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-test-verify-x86_64/76/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-test-verify-x86_64/76</pre><strong>Reviewer</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>Reviewed</strong>: 9/22/2017, 5:09:29 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(4 comments)</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 9/23/2017, 2:54:19 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(6 comments)

This is good stuff - but Ratnakar had good suggestions to reduce duplications to prevent maintenance problems. After looking at everything, I agree we can reduce considerably. How about this:

1. Remove files pip-install-daily.sh and pip-install-smoke.sh
2. Put all the pip-install commands into a single file pip-install.sh
3. Put the other duplicated environment setup steps into its own file such as setup-virtual-env.sh
4. Keep Build-docker-images.sh (but rename without using the uppercase).
5. Repurpose daily-tests.sh and smoke-tests.sh. These should be the ones called from the Makefile. These should call the other helper files (listed above), do the activate/deactivate, and call regression/daily/runDailyTestSuite.sh (or smoke suite or whatever).</pre><strong>Reviewer</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Reviewed</strong>: 9/23/2017, 5:07:13 PM<br><strong>Message</strong>: <pre>Patch Set 2:

OR, if all the setup is the same, then maybe it would be simpler to just keep all of it in one script, and the makefile could call that script with a parameter (test suite type = smoke | daily | regression | etc), and use that to choose which tests to run near the end of the script.</pre><strong>Reviewer</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Reviewed</strong>: 9/25/2017, 11:17:59 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(6 comments)

This can be flattened. Utilize what having a Makefile gives you. There's no need for all of these scripts. If you absolutely want a script, you can have just 1 setup-virtualenv.sh that performs pip installs in a virtualenv environment. Or you can even have that in a stanza of it's own whether running in virtualenv or not. 

Ideally this would be only a Makefile and maybe a setup-virtualenv.sh.</pre><strong>Reviewer</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Reviewed</strong>: 10/17/2017, 10:55:25 PM<br><strong>Message</strong>: <pre>Abandoned

Submitted another patch set.</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Uploader</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Created</strong>: 9/22/2017, 3:01:29 PM<br><strong>UnmergedRevision</strong>: [a117da479203358d055da184acd039efbb84a777](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/a117da479203358d055da184acd039efbb84a777)<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Uploader</strong>: Ramesh Babu Thoomu - rameshbabu.thoomu@gmail.com<br><strong>Created</strong>: 9/22/2017, 3:02:49 PM<br><strong>UnmergedRevision</strong>: [8cc29c874ca0217e9c0d25762d7d5b3c77892ddc](https://github.com/hyperledger-gerrit-archive/fabric-test/commit/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/22/2017, 4:08:28 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>Approved</strong>: 9/22/2017, 5:09:29 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>Approved</strong>: 9/23/2017, 2:54:19 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>Approved</strong>: 9/25/2017, 11:17:59 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>CommentLine</strong>: [Makefile#L13](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/Makefile#L13)<br><strong>Comment</strong>: <pre>Should we consider changing the license header ?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [Makefile#L13](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/Makefile#L13)<br><strong>Comment</strong>: <pre>I think we can use the shorter format - unless you can tell us there is a reason to use this format in this Makefile?

#
# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: Apache-2.0
#</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [Makefile#L23](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/Makefile#L23)<br><strong>Comment</strong>: <pre>why do you have to make all these executable? the scripts should be merged and executable already. Try something like this command and then push them again: git update-index --chmod=+x *.sh</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [Makefile#L27](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/Makefile#L27)<br><strong>Comment</strong>: <pre>I think instead of the chmods, you actually want a common setup script/command, then you can run the correct script or  command for each - daily, smoke, release, weekly...</pre><strong>Commenter</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/Build-docker-images.sh#L3](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/Build-docker-images.sh#L3)<br><strong>Comment</strong>: <pre>duplication</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/Build-docker-images.sh#L12](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/Build-docker-images.sh#L12)<br><strong>Comment</strong>: <pre>Why are these being done here in a script instead of the Makefile? If we are adding a Makefile, lets use what it gives us, then we can call the "clean" that corresponds to the correct run. 

That said, since CI is already running these clean, I'm not sure why you need to perform clean either. This seems like it will wipe makes that you already performed, if I'm reading this right.</pre><strong>Commenter</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/Build-docker-images.sh#L22](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/Build-docker-images.sh#L22)<br><strong>Comment</strong>: <pre>should we consider docker-clean aswell ?
if not, do we want to do the release-clean ?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [regression/ci-scripts/Build-docker-images.sh#L22](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/Build-docker-images.sh#L22)<br><strong>Comment</strong>: <pre>Good question! Is this being run on a new clean VM? do we need to do the cleans, or not?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [regression/ci-scripts/daily-tests.sh#L8](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/daily-tests.sh#L8)<br><strong>Comment</strong>: <pre>no need. make the scripts executable.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/daily-tests.sh#L11](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/daily-tests.sh#L11)<br><strong>Comment</strong>: <pre>These should be called from the Makefile. No need for this script.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/pip-install-daily.sh#L7](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/pip-install-daily.sh#L7)<br><strong>Comment</strong>: <pre>This is the only script that you may need (minus the last few lines) 

The deactivate can be done from the Makefile as well.</pre><strong>Commenter</strong>: Ratnakar Asara - asara.ratnakar@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/pip-install-smoke.sh#L2](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/pip-install-smoke.sh#L2)<br><strong>Comment</strong>: <pre>Can we merge this with pip-install-daily and maintain a single script ?</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [regression/ci-scripts/pip-install-smoke.sh#L2](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/pip-install-smoke.sh#L2)<br><strong>Comment</strong>: <pre>Makes sense to put the environment setup statements in a shared script, and call it pip-install, or call it setup_env.sh, so we have only one copy.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/pip-install-smoke.sh#L33](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/pip-install-smoke.sh#L33)<br><strong>Comment</strong>: <pre>Same comment as before. Put all of this in it's own file with the remaining steps in the Makefile for the corresponding stanza.</pre><strong>Commenter</strong>: Latitia Haskins - latitia.haskins@gmail.com<br><strong>CommentLine</strong>: [regression/ci-scripts/smoke-tests.sh#L7](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/smoke-tests.sh#L7)<br><strong>Comment</strong>: <pre>File not needed and I agree with Scott on making the scripts executable.</pre><strong>Commenter</strong>: Scott Zwierzynski - scottz@us.ibm.com<br><strong>CommentLine</strong>: [regression/ci-scripts/smoke-tests.sh#L8](https://github.com/hyperledger-gerrit-archive/fabric-test/blob/8cc29c874ca0217e9c0d25762d7d5b3c77892ddc/regression/ci-scripts/smoke-tests.sh#L8)<br><strong>Comment</strong>: <pre>remove these chmod lines, and ensure the scripts are already executable.</pre></blockquote>