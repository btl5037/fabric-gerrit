<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 33300<br><strong>Subject</strong>: [FAB-16503] upgrade idStore format<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/30/2019, 2:43:13 PM<br><strong>LastUpdated</strong>: 9/11/2019, 7:29:52 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-16503] upgrade idStore format

To pause/resume channels on a peer, we need to add channel status
to idStore. It will change idStore format. This CR adds
upgrade function for idStore and stores active/inactive status
for each channel. The channel status will be updated by the
pause/resume channel functions.

Note that idStore format update will be executed via a dedicated
command that will perform all data format updates for v2.0 upgrade.

Change-Id: Iaa70a8f0deaaa1e916cbdd1af1a13dfeaf93bd4d
Signed-off-by: Wenjian Qiao <wenjianq@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 8/30/2019, 2:43:13 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 2:49:04 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16898/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 2:49:53 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 2:57:18 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 2:58:17 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16898/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16898</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 3:00:24 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14911/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 3:01:08 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 3:01:20 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11557/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 3:02:19 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 3:26:38 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 4:21:10 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/30/2019, 4:22:07 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14911/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/14911

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11557/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11557</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/3/2019, 8:57:57 AM<br><strong>Message</strong>: <pre>Patch Set 2: Patch Set 1 was rebased</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/3/2019, 1:19:52 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/3/2019, 1:20:17 PM<br><strong>Message</strong>: <pre>Topic set to FAB-16035</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:24:22 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16933/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:25:09 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:31:20 PM<br><strong>Message</strong>: <pre>Patch Set 3: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:32:04 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16933/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16933</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:34:43 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11579/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:35:17 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14935/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:35:37 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 1:36:09 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting unit tests</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 9/3/2019, 1:46:11 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(10 comments)

Haven't looked at the test files yet. Meanwhile, some comments on the main code</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 2:02:04 PM<br><strong>Message</strong>: <pre>Patch Set 3: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 2:47:49 PM<br><strong>Message</strong>: <pre>Patch Set 3: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/3/2019, 2:48:42 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11579/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11579

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14935/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/14935</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/4/2019, 11:28:44 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:31:08 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16973/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:31:52 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting verify build</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/4/2019, 11:32:01 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(10 comments)

Thank you, Manish.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:39:08 AM<br><strong>Message</strong>: <pre>Patch Set 4: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:40:00 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16973/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16973</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:41:37 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11609/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:42:26 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:42:32 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14964/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 11:43:22 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 12:11:53 PM<br><strong>Message</strong>: <pre>Patch Set 4: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 12:58:32 PM<br><strong>Message</strong>: <pre>Patch Set 4: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/4/2019, 12:59:24 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11609/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11609

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14964/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/14964</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 9/4/2019, 4:37:54 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(13 comments)

A few more comments</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/5/2019, 12:30:43 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/5/2019, 12:31:00 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(13 comments)

Thank you, Manish.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:35:20 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16994/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:36:07 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:42:42 PM<br><strong>Message</strong>: <pre>Patch Set 5: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:43:33 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16994/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16994</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:45:51 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11624/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:46:40 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:47:14 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14985/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 12:48:09 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 1:15:03 PM<br><strong>Message</strong>: <pre>Patch Set 5: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 2:04:06 PM<br><strong>Message</strong>: <pre>Patch Set 5: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/5/2019, 2:04:59 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11624/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11624

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14985/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/14985</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 9/6/2019, 5:59:45 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(13 comments)

Thanks Wenjian. Overall code looks good now. However,some comments on the tests. The comments other than about tests, are at a couple of places that should be trivial to fix.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 9/7/2019, 8:42:59 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(5 comments)</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 12:51:53 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 12:55:24 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17012/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 12:56:15 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting verify build</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 12:58:11 PM<br><strong>Message</strong>: <pre>Patch Set 6:

(17 comments)

Thank you, Manish and Dave.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:02:43 PM<br><strong>Message</strong>: <pre>Patch Set 6: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:03:39 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17012/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/17012</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:05:50 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11643/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:06:40 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:06:46 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15004/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:07:34 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 1:31:01 PM<br><strong>Message</strong>: <pre>Patch Set 6: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 2:10:20 PM<br><strong>Message</strong>: <pre>Patch Set 6: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 2:10:56 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11643/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11643

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15004/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/15004</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 2:45:41 PM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 2:53:04 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17014/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 2:53:55 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:00:19 PM<br><strong>Message</strong>: <pre>Patch Set 7: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:01:05 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17014/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/17014</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:03:45 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11645/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:04:53 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15006/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:05:02 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:06:01 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Starting unit tests</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 3:33:28 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(4 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 3:34:30 PM<br><strong>Message</strong>: <pre>Patch Set 7: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 4:45:26 PM<br><strong>Message</strong>: <pre>Patch Set 7: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 4:46:26 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11645/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11645

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15006/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/15006</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 5:46:29 PM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 5:48:17 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(4 comments)

Thank you, Manish.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 5:52:12 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17027/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 5:53:00 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Starting verify build</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 9/9/2019, 5:55:05 PM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+2

LGTM now - Thanks Wenjian</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 5:59:57 PM<br><strong>Message</strong>: <pre>Patch Set 8: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:00:47 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/17027/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/17027</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:03:29 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11652/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:04:13 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15013/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:04:21 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:05:09 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 6:31:32 PM<br><strong>Message</strong>: <pre>Patch Set 8: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 7:15:40 PM<br><strong>Message</strong>: <pre>Patch Set 8: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/9/2019, 7:16:35 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11652/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11652

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/15013/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/15013</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 9/11/2019, 7:04:30 AM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+2</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 9/11/2019, 7:04:51 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by David Enyeart</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/11/2019, 7:05:00 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/6310/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/11/2019, 7:05:00 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/7611/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/11/2019, 7:29:52 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/6310/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/6310

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/7611/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/7611</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 8/30/2019, 2:43:13 PM<br><strong>UnmergedRevision</strong>: [fdcc1afea54aa4b1e6ca19f16761d518fea4f807](https://github.com/hyperledger-gerrit-archive/fabric/commit/fdcc1afea54aa4b1e6ca19f16761d518fea4f807)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 2:57:18 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 2:57:18 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 4:21:10 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 3:26:38 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/3/2019, 8:57:57 AM<br><strong>UnmergedRevision</strong>: [b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf](https://github.com/hyperledger-gerrit-archive/fabric/commit/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 2:57:18 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 2:57:18 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 4:21:10 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/30/2019, 3:26:38 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L83](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/common/ledger/util/leveldbhelper/leveldb_helper.go#L83)<br><strong>Comment</strong>: <pre>this seem very weak semantics, particularly given how this has been used in upper layer. Specifically, If you start peer and a crash happens before you can add the new format ID (but leveldb is able to create a couple basic files such as LOG and LOCK), it will keep crashing on next start.

I have added a function in this CR - https://gerrit.hyperledger.org/r/#/c/fabric/+/33111/14/common/ledger/util/leveldbhelper/leveldb_helper.go@80 for a similar need. You can make this function exported and use</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L83](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/common/ledger/util/leveldbhelper/leveldb_helper.go#L83)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L36](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L36)<br><strong>Comment</strong>: <pre>ID does not seem a good fit</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L36](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L36)<br><strong>Comment</strong>: <pre>Removed</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>We decided to use a proto message for the value (for extend-ability). For now, the proto message will have just one field (status).</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L332](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L332)<br><strong>Comment</strong>: <pre>add a return here and remove the else block for simplifying the flow</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L332](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L332)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L343](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L343)<br><strong>Comment</strong>: <pre>this function does not verify old format and blindly performs the upgrade. The implicit value of oldFormat is "" and should be verified. Else, going forward if we make changes with new version (say 3.0), a user mistake of running incompatible binary may go unnoticed.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L343](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L343)<br><strong>Comment</strong>: <pre>Added checking for old format, but checked "nil" not "" because formatKey didn't exist in older releases.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L359](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L359)<br><strong>Comment</strong>: <pre>(l, m)?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L359](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L359)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L362](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L362)<br><strong>Comment</strong>: <pre>Just noticed that this was wrong in the earlier iterating code as well. Though, it should not happen in practice but the correct code would use "Next()" here and would call Error() function on itr.

In case of an error, this function would silently return false half way through iterations.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L362](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L362)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L437](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L437)<br><strong>Comment</strong>: <pre>you can open the iterator for range {"s", "t"} at line 433 to start with - instead of opening for entire scan and then filtering.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L437](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L437)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L438](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L438)<br><strong>Comment</strong>: <pre>not needed</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L438](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/kv_ledger_provider.go#L438)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade.go#L25](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/upgrade.go#L25)<br><strong>Comment</strong>: <pre>file lock would be acquired in the top level command.
Also, use this function (https://github.com/hyperledger/fabric/blob/d363de6f1ee847936ea65dcb7d30e4921616c7e6/core/ledger/kvledger/ledger_filepath.go#L12) instead of manual path construction</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade.go#L25](https://github.com/hyperledger-gerrit-archive/fabric/blob/b36769d6aed8ce1573aebfcc3a4177ff5e8b1ddf/core/ledger/kvledger/upgrade.go#L25)<br><strong>Comment</strong>: <pre>Agree. Added a top level method.</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/3/2019, 1:19:52 PM<br><strong>UnmergedRevision</strong>: [e2bc6fecdaf0ce99bb90512bd0b3c0ba93f4b74e](https://github.com/hyperledger-gerrit-archive/fabric/commit/e2bc6fecdaf0ce99bb90512bd0b3c0ba93f4b74e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/3/2019, 1:31:20 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/3/2019, 1:31:20 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/3/2019, 2:47:49 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/3/2019, 2:02:04 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/4/2019, 11:28:44 AM<br><strong>UnmergedRevision</strong>: [823e5a524d82feb9bec42a9ae1126cfceede4b18](https://github.com/hyperledger-gerrit-archive/fabric/commit/823e5a524d82feb9bec42a9ae1126cfceede4b18)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/4/2019, 11:39:08 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/4/2019, 11:39:08 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/4/2019, 12:58:32 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/4/2019, 12:11:53 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L59](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/common/ledger/util/leveldbhelper/leveldb_helper.go#L59)<br><strong>Comment</strong>: <pre>forgot to remove this?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L59](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/common/ledger/util/leveldbhelper/leveldb_helper.go#L59)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L78](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/common/ledger/util/leveldbhelper/leveldb_helper.go#L78)<br><strong>Comment</strong>: <pre>forgot to remove?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L78](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/common/ledger/util/leveldbhelper/leveldb_helper.go#L78)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>metadataKeyPrefix? (what is being stored against this is getting called metadata)</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L43](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L43)<br><strong>Comment</strong>: <pre>Remove these and used explicit check of "Status_ACTIVE" or "Status_INACTIVE". Byte comparison is obscure and will certainly need to change moment you add one more field.

Also, as a remote problem, protobuf does not guarantee the same bytes when you marshal them and can change with versions - though because of backward compatibility, it would unmarshal the marshaled message using previous versions.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L43](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L43)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L46](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L46)<br><strong>Comment</strong>: <pre>Better to make this explicit "idStoreFormatVersion"?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L46](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L46)<br><strong>Comment</strong>: <pre>Thought other dbs might reuse the same var when upgrading the format. Looks like only idStore is using this var, so changed to idStoreFormatVersion per comment.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L383](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L383)<br><strong>Comment</strong>: <pre>passing this from outside seems unnatural. Can you refer to this straight inside the function?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L383](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L383)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L393](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L393)<br><strong>Comment</strong>: <pre>this came from db, so should not be printed as string but rather as a raw bytes. Given this, it would make sense to print next one as bytes as well</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L393](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L393)<br><strong>Comment</strong>: <pre>I think using strings is more meaningful than using bytes. This error will be sent to the caller of the upgrade command.  ErrFormatVersionMismatch also uses strings for format.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L403](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L403)<br><strong>Comment</strong>: <pre>same as comment at other similar place</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L403](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L403)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L410](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L410)<br><strong>Comment</strong>: <pre>not needed</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L410](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L410)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L475](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L475)<br><strong>Comment</strong>: <pre>this should be renamed now "getAllActiveLedgerIDs"</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L475](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L475)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L477](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L477)<br><strong>Comment</strong>: <pre>In my previous comment, I had used "t" just as a hint. This will certainly cause confusion. Either 
- define it next "ledgerStatusKeyPrefix" (say "ledgerStatusStopKey") or
- make ledgerStatusKeyPrefix as a byte and them use ledgerStatusKeyPrefix+1 here.

Same at the other place...</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L477](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/kv_ledger_provider.go#L477)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/msgs/ledger_metadata.proto#L19](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/msgs/ledger_metadata.proto#L19)<br><strong>Comment</strong>: <pre>Conventionally, message name is specified using camelcase. This style is used for field names 
https://developers.google.com/protocol-buffers/docs/style#message-and-field-names</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/msgs/ledger_metadata.proto#L19](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/msgs/ledger_metadata.proto#L19)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/tests/v11_test.go#L25](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/tests/v11_test.go#L25)<br><strong>Comment</strong>: <pre>the use of filepath.Join fits more naturally here. Even better, if we start using functions in this file https://github.com/hyperledger/fabric/blob/master/core/ledger/kvledger/ledger_filepath.go. Please feel free to</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/tests/v11_test.go#L25](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/tests/v11_test.go#L25)<br><strong>Comment</strong>: <pre>The use of fmt.Sprintf was following the existing code for historyDBPath. Changed both paths to call the util functions.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/tests/v11_test.go#L25](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/tests/v11_test.go#L25)<br><strong>Comment</strong>: <pre>thanks for fixing at both places</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/tests/v11_test.go#L37](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/tests/v11_test.go#L37)<br><strong>Comment</strong>: <pre>Any reason you added these lines? Without this flow is quite understandable. (defer statement can be at the top as it was before)</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/tests/v11_test.go#L37](https://github.com/hyperledger-gerrit-archive/fabric/blob/823e5a524d82feb9bec42a9ae1126cfceede4b18/core/ledger/kvledger/tests/v11_test.go#L37)<br><strong>Comment</strong>: <pre>Had to clean up ledger files because otherwise, upgrade idStore failed due to `Error opening leveldb: resource temporarily unavailable`. Having said so, I have changed openIdStore to return an error instead of panic (just like other dbs) so that we can clean up opened ledger resources upon error. After this change, I don't need to call cleanup any more.</pre></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/5/2019, 12:30:43 PM<br><strong>UnmergedRevision</strong>: [9065b248b18db76a34123f1614c16e2c173ca8ac](https://github.com/hyperledger-gerrit-archive/fabric/commit/9065b248b18db76a34123f1614c16e2c173ca8ac)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/5/2019, 12:42:42 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/5/2019, 12:42:42 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/5/2019, 2:04:06 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/5/2019, 1:15:03 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L176](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/common/ledger/util/leveldbhelper/leveldb_helper.go#L176)<br><strong>Comment</strong>: <pre>Not a big deal but can you remove this round about way of getting the dbpath. When this is already available to the consumer (idstore in this case)?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_helper.go#L176](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/common/ledger/util/leveldbhelper/leveldb_helper.go#L176)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_provider.go#L42](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/common/ledger/util/leveldbhelper/leveldb_provider.go#L42)<br><strong>Comment</strong>: <pre>this does not make much sense here as this usage is in some other package</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [common/ledger/util/leveldbhelper/leveldb_provider.go#L42](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/common/ledger/util/leveldbhelper/leveldb_provider.go#L42)<br><strong>Comment</strong>: <pre>Removed</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>It is not immediately clear how this will be used, can you add a short comment.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L41)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L43](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L43)<br><strong>Comment</strong>: <pre>It is not immediately clear how this will be used, can you add a short comment.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L43](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L43)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L46](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L46)<br><strong>Comment</strong>: <pre>Not a big deal, but in the other two locations Manish used a string constant for this, may want to be consistent.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L46](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L46)<br><strong>Comment</strong>: <pre>Changed to string.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L398](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L398)<br><strong>Comment</strong>: <pre>We want an Info statement (only) when the upgrade actually takes place. This would be the place to log Info.
"The ledgerProvider db format is old, upgrading to the new format".</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L398](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L398)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L478](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L478)<br><strong>Comment</strong>: <pre>better not to rely upon the fact that "err != nil" => "val = nil". Adding an explicit check (|| err != nil) always better (at least for readability, if nothing else).</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L478](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L478)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L489](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L489)<br><strong>Comment</strong>: <pre>missed this one?
https://gerrit.hyperledger.org/r/#/c/fabric/+/33300/4/core/ledger/kvledger/kv_ledger_provider.go@475</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L489](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L489)<br><strong>Comment</strong>: <pre>Changed to getActiveLedgerIDs</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L497](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L497)<br><strong>Comment</strong>: <pre>As per Jason's suggestion, I had recently added a test for this kind of error path. You can close the db before calling this function.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L497](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L497)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L502](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L502)<br><strong>Comment</strong>: <pre>this error path (and the same at other places) can be tested by adding some bytes directly to db that gives error during unmarshalling.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L502](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/kv_ledger_provider.go#L502)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade.go#L31)<br><strong>Comment</strong>: <pre>No change will happen if it has already been upgraded, therefore this will be a meaningless info message most of the time. I suggest change it to a debug message and state "Attempting to upgrade..."</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade.go#L31)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L30)<br><strong>Comment</strong>: <pre>lately, we have been using "require." versions instead of "assert.". The former would stop the tests on first error. Which helps in debugging.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L30)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L33](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L33)<br><strong>Comment</strong>: <pre>UpgradeDataFormat?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L33](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L33)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L76](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L76)<br><strong>Comment</strong>: <pre>If you follow as per the below suggestion, this code can be removed - as this mainly just tests the construction of a new store as opposed to upgraded one and the fresh store is already tested here https://gerrit.hyperledger.org/r/#/c/fabric/+/33300/5/core/ledger/kvledger/kv_ledger_provider_test.go@78 (if something is missing there please move from here to that place)</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L76](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L76)<br><strong>Comment</strong>: <pre>Removed</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L93](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L93)<br><strong>Comment</strong>: <pre>This does not look good to try to reverse engineer the db to get to a state as if it is produced by 1.4 code. We already have a test that works on data actually produced by V11. I would suggest to leverage V11 data here for performing detailed verification done below (which is already done at the high level here - https://gerrit.hyperledger.org/r/#/c/fabric/+/33300/5/core/ledger/kvledger/tests/v11_test.go@39</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L93](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L93)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L159](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L159)<br><strong>Comment</strong>: <pre>Why not to use built-in testify function like used here - https://gerrit.hyperledger.org/r/#/c/fabric/+/33300/5/core/ledger/kvledger/tests/v11_test.go@41</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/upgrade_test.go#L159](https://github.com/hyperledger-gerrit-archive/fabric/blob/9065b248b18db76a34123f1614c16e2c173ca8ac/core/ledger/kvledger/upgrade_test.go#L159)<br><strong>Comment</strong>: <pre>Changed openIdStore to return an error instead of panic and reimplemented the test.</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/9/2019, 12:51:53 PM<br><strong>UnmergedRevision</strong>: [8c6958789e8d1924173e9c4a90e24912e3966964](https://github.com/hyperledger-gerrit-archive/fabric/commit/8c6958789e8d1924173e9c4a90e24912e3966964)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 1:02:43 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 1:02:43 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 2:10:20 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 1:31:01 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L51](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L51)<br><strong>Comment</strong>: <pre>this better be a const now (instead of a var)</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L51](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L51)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L367](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L367)<br><strong>Comment</strong>: <pre>From the tone of the message, not sure you wanted to make it a Info?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L367](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L367)<br><strong>Comment</strong>: <pre>Forgot to remove earlier - removed now.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L375](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L375)<br><strong>Comment</strong>: <pre>Here and below...

I would not call Wrap on an error that's coming from another fabric API (unless its a different goroutine). It would unnecessarily store another partial stack.

If you want to add anything that enhances the message from the lower layer, please use errors.WithMessage instead. If there is nothing much to add, simply propagate the error up. Here, latter seems to be a better fit as the original error is this https://github.com/hyperledger/fabric/blob/master/common/ledger/util/leveldbhelper/leveldb_helper.go#L85 but will leave the choice of adding message or not to you.</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L375](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L375)<br><strong>Comment</strong>: <pre>Removed Wrap</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L427](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L427)<br><strong>Comment</strong>: <pre>As done elsewhere, forgot to add "itr.Error() == nil &&" here?</pre><strong>Commenter</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L427](https://github.com/hyperledger-gerrit-archive/fabric/blob/8c6958789e8d1924173e9c4a90e24912e3966964/core/ledger/kvledger/kv_ledger_provider.go#L427)<br><strong>Comment</strong>: <pre>I realized the same and have added in PS 7.</pre></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/9/2019, 2:45:41 PM<br><strong>UnmergedRevision</strong>: [ef3f26c8bfcb6d919ebe4a36226668aea0f6e776](https://github.com/hyperledger-gerrit-archive/fabric/commit/ef3f26c8bfcb6d919ebe4a36226668aea0f6e776)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 3:00:19 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 3:00:19 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 4:45:26 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 3:34:30 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Uploader</strong>: Wenjian Qiao - wenjianq@gmail.com<br><strong>Created</strong>: 9/9/2019, 5:46:29 PM<br><strong>GitHubMergedRevision</strong>: [51752f3fdff8470d67dd0119e50dba3631f02941](https://github.com/hyperledger-gerrit-archive/fabric/commit/51752f3fdff8470d67dd0119e50dba3631f02941)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 5:59:57 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 5:59:57 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 7:15:40 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/9/2019, 6:31:32 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 9/9/2019, 5:55:05 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 9/11/2019, 7:04:30 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: David Enyeart<br><strong>Merged</strong>: 9/11/2019, 7:04:51 AM<br><br></blockquote>