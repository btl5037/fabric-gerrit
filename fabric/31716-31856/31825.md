<strong>Project</strong>: fabric<br><strong>Branch</strong>: release-1.4<br><strong>ID</strong>: 31825<br><strong>Subject</strong>: FAB-15173 Consensus migration: maintenance filter<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 6/11/2019, 7:25:13 AM<br><strong>LastUpdated</strong>: 6/20/2019, 12:41:40 AM<br><strong>CommitMessage</strong>:<br><pre>FAB-15173 Consensus migration: maintenance filter

Entry into maintenance mode should not be accompanied with
additional config changes, because the whole point of maintenance
mode is to first create a stable and safe backup point, with a
good configuration. In particular, it should not be allowed change
the consensus type together with entry or exit from maintenance mode.
Changing the consensus type should only be done in maintenance mode.

In addition the type of consensus type transitions should be
checked - currently we only support kafka to raft.

- Transition in or out of maintenance mode (i.e. a change in
  ConsensusType.State) cannot be accompanied with a chenge to any
  othe group or value except /Channel/Orderer/ConsensusType.

- Entry: Prevent transition into maintenance mode together with
  change in ConsensusType.Type
- Prevent changes to ConsensusType.Type unless in maintenance mode
- Exit: Prevent transition out-of maintenance mode together with
  change in ConsensusType.Type

This is achieved by adding a new filter, the maintenance-filter,
which is only evaluated on ProcessesConfigUpdate(). This is unlike
all other filters, which are evaluated on both normal and config
messages. For that end it is added to a separate Rule field in the
standardchannel.go. This Rule can later be extended to
a <configFilters []Rule> array (slice) if we find we need more
filters that apply to config only.

When capability OrdererV1_4_2 (or later) is off, entry into
maintenance mode or changing consensus-type should be prevented.

Change-Id: Ib9bd823042b71d972739de1c1a78f6343dbd794f
Signed-off-by: Yoav Tock <tock@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 6/11/2019, 7:25:13 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:25:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/14536/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:25:49 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:30:06 AM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:30:16 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/9444/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:30:40 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:30:53 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/14536/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/14536</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:35:36 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12883/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 7:36:04 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 8:01:54 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 8:03:23 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/11/2019, 8:04:04 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/9444/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/9444

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12883/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/12883</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 6/16/2019, 10:24:19 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 6/17/2019, 6:02:16 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2: Patch Set 1 was rebased.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 6/19/2019, 11:59:57 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 6/20/2019, 12:01:25 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jiannan Guo</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/20/2019, 12:03:14 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6974/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/20/2019, 12:03:22 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5660/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/20/2019, 12:41:40 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5660/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/5660

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6974/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/6974</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 6/11/2019, 7:25:13 AM<br><strong>UnmergedRevision</strong>: [d4a96c8d50e375eebc7aaf8aa5bccb48227e73c7](https://github.com/hyperledger-gerrit-archive/fabric/commit/d4a96c8d50e375eebc7aaf8aa5bccb48227e73c7)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 7:30:06 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 7:30:06 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 8:03:23 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 8:01:54 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 6/16/2019, 10:24:19 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 6/17/2019, 6:02:16 AM<br><strong>GitHubMergedRevision</strong>: [c93f2d0bce2983579ad2e632344c3556a46a26fe](https://github.com/hyperledger-gerrit-archive/fabric/commit/c93f2d0bce2983579ad2e632344c3556a46a26fe)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 7:30:06 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 7:30:06 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 8:03:23 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 6/11/2019, 8:01:54 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 6/16/2019, 10:24:19 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Approved</strong>: 6/19/2019, 11:59:57 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jay Guo<br><strong>Merged</strong>: 6/20/2019, 12:01:25 AM<br><br></blockquote>