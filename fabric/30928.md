<strong>Project</strong>: fabric</br><strong>Branch</strong>: master<br><strong>ID</strong>: 30928<br><strong>Subject</strong>: [FAB-15143] Fix Test flake in TestDifferentMessages<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Assignee</strong>:<strong>Created</strong>: 4/12/2019, 3:33:16 PM<br><strong>LastUpdated</strong>: 4/12/2019, 5:12:27 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-15143] Fix Test flake in TestDifferentMessages

The test tries to evict entries from the signer cache by inserting new
ones (different than the existing ones) in parallel, however it can be
that all insertions reach the conclusion that there is no need to shrink
the cache (because of concurrency).

Therefore we:
1) Make the insertion serial instead of parallel
2) Increase the amount of items we opreate on by 10,
in order for the probability of no one of them to be picked to be negligible.

I ran the test 50,000 times and it doesn't fail now.

Change-Id: I2de7b9f17cc6b27ffda2af11d1f5b3e8b33f3a67
Signed-off-by: yacovm <yacovm@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/12/2019, 3:33:16 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:36:19 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13043/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:36:42 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:41:39 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:42:20 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13043/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/13043</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:43:44 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/11499/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:44:07 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:44:43 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8165/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 3:45:04 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 4:07:48 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/12/2019, 4:11:52 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2

In the future, instead of looking for serialization bugs by throwing go routines in a loop, we should probably step back and consider other ways of testing that do not rely heavily on the dispatching characteristics of the host. For example, using a spy to help validate the locking protocol...</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/12/2019, 4:19:13 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/12/2019, 4:19:17 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/12/2019, 4:19:20 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Yacov Manevich</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 4:22:07 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6505/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 4:22:36 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 4:22:49 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5190/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 4:23:15 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/11499/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/11499

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8165/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/8165</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/12/2019, 5:12:27 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6505/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/6505

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5190/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/5190</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Uploader</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Created</strong>: 1555097596<br><strong>GitHubRevision</strong>: [465c9425e55029456a0916b47198e1426ea8a32b](https://github.com/hyperledger/fabric/commit/465c9425e55029456a0916b47198e1426ea8a32b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/12/2019, 3:41:39 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/12/2019, 3:41:39 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/12/2019, 4:22:36 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/12/2019, 4:07:48 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 4/12/2019, 4:19:17 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 4/12/2019, 4:19:13 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Yacov Manevich<br><strong>Merged</strong>: 4/12/2019, 4:19:20 PM<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 4/12/2019, 4:11:52 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>