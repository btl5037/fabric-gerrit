<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 4739<br><strong>Subject</strong>: [FAB-1812] Pass configtx.Manager.Apply to validate<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/23/2017, 6:12:01 PM<br><strong>LastUpdated</strong>: 1/25/2017, 5:18:31 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-1812] Pass configtx.Manager.Apply to validate

https://jira.hyperledger.org/browse/FAB-1812

The peer needs to apply configuration transactions as they are
committed.  This changeset hooks the configtx.Manager.Apply method into
core/committer/txvalidator/validator.go so that configuration is updated
as configuration blocks are committed.

Because it was in the same path, it also passes the MSPManager to the
validator to remove one of the dependencies on the throwaway MSP
multichain manager.

Change-Id: I4d606d850dddb684468d7a5dd7257e8dd967ad28
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2017, 6:12:01 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 6:12:59 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5560/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 6:38:37 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5560/ : FAILURE</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2017, 9:28:31 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 9:29:28 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5561/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 10:10:36 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5561/ : SUCCESS</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 1/23/2017, 10:12:33 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

LGTM!</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/24/2017, 4:57:16 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(4 comments)

Looking good! Thanks Jason. See below a few comments/Qs.</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 7:29:23 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)

I think we need to do https://gerrit.hyperledger.org/r/#/c/4739/2/core/committer/txvalidator/validator.go@148</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 7:29:46 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

oops - just marking as -1 for https://gerrit.hyperledger.org/r/#/c/4739/2/core/committer/txvalidator/validator.go@148 (we may be wrong)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 9:47:52 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(4 comments)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 10:03:33 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 10:07:30 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5577/</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/24/2017, 10:12:00 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(2 comments)

Thx Jason, see below.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 10:23:24 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 10:32:16 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 10:42:56 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5577/ : FAILURE</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/24/2017, 10:50:17 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(2 comments)

Thanks, see below!</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 1:03:01 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 1:03:48 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(2 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 1:04:59 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5595/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 1:54:02 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5595/ : SUCCESS</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 10:38:33 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+1

Will wait for other reviews.</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 11:03:57 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/25/2017, 4:24:25 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 1/25/2017, 4:25:04 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Gari Singh</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/25/2017, 4:26:01 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/850/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/25/2017, 5:18:31 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/850/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 1/23/2017, 6:12:01 PM<br><strong>UnmergedRevision</strong>: [e1c0517f706c70fc6123373d3ca428c0eeab8a6f](https://github.com/hyperledger-gerrit-archive/fabric/commit/e1c0517f706c70fc6123373d3ca428c0eeab8a6f)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 6:38:37 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 1/23/2017, 9:28:31 PM<br><strong>UnmergedRevision</strong>: [c71b3f44a9c6428477ee6011421027efb0824b7e](https://github.com/hyperledger-gerrit-archive/fabric/commit/c71b3f44a9c6428477ee6011421027efb0824b7e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 10:10:36 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 1/23/2017, 10:12:33 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 1/24/2017, 7:29:46 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/committer_impl.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/committer_impl.go#L52)<br><strong>Comment</strong>: <pre>Could you please leave a comment explaining why this is the case? (unless you think it's obvious)</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/committer_impl.go#L52](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/committer_impl.go#L52)<br><strong>Comment</strong>: <pre>Sure.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L37](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L37)<br><strong>Comment</strong>: <pre>This interface is going to be very useful in many other parts of the code. For instance, the endorser needs to extract the msp manager for the chain. Currently it uses the mspmgr bookeeping performed by the mspmgr, but that'll have to change. 

If we are convinced that this interface should be of general usage, how about we move it to core/common?

Of course please feel free to stage these changes as you see fit.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L37](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L37)<br><strong>Comment</strong>: <pre>Maybe I need to be slapped for using this pattern, but what worked well in the orderer to break import cycles and ease testing.  Essentially the idea is to define only the subset of the chain support required for the particular module.

The full chain support provides many other methods (Like a 'Validate', a 'ChainID', a 'PolicyManager', and eventually more).  If we define this all in a common interface, then we have the headache mocking the whole thing, even the unused methods.  However, because the backing object is the full support, so it's trivial to add additional methods in the future.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L37](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L37)<br><strong>Comment</strong>: <pre>Oh I see.. that makes sense, although it will force us to propagate changes to the intersections of the interfaces I guess.. at any rate, it was just a suggestion - I'm fine with whatever you choose.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Why aren't we just marking the tx as bad in the bit filter as we do for endorser txes?</pre><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>agreed - and I believe that config transactions will be the only tx in the block so basically just need to mark the first (and only) tx as invalid</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Because this is non-deterministic, and generally indicates a forged block from a byzantine ordering service.

If the ordering service sends a configuration block, then the orderer has adopted that configuration block.

For instance, if the orderer keys were rotated, and the conf block is not adopted, then all subsequent blocks will fail to validate.

For another instance, if the hashing algorithm changes (not actually supported for v1, but planned), then all subsequent blocks fill fail to validate.

Initially, I had panics here (because it implies a successful byzantine attack from the orderer), but decided it was probably more reasonable to kick an error back indicating the block could not be committed.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Where does the non-determinism come from? I can only see it if the malicious orderers collude with a set of peers - they (the malicious peers) will accept the bogus config tx whereas honest peers won't. Otherwise, there's nothing non-deterministic in the validation code, is there?

What should this code return? From what you say, the only acceptable outcome is panicking.. if orderers have switched to a different config and we can't accept it, we can't continue. Right? Bubbling up an error just seems like we have to panic upstream..

Wdyt?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>I suppose non-determinism is the wrong term.  My thought was if this block is indeed a forgery, then if we adopt it, flagging it as incorrect, then someone else might adopt the real block, and the chain would fork.

Of course if someone can forge blocks, they can cause a fork regardless, so probably not a scenario worth considering.

The idea with returning an error rather than panicking is that rather than kill the system, we simply stop progress on this chain, and eventually if a valid config block comes along, we can resume progress.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>I could raise the severity of these log messages to Critical if that is helpful?</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Oh yes, you have a good point, progress should continue, just not on this chain. We should make sure that the caller stops operations on this channel if it gets an error from us (or just add a todo for now I guess).</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Yes I believe that would be helpful</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L148](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L148)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L154](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L154)<br><strong>Comment</strong>: <pre>Same as above</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L154](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L154)<br><strong>Comment</strong>: <pre>Same as above as well!</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L154](https://github.com/hyperledger-gerrit-archive/fabric/blob/c71b3f44a9c6428477ee6011421027efb0824b7e/core/committer/txvalidator/validator.go#L154)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 1/24/2017, 10:03:33 AM<br><strong>UnmergedRevision</strong>: [2f88819dabd85f8f6fe33ae8bf5e06cf4fb156b4](https://github.com/hyperledger-gerrit-archive/fabric/commit/2f88819dabd85f8f6fe33ae8bf5e06cf4fb156b4)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/24/2017, 10:42:56 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 1/24/2017, 1:03:01 PM<br><strong>GitHubMergedRevision</strong>: [9dbaeca6b439a2655af91e027c5804cb3f346c36](https://github.com/hyperledger-gerrit-archive/fabric/commit/9dbaeca6b439a2655af91e027c5804cb3f346c36)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/24/2017, 1:54:02 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Approved</strong>: 1/24/2017, 11:03:57 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Approved</strong>: 1/24/2017, 10:38:33 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 1/25/2017, 4:24:25 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Gari Singh<br><strong>Merged</strong>: 1/25/2017, 4:25:04 AM<br><br></blockquote>