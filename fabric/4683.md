<strong>Project</strong>: fabric</br><strong>Branch</strong>: master<br><strong>ID</strong>: 4683<br><strong>Subject</strong>: Detect phantom items during validation<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Assignee</strong>:<strong>Created</strong>: 1/22/2017, 1:20:31 PM<br><strong>LastUpdated</strong>: 1/27/2017, 11:04:01 AM<br><strong>CommitMessage</strong>:<br><pre>Detect phantom items during validation

https://jira.hyperledger.org/browse/FAB-1668

Phantom reads problem:
-----------------------------
If a transaction executes a key range query (say key_1 - key_n) leveldb
serves all the keys in the given range in sorted order of keys.
Between simulation and validation of a transaction, some other transaction
may insert one or more keys in this range. Now, this change cannot
be detected by merely checking the versions of the keys present in
the read-set of the transaction.
(though, this check can detect updates and deletes).

A serializable isolation level does not permit phantom reads.

Situations where the phantom reads may not be acceptable:
-----------------------------
 - A chaincode may take a decision based on aggregates of the results of
the range query such as min/max/avg/sum etc. This would be affected
if a new entry gets added to the range query results.

 - A chaincode may want to change all the marbles
owned by a specific user to blue in a tran `t1`. The chaincode may do so
by performing a range query to get all the marbles for the user and
change their color to blue. Now, if a new white marble get added to
the user's assets by an another transaction `t2`,
`t1` should be marked as invalid.

Solution in this change-set:
-----------------------------
For solving this, we can capture the details of the range query
(the query and it's results) during the simulation time and
re-execute the query during validation time and compare the results.
If the results (keys and versions) are still the same,
we can safely commit the transaction.

This changes set introduces
 - Structures for capturing the range query details in rwset
 - Detection of phantom items (insertion/deletion)
   that affect the results of the range query during validation
 - Mark the transactions that are affected by the phantom items
   as invalid to ensure serializability in the presence of range queries

Change-Id: I909841a0234c37795ad7a4ffcca8a9ebd9c9f994
Signed-off-by: manish <manish.sethi@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/22/2017, 1:20:31 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/22/2017, 1:21:27 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5525/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/22/2017, 2:03:26 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5525/ : SUCCESS</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 1/22/2017, 2:29:49 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Hi Manish, will help if you could sketch out how we should navigate this CR please ?</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/22/2017, 11:40:00 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Hi Murali,
I think that one of the ways to navigate could be in the following manner.

Simulation side:
- lockbasedtxmgr/helper.go - Additions for capturing the range-query-info during transaction simulation
- rwset/rwset_holder.go - Additions for holding the range-query-info during transaction simulation
- rwset/rwset.go - Additions for serializing range-query-info in the simulation results

Validation side:
- statedb/statedb.go - Addition of a range scan iterator that iterates over update batch (which is prepared at the committer - out of the write-sets of valid transactions)
- statebasedval/combined_iterator.go - Addition of a range scan iterator that iterates over combined contents of "committed snapshot of the db" + "update batch"
- statebasedval/state_based_validator.go - Additions for validating whether there has been any insertions/deletion/updates in the range since simulation

Thanks</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/23/2017, 12:08:43 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 12:09:37 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5532/</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/23/2017, 12:09:59 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Minor cleanup in patch set 2</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 12:42:21 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5532/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2017, 7:01:47 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Hi Manish, I think reviewers will struggle without more context.  In the commit message, could you summarize the phantom read problem and solution approach (text can be copied between jira and gerrit).  And I think more context is needed in the form of code comments, so that people know how the code elements contribute to the overall phantom read solution.  The part about combining state scan and prior trans in block is especially not intuitive and requires some comments for people to understand.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/23/2017, 1:08:27 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/23/2017, 1:10:10 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Added more description and comments in the code. Please let me know if some specific portion of the code requires more comments.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 1:12:18 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5550/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/23/2017, 1:51:59 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5550/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/23/2017, 11:18:02 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(10 comments)

Manish, I've highlighted where I think more comments will help.
Since the phantom check is such an unintuitive and complex topic, we really need to over-communicate the 'why' and 'how' in the code.
It is hard enough to understand when reviewing the code co-located in the changeset, it will be much much harder to understand the intent and logic by somebody looking through the code at a later point in time. Need to sprinkle some trigger words like 'phantom check' throughout to make it easy to associate the various code points with the intended function. 

Also I think we'll need to add a reason code for any validation failures later, so that clients have an idea of why the tran got invalidated.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 1:46:21 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 1:47:09 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5562/</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 1:49:26 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(10 comments)

Dave - I have added more comments in the code where you pointed out. Thanks for taking the pain to find these out.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 2:28:33 AM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5562/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 7:24:05 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)

Thanks for adding all the comments, much more understandable now.
I still think it would be helpful to include the words 'phantom check' in the comments related to phantom checking, and 'mvcc check' in the comments related to mvcc checking, as these are the key words that people will be familiar with and will immediately help them understand the intent.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 7:52:51 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 8:03:56 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 8:07:56 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 8:08:40 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 8:09:43 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Dave, I have added 'phantom check' at a few places in the comments in the code.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 8:11:33 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5570/</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 8:39:04 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 8:58:46 AM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5570/ : SUCCESS</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/24/2017, 12:23:17 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 12:27:12 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5592/</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/24/2017, 1:00:12 PM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+1</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/24/2017, 1:00:44 PM<br><strong>Message</strong>: <pre>Patch Set 6: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5592/ : SUCCESS</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 1/27/2017, 10:05:25 AM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+2

This CR is too large for most people to review.  I took a quick look through, ran the tests and read Dave's comments.  I'm going to +2 on that basis</pre><strong>Reviewer</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Reviewed</strong>: 1/27/2017, 10:22:33 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Ideally, the problem is described in the JIRA not the commit message which really should simply articulate what was changed and why (point to JIRA).</pre><strong>Reviewer</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Reviewed</strong>: 1/27/2017, 10:23:54 AM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+2

Agree with Gari's comment. I have made the point repeatedly that changes should be like 250 LOC or less, with only a few exceptions. This is not one of them, but the problem needs to be fixed.

Please don't continue to post ginormous changes. Thanks</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 1/27/2017, 10:23:56 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Christopher Ferris</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/27/2017, 10:27:56 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/877/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/27/2017, 11:04:01 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/877/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485109231<br><strong>GitHubRevision</strong>: [6185604e2fadd21cde725065f49af5afbbe4054f](https://github.com/hyperledger/fabric/commit/6185604e2fadd21cde725065f49af5afbbe4054f)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/22/2017, 2:03:26 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485148123<br><strong>GitHubRevision</strong>: [8cf8e8fe2fe3e7ae5b18bef2023fc0454a12b90b](https://github.com/hyperledger/fabric/commit/8cf8e8fe2fe3e7ae5b18bef2023fc0454a12b90b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 12:42:21 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485194907<br><strong>GitHubRevision</strong>: [ff685101763e503ba02901908ea11eac6f3b5574](https://github.com/hyperledger/fabric/commit/ff685101763e503ba02901908ea11eac6f3b5574)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/23/2017, 1:51:59 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485240381<br><strong>GitHubRevision</strong>: [cdc582dba2c4b4cd72657844b2e2de0e16f63988](https://github.com/hyperledger/fabric/commit/cdc582dba2c4b4cd72657844b2e2de0e16f63988)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/24/2017, 2:28:33 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485263320<br><strong>GitHubRevision</strong>: [e78aa705b6845203018d29089dd30d10a72f8a46](https://github.com/hyperledger/fabric/commit/e78aa705b6845203018d29089dd30d10a72f8a46)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/24/2017, 8:58:46 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 1485278597<br><strong>GitHubRevision</strong>: [163721769456ce74c8e5eac8720a3887b98d1c64](https://github.com/hyperledger/fabric/commit/163721769456ce74c8e5eac8720a3887b98d1c64)<br><br><strong>Approver</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Approved</strong>: 1/27/2017, 10:23:54 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Christopher Ferris<br><strong>Merged</strong>: 1/27/2017, 10:23:56 AM<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/24/2017, 1:00:44 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 1/27/2017, 10:05:25 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 1/24/2017, 1:00:12 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>