<strong>Project</strong>: fabric<br><strong>Branch</strong>: release<br><strong>ID</strong>: 11971<br><strong>Subject</strong>: FAB-5497 Create 1.0.1 patch for fabric<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 7/27/2017, 6:11:35 AM<br><strong>LastUpdated</strong>: 7/28/2017, 12:31:15 PM<br><strong>CommitMessage</strong>:<br><pre>FAB-5497 Create 1.0.1 patch for fabric

Single commit which squashes all the CRs
targetted for 1.0.1 based on FAB-5468

[FAB-5280] Fix git clone fabric-samples for Windows

This change expands the prerequisites documentation for Windows
to instruct users on setting git properly to ensure it handles
long filenames (required to successfully clone fabric-samples)
and end-of-lines (required for vagrant to work).

Change-Id: I8230f1980fedfb43d6e9cda8d2a2b4a65aa2434a
Signed-off-by: Arnaud J Le Hors <lehors@us.ibm.com>
(cherry picked from commit fc736ecc95703be2deaa41fb00fb8c9bc88fcdf7)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5293] Log buffer overflow events

This commit adds a logging event when a message is dropped
due to overflow of the connection buffer to a remote peer

In case of data blocks, the message that is printed is:
2017-07-16 09:12:55.442 EDT [gossip/comm] send -> DEBU 0c1 Buffer to 9.37.220.210:38346 overflown, dropping message GossipMessage: Channel: [121 97 99 111 118], nonce: 0, tag: CHAN_AND_ORG Block message: {Data: 107690 bytes, seq: 2771}, Envelope: 107714 bytes, Signature: 0 bytes

Change-Id: Ibce121be0721a8c8a73f7805a051a28c213d64ba
Signed-off-by: yacovm <yacovm@il.ibm.com>
(cherry picked from commit 28c8efd23cbb565232820855aead045d16bde88b)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

FAB-5331 Fix formatting of channel name

Historically, gossip keeps the channel name in messages
[]byte instead of in *string*s.

There is a String() method that formats complex messages
It would be beneficial to print instead a string,
for usability of log parsing.

Change-Id: I71351fa324d6e1ca583588dab089a9e887996f7f
Signed-off-by: yacovm <yacovm@il.ibm.com>
(cherry picked from commit ca167ce846372be568b1d693e67416fb1d6f13cd)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5309] Set mod_policy for new channel policies

The current configtxgen creates a channel creation tx with policies of
Reader/Writer/Admin, where these each do not have a mod_policy set.
This makes it difficult to change these policies, because the policy
does not exist.

It is possible through a roundabout way to change these policies (by
removing and re-adding the policy with a different mod_policy), but this
is certainly not a painless procedure and requires assistance of the
orderer org.

This CR updates to configtx processing to validate mod_policy values
such that they are valid names.  This means that the policy is not
empty, and if the policy is path specified (ie using '/'), that each
component of the path can be described as a valid config element (does
not violate the config element naming rules).

This CR additionally sets the mod_policy on the policies generated by
configtxgen to "Admins".

For users of the old v1.0.0 configtxgen, channel creation will fail with
an error for v1.0.1 orderers.  However, v1.0.1 configtxgen users will
have their transaction appropriately consumed by v1.0.0 orderers.

So in summary, upgrading configtxgen without fabric is okay.  Upgrading
fabric without configtxgen will cause breakage for new channel creation.

An additional bug in the configtxgen output was discovered which was not
setting a mod_policy on the anchor peers element.  There was also an
error in the bddtests which mimic the missing policies for the
application level policies.

Change-Id: Ic2bc120cfb6170f3e4e6cbeac5be145363a64861
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit 3a2dd8e97c38b6cbb1c7f6724847f0ea2180c2cd)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5340] Respect new max message size on reconf

Currently, the size filter only reads the max message size at
construction time.  This means that if this size is reconfigured, the
filter will not work correctly until restart.

This CR changes the sizefilter to re-read the size value each time.

Change-Id: Ib61c74dd8031fc61e107dc10ab9eba9d8b6b866e
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit 36b08c7446cc4c950a047930626a99b1ed938e08)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5341] Solo should respect batchtimeout reconf

Solo currently only reads the batch timeout at startup.  This is a
problem, because the batch timeout may be changed dynamically through a
reconfiguration transaction.

This CR simply causes solo to re-query the batch timeout from the config
each time the timer is initialized, rather than once at creation time.

Change-Id: I493fa4edddef40821336aa610ab242a3ffe97d26
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit b8176724736fe91dba5d3b1d3c22761918b157fd)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5339] Add missing nil check to extensions.go

There is a missing nil check, that might make the code
result in a null pointer panic.

For reference: IsDataMsg is:

func (m *GossipMessage) IsDataMsg() bool {
	return m.GetDataMsg() != nil
}

Change-Id: I5e20dee188e863b932312a7963f0ca73965c1457
Signed-off-by: yacovm <yacovm@il.ibm.com>
(cherry picked from commit 3cde835bb2edf82ce27c91ba2edd8bd8de4a0f54)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5365] Fix bad error in peer CLI Deliver

The peer CLI currently attempts to print the error status returned by
the orderer's Deliver gRPC method.  However, the log statement
inappropriately uses the '%T' modifier, and prints the type of the
status, not the actual status code inside it.  Consequently, all deliver
errors read the same uninformative error message:

    Got Status:*orderer.DeliverResponse_Status

This CR fixes this log statement to include the status code instead, and
additionally enhances the other error messages with pertitent
information.

Change-Id: I5a3e1dec574bfab178550cf67bc96a66f1896d5b
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit 22e1299566b9fabcea48d5c69ee3d1aa20530c07)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5342] spelling mistake in log: overflown

Change-Id: Iadf71f9c8b34716a8d785767e73ab154a249df78
Signed-off-by: Scott Zwierzynski <scottz@us.ibm.com>
(cherry picked from commit e3df7265a6cef56292fcf07863c6ef5f99a6273b)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5330] Prevent payload buffer overpopulation

The state transfer module receives blocks from either the orderer
or other peers, and puts them into a payload buffer for reordering so
they would enter the ledger in-order.

In some cases:
- If the peer joined late and it receives blocks from peers starting from
  index i where the ledger is missing indices [j, i] for some j<i
  and the rate of block reception from peers is very fast
- If the ledger is "stuck" (i.e file system full, etc.) and cannot advance

This buffer would overpopulate.

This commit addresses this, and adds a maximum distance constant
that if the difference between the ledger height and the sequence
of the block that is received is greater than this constant,
the block is dropped.

Change-Id: Ia1ba8966ea6d211c5d1b7ddd84a4fad34af797d4
Signed-off-by: yacovm <yacovm@il.ibm.com>
(cherry picked from commit ecda4c2d41275c8ed6e022b8b783ca1f5c55118e)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

FAB-5390 update chaintool URL

update chaintool version and URL to download chaintool binary
from nexus repository

Change-Id: I871eea4106a6e0c59a3a9660d475026d6d2e5481
Signed-off-by: rameshthoomu <rameshbabu.thoomu@gmail.com>
(cherry picked from commit 422302011ce1952b2651a26f57298a9444382282)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5413] Add initial execution in retry process.

Retry process should do an initial execution before starting
retry time ticker, otherwise there is a delay for each retry,
which accumulatively will cause slow start of kafka chain.

Change-Id: I9c2aafeb73e366b72d94e317088548e4754ee8c4
Signed-off-by: Jay Guo <guojiannan1101@gmail.com>
(cherry picked from commit 03afad8827561e1ea2bb5b930616d763266f19c9)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5418] Add prereq for npm on Windows

This change adds documentation on how to install the
Visual Studio C++ tools necessary to build the
Node.js native modules used in our samples.

Change-Id: I78277d937bcb5e697620b122061c6050d2570448
Signed-off-by: Arnaud J Le Hors <lehors@us.ibm.com>
(cherry picked from commit 7de02d272438d734d6ae3febbc5a1dbbd54166e5)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5421] Add configtxlator to fabric-tools image

Add configtxlator 2 fabric-tools docker image

Change-Id: I36bd4677a393216e05d866aedac8a8f7206a96f3
Signed-off-by: rickr <cr22rc@gmail.com>
(cherry picked from commit 210598f1d115ecae3d913b431c5a0c8957a446be)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

FAB-5422 make "Still have questions" prominent

Change-Id: I46ab194a467dd5633b132f63e77505fe33f60a62
Signed-off-by: Christopher Ferris <chrisfer@us.ibm.com>
(cherry picked from commit fbb84cc55f664db614126659bd70b3f2ac57fbcb)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5353]: Qualify sys. failure vs validation error

Currently as stated in [FAB-5353], there is no clear separation during
transaction validation during block commmit, between invalid transaction
and some system failure which migh lead to inability to validate the
transaction. For example db is down or file system is unavailable. This
might lead to inconsistency of the state accross peers, therefore this
commit takes care to distinguish between real case of invalid
transaction versus system failure, later the error propagated down to
the committer and forces peer to stop with panic, so admin will be able
to take manual control and fix the problem therefore preventing peer
state to diverge.

Change-Id: I384e16d37e2f2b0fe144d504f566e0b744a5095c
Signed-off-by: Artem Barger <bartem@il.ibm.com>
(cherry picked from commit 0cf4c35ab0e917819cfbba28d261e9528dc3b7a1)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

FAB-5154 update prereqs to Docker 17.03.0-ce

Change-Id: I34d23137eebfd9d5697061c1bf813b83543bcd05
Signed-off-by: Christopher Ferris <chrisfer@us.ibm.com>
(cherry picked from commit 15c3bbece8ca893847eac3c7d334e8b2d0d589b2)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

FAB-5422 fix syntax error

Change-Id: Ied54138605d42b2c7687dc0f80a5a0eb3befca34
Signed-off-by: Christopher Ferris <chrisfer@us.ibm.com>
(cherry picked from commit f80789d5540698813fe7e54f021202bd0e402199)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5446] Fix orderer metadata local test

The orderer metadata test only works if the development environment is
setup to set common.Version, because if this is not set, the version is
returned as "development version" and compared to the unset empty
string.

This is very annoying when trying to do development locally as this test
always fails.

This CR simply overrides the common.Version value for the purpose of
testing this package.

Change-Id: I6bc7a1de5a2730f4dd3fe17f1e5c7ff6bd81d4af
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit 7d59d5a757d427f8c9db4d69ed33762ffe0bf27c)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5391]Prevent concurrent invokes launching cc cont

This CR prevents concurrent invokes from launching a chaincode
container at the same time (e.g. during performance testing). The first
invoke should succeed (and launch the container) while subsequent
invokes should fail until the container has finished launching.

Note: This does not change any behavior as subsequent invokes should
have failed but it now sends a clear error message that the chaincode
container is already launching.

Change-Id: Ic1772a5f25dd0e4c34278e6e7bdb8507f16269c8
Signed-off-by: Will Lahti <wtlahti@us.ibm.com>
(cherry picked from commit 2232d0ec348c81004e36ebbb1e1ab4d61f24b2cc)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5459] Recompute configmap instead of updating

The configtx validation code works by transforming the ConfigGroup tree
structure into a map, where each config element has a fully qualified
key like:

  [Groups] /Channel/Application

or

  [Policy] /Channel/Application/Readers

This flattened structure makes it easier to check which elements have
been modified, as the maps may simply be iterated over, rather than
walking the config tree.

After applying a config update, the current config map is copied, and
the elements which were updated are overlayed onto the old config.  This
map is then converted back into a tree structure and serialized to be
the new config tree.

The current code adopts the updated config map as the current config
map.  However, this produces the bug described in 5459.  Because the
updated config map is the overlay of the new config onto the old
config, the updated config may contain orphaned nodes which appear in
the map, but which do not appear in the config tree.

Consequently, when a subsequent update arrives, it is validated not
only against the current config, but also against the orphaned nodes
which are still in the updated config map.

This CR changes the logic to discard the updated config map (which may
contain this orphaned nodes) and instead has the config map recomputed
every time a new config is adopted.  This is more obviously
deterministic and mimics the way a new ordering node would initialize
the config after being restarted.

Note: There is no accompanying test case with this.  I had originally
written a test case which demonstrated that nodes were orphaned in the
updated config.  However, this is expected and not a useful test case.
Similarly, forcing the update config map to have updated nodes, then
testing that that map is not adopted does not provide a valuable test
case.

So, instead of a test, this CR opts for some code comments and this
lengthly commit explaining the change.

Change-Id: Idc847cd5e237531e4a8b978f3465e30a909eb94f
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
(cherry picked from commit 6eab9cf6bda377943d7cb09adfe133778d0d1222)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5458] wrong type check in validator

Validator is sending peer.TxValidationCode_INVALID_OTHER_REASON instead of
peer.TxValidationCode_ENDORSEMENT_POLICY_FAILURE due to a wrong type check.

Added UT to cover the switch and ensure correct tx flag been assigned.

Change-Id: I7abe8828323780d527b24905f54d9a06e5f70b4e
Signed-off-by: Srinivasan Muralidharan <muralisr@us.ibm.com>
Signed-off-by: Artem Barger <bartem@il.ibm.com>
(cherry picked from commit e7b20bd3afc424bcd8006ed47123226f4849b471)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>

[FAB-5329] Able to instantiate on a taken chaincode ID

This fix appends a hash of the Docker image name to the image name
to ensure a chaincode with different capitalization does not override
the container of an already instantiated chaincode. This problem was
introduced by the need to convert all Docker image names to lowercase.
The Docker container name will retain its capitalization as that
restriction only applies to the image name.

Change-Id: I854f80b2f0e0269d9bbc60725f82b7e5a804b6fd
Signed-off-by: Will Lahti <wtlahti@us.ibm.com>
(cherry picked from commit 36e514032702802633b820bab99f91aebcc8fe6e)
Signed-off-by: Gari Singh <gari.r.singh@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 7/27/2017, 6:11:35 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Will Lahti - wtlahti@us.ibm.com<br><strong>Reviewed</strong>: 7/27/2017, 8:13:03 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+1</pre><strong>Reviewer</strong>: Jessica Wagantall - jwagantall@linuxfoundation.org<br><strong>Reviewed</strong>: 7/27/2017, 10:58:17 AM<br><strong>Message</strong>: <pre>Patch Set 1:

reverify</pre><strong>Reviewer</strong>: Jessica Wagantall - jwagantall@linuxfoundation.org<br><strong>Reviewed</strong>: 7/27/2017, 11:09:48 AM<br><strong>Message</strong>: <pre>Patch Set 1:

reverify</pre><strong>Reviewer</strong>: Jessica Wagantall - jwagantall@linuxfoundation.org<br><strong>Reviewed</strong>: 7/27/2017, 11:13:08 AM<br><strong>Message</strong>: <pre>Patch Set 1:

reverify</pre><strong>Reviewer</strong>: Jessica Wagantall - jwagantall@linuxfoundation.org<br><strong>Reviewed</strong>: 7/27/2017, 11:21:19 AM<br><strong>Message</strong>: <pre>Patch Set 1:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 12:23:33 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14602/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 12:24:56 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6101/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 12:25:09 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8646/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 12:35:33 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10251/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 2:24:40 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8646/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8646

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14602/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14602

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6101/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6101

https://jenkins.hyperledger.org/job/fabric-verify-z/10251/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10251</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 3:42:26 PM<br><strong>Message</strong>: <pre>Patch Set 1: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8664/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 3:54:35 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14602/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14602

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6101/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6101

https://jenkins.hyperledger.org/job/fabric-verify-z/10251/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10251

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8664/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8664</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 7/28/2017, 12:31:15 PM<br><strong>Message</strong>: <pre>Abandoned

New patch submitted</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Arnaud J Le Hors - lehors@us.ibm.com<br><strong>Uploader</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Created</strong>: 7/27/2017, 6:11:35 AM<br><strong>UnmergedRevision</strong>: 1d12ecb79a393a755f2f8e8d92e707e80edbfab9<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/27/2017, 3:54:35 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Will Lahti - wtlahti@us.ibm.com<br><strong>Approved</strong>: 7/27/2017, 8:13:03 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>