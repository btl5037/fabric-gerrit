<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 31007<br><strong>Subject</strong>: [FAB-15194] Refactor peer NewDeliverEventsServer<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 4/18/2019, 9:34:22 AM<br><strong>LastUpdated</strong>: 4/29/2019, 6:36:44 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-15194] Refactor peer NewDeliverEventsServer

Removed NewDeliverEventsServer Server constructor,
moved the logic one level up, with Server exported.

Removed config value timeWindow check in constructor
instead check all config values in config.go when
its loaded in the first place.

Change-Id: Ic549247cf63b44b734cf137a509f24fb0d858663
Signed-off-by: Chongxin Luo <Chongxin.Luo@ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Reviewed</strong>: 4/18/2019, 9:34:22 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:36:06 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13159/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:36:32 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:41:51 AM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:42:37 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13159/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/13159</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:44:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8271/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:44:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/11598/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:44:53 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 9:44:56 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 10:14:25 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 10:23:18 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/18/2019, 10:23:58 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8271/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/8271

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/11598/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/11598</pre><strong>Reviewer</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Reviewed</strong>: 4/18/2019, 1:06:48 PM<br><strong>Message</strong>: <pre>Patch Set 2: Patch Set 1 was rebased</pre><strong>Reviewer</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Reviewed</strong>: 4/18/2019, 2:24:21 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3: Patch Set 2 was rebased.</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/25/2019, 10:47:20 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4: Patch Set 3 was rebased.</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 2:18:30 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2

(3 comments)

LGTM - opened a JIRA to rename Server to DeliverServer: FAB-15302

On top of the CR chain we want to rename DH to something more descriptive. I added a comment to JIRA as a reminder.</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 2:40:07 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5: Patch Set 4 was rebased.</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 2:42:15 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(2 comments)</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 4:17:14 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6: Patch Set 5 was rebased.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 5:40:03 PM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 5:40:07 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Yacov Manevich</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/29/2019, 5:42:28 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6570/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/29/2019, 5:42:30 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5255/ (2/2)</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 4/29/2019, 5:58:56 PM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/29/2019, 6:36:44 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6570/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/6570

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5255/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/5255</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Created</strong>: 4/18/2019, 9:34:22 AM<br><strong>UnmergedRevision</strong>: [44d150d55d82fdf7b70c58b2bf357ec294c3ec95](https://github.com/hyperledger-gerrit-archive/fabric/commit/44d150d55d82fdf7b70c58b2bf357ec294c3ec95)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Created</strong>: 4/18/2019, 1:06:48 PM<br><strong>UnmergedRevision</strong>: [dd3de3425f35e7faf8db770607a7e54c4833462d](https://github.com/hyperledger-gerrit-archive/fabric/commit/dd3de3425f35e7faf8db770607a7e54c4833462d)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Created</strong>: 4/18/2019, 2:24:21 PM<br><strong>UnmergedRevision</strong>: [e631a98e7cd9111faecfbba98d2a57b6fba59a32](https://github.com/hyperledger-gerrit-archive/fabric/commit/e631a98e7cd9111faecfbba98d2a57b6fba59a32)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Created</strong>: 4/25/2019, 10:47:20 AM<br><strong>UnmergedRevision</strong>: [a1ad30efee18eeab17bb5b01f34760384c8124de](https://github.com/hyperledger-gerrit-archive/fabric/commit/a1ad30efee18eeab17bb5b01f34760384c8124de)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 4/29/2019, 2:18:30 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/a1ad30efee18eeab17bb5b01f34760384c8124de/core/peer/deliverevents.go#L30)<br><strong>Comment</strong>: <pre>This should probably be renamed in a separate CR and JIRA...

Right now this is referenced as peer.Server but the real name is actually in the comment: DeliverServer.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/a1ad30efee18eeab17bb5b01f34760384c8124de/core/peer/deliverevents.go#L30)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/a1ad30efee18eeab17bb5b01f34760384c8124de/core/peer/deliverevents.go#L31)<br><strong>Comment</strong>: <pre>Two things:

1.  We should consider if we want this to be concrete type or an interface.
1a. We only call Handle - and that accepts a context and a deliver.Server. That sure seems like an interface...
2.  We really should rename the field. As a dependency injection field, it's name isn't very descriptive and is a bit hard to grok.

We can do this on top if we decide to.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/a1ad30efee18eeab17bb5b01f34760384c8124de/core/peer/deliverevents.go#L31)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [internal/peer/node/start.go#L294](https://github.com/hyperledger-gerrit-archive/fabric/blob/a1ad30efee18eeab17bb5b01f34760384c8124de/internal/peer/node/start.go#L294)<br><strong>Comment</strong>: <pre>for long lines like this, it's better to break them at the commas...

no action needed</pre></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Created</strong>: 4/29/2019, 2:40:07 PM<br><strong>UnmergedRevision</strong>: [540176c5f0f08a311a4f4d1c657046cc4f429443](https://github.com/hyperledger-gerrit-archive/fabric/commit/540176c5f0f08a311a4f4d1c657046cc4f429443)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 4/29/2019, 2:18:30 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chongxin Luo - dereckluo@gmail.com<br><strong>Uploader</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Created</strong>: 4/29/2019, 4:17:14 PM<br><strong>GitHubMergedRevision</strong>: [e2fc1b4d46a104a935e52066faf119e7909d378b](https://github.com/hyperledger-gerrit-archive/fabric/commit/e2fc1b4d46a104a935e52066faf119e7909d378b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 9:41:51 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:23:18 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/18/2019, 10:14:25 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 4/29/2019, 5:40:03 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Yacov Manevich<br><strong>Merged</strong>: 4/29/2019, 5:40:07 PM<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 4/29/2019, 2:18:30 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/e2fc1b4d46a104a935e52066faf119e7909d378b/core/peer/deliverevents.go#L31)<br><strong>Comment</strong>: <pre>now it just looks like Diffie-Hellman :(</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/peer/deliverevents.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/e2fc1b4d46a104a935e52066faf119e7909d378b/core/peer/deliverevents.go#L31)<br><strong>Comment</strong>: <pre>Should be renamed on top. I commented on the name too...</pre></blockquote>