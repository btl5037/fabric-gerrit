<strong>Project</strong>: fabric</br><strong>Branch</strong>: master<br><strong>ID</strong>: 32439<br><strong>Subject</strong>: reset: Allow all ledgers to reset to genesis block<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Assignee</strong>:<strong>Created</strong>: 7/22/2019, 2:50:46 PM<br><strong>LastUpdated</strong>: 7/25/2019, 11:35:50 AM<br><strong>CommitMessage</strong>:<br><pre>reset: Allow all ledgers to reset to genesis block

This CR adds a command "peer node reset"
This command drops
 - statedb if LevelDB is being used for the state db
 - historydb if being used
 - blockstorage indexes
 - all the block files other the blockfile number zero
In addition, this truncates the blockfile number zero
to the offset where the genesis block finishes.

In other words, ledger rolls back to a state where it has
just been created as an effect of joining the channel.

Private data blockstore is not dropped because if this gets
dropped everywhere then the private data will be lost forever.

Before trucating the block file, it takes a backup of
the genesis block in a file '__backupGenesisBlockBytes' in the
same directory. It also produces another file __preResetHeight
that contains the max(blockstoreHeight,
height in __preResetHeight - if exists)

This command is intended to be fail-safe in the sense that
this should be able to be executed again if a failure or
system crash is to happen while this command is running.

Important note: if a network is using the pvtData feature
and needs to apply this command, this should be not be applied
on all the peers that share a collection, at the same time.
Further, it should be applied on the peers in select
batches such that it is appliead on the later batch peers
only after the earlier peers have reached the original block
height.

FAB-14808 #done

Change-Id: Ibffd2605899ecab7e94106dfea371a9b450ba33a
Signed-off-by: manish <manish.sethi@gmail.com>
Signed-off-by: senthil <cendhu@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Reviewed</strong>: 7/22/2019, 2:50:46 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 2:50:55 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/15598/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 2:51:26 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 2:58:35 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 2:59:27 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/15598/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/15598</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 3:01:11 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/10381/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 3:01:46 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 3:02:08 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/13826/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 3:02:36 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 3:25:16 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 4:29:01 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/22/2019, 4:29:52 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/10381/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/10381

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/13826/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/13826</pre><strong>Reviewer</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Reviewed</strong>: 7/23/2019, 8:35:47 AM<br><strong>Message</strong>: <pre>Patch Set 2: Patch Set 1 was rebased</pre><strong>Reviewer</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Reviewed</strong>: 7/23/2019, 11:05:10 AM<br><strong>Message</strong>: <pre>Patch Set 3: Commit message was updated.</pre><strong>Reviewer</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Reviewed</strong>: 7/25/2019, 11:35:50 AM<br><strong>Message</strong>: <pre>Abandoned</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Created</strong>: 1563821446<br><strong>UnmergedRevision</strong>: ce2b12d4b9610938d4519218eeda5415082870cd<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 4:29:01 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 3:25:16 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Created</strong>: 1563885347<br><strong>UnmergedRevision</strong>: 980ee15a6e80ea1a9a4b44a957b75ded51903ab2<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 4:29:01 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 3:25:16 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Senthilnathan N - cendhu@gmail.com<br><strong>Created</strong>: 1563894310<br><strong>UnmergedRevision</strong>: 5d924f9a29b635d3997bd3255ef80121da392325<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 2:58:35 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 4:29:01 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/22/2019, 3:25:16 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br></blockquote>