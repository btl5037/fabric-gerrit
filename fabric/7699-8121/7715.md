<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 7715<br><strong>Subject</strong>: [FAB-2960] Transaction Mgr changes batch optimizations<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 4/5/2017, 11:39:04 AM<br><strong>LastUpdated</strong>: 8/20/2017, 2:51:25 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-2960] Transaction Mgr changes batch optimizations

This is change is part of FAB-2725 CouchDB optimizations

Interactions with CouchDB are currently done individually.
Need to switch to using bulk operations to get optimal performance
from CouchDB. Need to performance test and stress test.

This change implements all changes needed by the commit phase to use
bulk operations in CouchDB.

A subsequent change will implement validation bulk read and caching
of versions and revisions for CouchDB.

Subsequent changes will also be added to retry errors encountered by
the bulk update operation and a configuration setting to limit the
size of the bulk update by number of update documents.

- Add new interface to statedb for bulk operations, the new operations
will only be implemented for databases that can support bulk operations
(only CouchDB)

type BulkOptimizable interface {
	LoadCommittedVersions(keys []*CompositeKey)
	ClearCachedVersions()
}

LoadCommittedVersions will bulk load version and revision numbers into
cache based on the document ID.  Documents missing a version or revision
will be added to the cache with a nil value.

- Add GetVersion method to VersionedDB to enhance batch
validation of batches

GetVersion(namespace string, key string) (*version.Height, error)

- Implement the GetVersion method for CouchDB and goleveldb.  The goleveldb
implementation will be similar to GetState, except it will return the
version.  CouchDB implementation will attempt a cache lookup, then fall
back to a database read if not found.

- Enhance the ApplyUpdates method for CouchDB to incorporate the
ability to retrieve all revision information required for bulk
updates and deletes for CouchDB.

Change-Id: I65f8525a7a13b1ad7b49fda0e357b9a406fba79d
Signed-off-by: Chris Elder <chris.elder@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/5/2017, 11:39:04 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/5/2017, 11:40:41 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9240/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/5/2017, 11:41:19 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/777/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/5/2017, 11:41:53 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3310/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/5/2017, 12:50:06 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9240/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/777/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3310/ : SUCCESS</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/6/2017, 8:47:17 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/6/2017, 9:40:55 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/6/2017, 10:57:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/6/2017, 1:06:55 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 1:08:19 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9281/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 1:08:55 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/818/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 1:09:02 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3351/ (3/3)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/6/2017, 1:22:32 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Manish,  I have backed out changes to the state_based_validator.   This change should be ready for you to take over.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/6/2017, 1:51:08 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+1</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/6/2017, 1:52:30 PM<br><strong>Message</strong>: <pre>Patch Set 2:

You may just want to remove last bullet from the commit message.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 2:20:58 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9281/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/818/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3351/ : SUCCESS</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/6/2017, 3:15:50 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 3:17:22 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9285/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 3:17:37 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/822/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 3:17:55 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3355/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/6/2017, 4:54:40 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9285/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/822/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3355/ : SUCCESS</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/7/2017, 5:23:14 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/8/2017, 2:54:41 PM<br><strong>Message</strong>: <pre>Abandoned</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/8/2017, 2:56:08 PM<br><strong>Message</strong>: <pre>Restored</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/8/2017, 3:09:56 PM<br><strong>Message</strong>: <pre>Patch Set 4: Patch Set 3 was rebased</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 3:11:25 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9344/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 3:11:53 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/881/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 3:12:30 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3414/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 4:34:28 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9344/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/881/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3414/ : SUCCESS</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/8/2017, 5:47:36 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 5:48:46 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9349/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 5:50:05 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/886/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 5:50:48 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3419/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 6:45:47 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9349/ : FAILURE

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/886/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3419/ : SUCCESS</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/8/2017, 9:39:47 PM<br><strong>Message</strong>: <pre>Patch Set 5:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 9:41:07 PM<br><strong>Message</strong>: <pre>Patch Set 5: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9353/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 9:41:43 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/890/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 9:42:27 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3423/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/8/2017, 10:35:17 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9353/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/890/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3423/ : SUCCESS</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 4/9/2017, 8:19:23 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/9/2017, 8:42:45 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/9/2017, 12:04:46 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review-1

(6 comments)

This change is not intuitive.  Please add a very clear commit message explaining the intended logic, what is delivered here, versus what will be delivered in subsequent changesets in order for the end-to-end logic to be complete.</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/9/2017, 4:52:40 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(5 comments)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/9/2017, 5:10:37 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/9/2017, 5:11:04 PM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/9/2017, 5:12:09 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9371/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/9/2017, 5:12:47 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/908/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/9/2017, 5:13:25 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3441/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/9/2017, 6:07:46 PM<br><strong>Message</strong>: <pre>Patch Set 6: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9371/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/908/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3441/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 7:33:23 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 7:37:19 AM<br><strong>Message</strong>: <pre>Patch Set 6:

About the commit message:
"This change implements all changes needed by the validator. One final change will be needed to change the validator to use GetVersion instead of GetState."

Actually this change doesn't implement validator phase, it implements commit phase. Isn't all the validator logic to scan the read sets and retrieve the versions in bulk and populate the version/revision cache coming in a subsequent change?  This is the kind of logic overview I was looking for.</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 9:55:16 AM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 9:55:37 AM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 9:56:49 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9398/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 9:57:40 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/935/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 9:58:38 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3468/ (3/3)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 11:01:30 AM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)

Looks good, I tested end-to-end and confirmed the APIs work as I would expect.  Just one small comment remaining (could be done in a subsequent change set, your call).</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 11:12:08 AM<br><strong>Message</strong>: <pre>Patch Set 7: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9398/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/935/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3468/ : SUCCESS</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 11:50:44 AM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 11:51:50 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9401/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 11:52:19 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/938/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 11:52:53 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3471/ (3/3)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 11:53:28 AM<br><strong>Message</strong>: <pre>Patch Set 8:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 12:46:01 PM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+1</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 1:11:10 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9401/ : FAILURE

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/938/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3471/ : SUCCESS</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/10/2017, 1:38:08 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 2:00:26 PM<br><strong>Message</strong>: <pre>Patch Set 8:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 2:02:10 PM<br><strong>Message</strong>: <pre>Patch Set 8: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9402/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 2:02:30 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/939/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 2:02:55 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3472/ (3/3)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 4/10/2017, 2:03:05 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/10/2017, 2:32:23 PM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+1</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/10/2017, 3:32:00 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9402/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/939/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3472/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/11/2017, 7:58:22 AM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review-1

We may defer anything that requires significant refactoring until post-v1. I will -1 Part4 (committer) for now.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 5/3/2017, 6:48:13 AM<br><strong>Message</strong>: <pre>Patch Set 8:

This item has been deferred from v1.</pre><strong>Reviewer</strong>: Christopher Ferris - chris.ferris@gmail.com<br><strong>Reviewed</strong>: 6/2/2017, 8:30:38 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Chris, it would help if you could keep a local branch of this change and abandon the CR until post 1.0 so we aren't carrying a lot of extra stuff in the backlog.We can resubmit post 1.0  Thanks</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 6/12/2017, 7:53:50 AM<br><strong>Message</strong>: <pre>Abandoned

Abandoning for v1.</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 7/26/2017, 1:29:56 PM<br><strong>Message</strong>: <pre>Restored</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 7/26/2017, 1:30:45 PM<br><strong>Message</strong>: <pre>Patch Set 9: Patch Set 8 was rebased</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 1:30:56 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10218/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 1:32:21 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14568/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 1:32:32 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6069/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 1:35:55 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8614/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 2:23:23 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14568/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14568

https://jenkins.hyperledger.org/job/fabric-verify-z/10218/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10218

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6069/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6069

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8614/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8614</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 7/26/2017, 3:02:43 PM<br><strong>Message</strong>: <pre>Patch Set 9:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 3:02:50 PM<br><strong>Message</strong>: <pre>Patch Set 9: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10223/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 3:04:08 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14572/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 3:04:45 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6072/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 3:07:16 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8617/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 3:53:06 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14572/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14572

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8617/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8617

https://jenkins.hyperledger.org/job/fabric-verify-z/10223/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10223

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6072/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6072</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 7/26/2017, 5:27:42 PM<br><strong>Message</strong>: <pre>Patch Set 9:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 5:27:51 PM<br><strong>Message</strong>: <pre>Patch Set 9: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10227/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 5:29:09 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14576/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 5:29:45 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6076/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 5:32:11 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8621/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/26/2017, 6:32:54 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6076/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6076

https://jenkins.hyperledger.org/job/fabric-verify-z/10227/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10227

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8621/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8621

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14576/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14576</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 1:23:28 PM<br><strong>Message</strong>: <pre>Patch Set 9: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14613/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 1:24:31 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6113/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 1:31:37 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10262/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 1:32:37 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8658/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 3:04:31 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8658/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8658

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14613/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14613

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6113/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6113

https://jenkins.hyperledger.org/job/fabric-verify-z/10262/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10262</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 3:42:19 PM<br><strong>Message</strong>: <pre>Patch Set 9: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8663/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 7/27/2017, 3:57:15 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14613/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14613

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6113/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6113

https://jenkins.hyperledger.org/job/fabric-verify-z/10262/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10262

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8663/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8663</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 8/1/2017, 6:08:08 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review-1

(2 comments)

Just want to make sure that my comment is correct and if it is that we have a plan in a later state to address</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 8/2/2017, 8:17:07 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review-1

(2 comments)

Chris, can you clarify commit message to provide broader context.  It says part 4 of 4, and then goes on to say subsequent commits are coming. And does "implements all changes needed by the commit phase" mean for couchdb layer only or entire ledger stack?  And does "commit phase" mean commit only or both validation/commit?

As mentioned in the code comments, need to highlight error handling and retry intention, and provide link to any follow-on Jira items.</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 8/2/2017, 12:24:07 PM<br><strong>Message</strong>: <pre>Patch Set 9:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 8/2/2017, 1:01:59 PM<br><strong>Message</strong>: <pre>Patch Set 9:

(1 comment)</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 8/3/2017, 4:07:27 AM<br><strong>Message</strong>: <pre>Patch Set 9:

> (1 comment)

Yep.  Was just double-checking on this</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 8/3/2017, 9:04:18 AM<br><strong>Message</strong>: <pre>Uploaded patch set 10.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 9:04:25 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10488/ (1/4)</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 8/3/2017, 9:04:51 AM<br><strong>Message</strong>: <pre>Patch Set 10:

(1 comment)

New patch uploaded with retry logic implemented.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 9:06:21 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8880/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 9:06:24 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6393/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 9:07:21 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14850/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 9:55:57 AM<br><strong>Message</strong>: <pre>Patch Set 10: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8880/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8880

https://jenkins.hyperledger.org/job/fabric-verify-z/10488/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10488

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6393/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6393

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14850/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14850</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 8/3/2017, 1:03:43 PM<br><strong>Message</strong>: <pre>Uploaded patch set 11: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 1:03:52 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10498/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 1:04:30 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8890/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 1:05:00 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6403/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 1:07:11 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14860/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/3/2017, 1:56:16 PM<br><strong>Message</strong>: <pre>Patch Set 11: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8890/ : FAILURE

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8890

https://jenkins.hyperledger.org/job/fabric-verify-z/10498/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10498

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6403/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6403

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14860/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14860</pre><strong>Reviewer</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Reviewed</strong>: 8/4/2017, 10:04:10 AM<br><strong>Message</strong>: <pre>Patch Set 11:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/4/2017, 10:04:21 AM<br><strong>Message</strong>: <pre>Patch Set 11: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/10539/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/4/2017, 10:05:10 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8929/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/4/2017, 10:06:01 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6442/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/4/2017, 10:06:40 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14900/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/4/2017, 10:55:42 AM<br><strong>Message</strong>: <pre>Patch Set 11: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/8929/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/8929

https://jenkins.hyperledger.org/job/fabric-verify-z/10539/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/10539

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/6442/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/6442

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/14900/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/14900</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 8/4/2017, 1:55:41 PM<br><strong>Message</strong>: <pre>Patch Set 11:

OK.  I'm good.  Will wait for Dave or Manish to double-check</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 8/7/2017, 4:57:57 AM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review+2</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 8/14/2017, 6:42:04 PM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review+1

(1 comment)

Revisited this CR. Have a very minor comment but I am fine with merging this as is from the functionality point of view. 

However, My biggest concern is that though a new functionality has been added but this lacks the associated unit-tests. The tests for functions `LoadCommittedVersions` and `getVersion` should be added. Also, a special test for `ApplyUpdates` under the circumstance where the cache has already a few entries but not for all the updates (i.e., simulating blind writes scenario) would be desired.
+1 for now so that we do not miss out on these tests. If you want to submit the tests in a separate CR, please open a jira and refer that here and will change it to +2.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2017, 2:50:46 PM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review+2

(1 comment)

The function looks good and works end-to-end. I have opened follow-on Jira items for some non-functional improvements to come in subsequent changesets:
FAB-5853 - more unit tests
FAB-5854 - more unit tests
FAB-5855 - minor improvements
FAB-5856 - clear cache improvements
Since this is an essential perf improvement for couchdb that needs to start getting system tested, I will +2 since we have follow-on Jira items in place.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2017, 2:51:07 PM<br><strong>Message</strong>: <pre>Patch Set 11:

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2017, 2:51:25 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by David Enyeart</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/5/2017, 11:39:04 AM<br><strong>UnmergedRevision</strong>: [9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79](https://github.com/hyperledger-gerrit-archive/fabric/commit/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/5/2017, 12:50:06 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L451](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L451)<br><strong>Comment</strong>: <pre>These last two lines can be removed. You have already added the data to the maps obtained from the `vdb.committedData` (the first two lines of this function)</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L451](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L451)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65)<br><strong>Comment</strong>: <pre>This line should be shifted in the function `ValidateAndPrepareBatch`. Also, see relevant comments at line 164</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65)<br><strong>Comment</strong>: <pre>I assume you mean to move this before line 100, 
"	for txIndex, envBytes := range block.Data.Data {"
in order to have the cache populated before the validation steps.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L65)<br><strong>Comment</strong>: <pre>Logically yes. But better to reuse some of the code. This change can be made starting line 124. `envBytes` at that line should simply extract txRWSet in the outer loop. It may require signature change in the function `validateEndorserTX` to take txRWSet instead of envBytes.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164)<br><strong>Comment</strong>: <pre>this function should be intended to be invoked at the level of block not at the level of a transaction. Hence, this should take []*rwsetutil.TxRwSet</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164)<br><strong>Comment</strong>: <pre>I don't see a way to build up the array of TxRwSet from the batch without parsing and iterating.  Since this is specific for the BulkOptimizable interface, would it be better to pass the batch into the function, parse and iterate?</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164](https://github.com/hyperledger-gerrit-archive/fabric/blob/9f02f97ba1cd37e2fcac1efe850e39a5f1ecdf79/core/ledger/kvledger/txmgmt/validator/statebasedval/state_based_validator.go#L164)<br><strong>Comment</strong>: <pre>Yes, you are right about iterating and parsing. No, it does not make sense to pass this to BulkOptimizable. Because, in the common code, we anyway need to iterate and extract rwset for individual tx validation. We just need to restructure the code a bit such that we first build an array of txrwset and use the same array for loading the cache as well as for validation of individual tx.</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/6/2017, 1:06:55 PM<br><strong>UnmergedRevision</strong>: [2e12bb5c3c9e4af1ae4d088c6a7369edc23ff464](https://github.com/hyperledger-gerrit-archive/fabric/commit/2e12bb5c3c9e4af1ae4d088c6a7369edc23ff464)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/6/2017, 2:20:58 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 4/6/2017, 1:51:08 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/6/2017, 3:15:50 PM<br><strong>UnmergedRevision</strong>: [91ec493b6670e459801a1f22249f7a04f3fe8b0c](https://github.com/hyperledger-gerrit-archive/fabric/commit/91ec493b6670e459801a1f22249f7a04f3fe8b0c)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/6/2017, 4:54:40 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 4/7/2017, 5:23:14 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/8/2017, 3:09:56 PM<br><strong>UnmergedRevision</strong>: [ef97dbcc9ae1a2224f9ef9f49de662036e4e0952](https://github.com/hyperledger-gerrit-archive/fabric/commit/ef97dbcc9ae1a2224f9ef9f49de662036e4e0952)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/8/2017, 4:34:28 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/8/2017, 5:47:36 PM<br><strong>UnmergedRevision</strong>: [2f1ebdee078900084233a3205fbc6be95129f0ce](https://github.com/hyperledger-gerrit-archive/fabric/commit/2f1ebdee078900084233a3205fbc6be95129f0ce)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/8/2017, 10:35:17 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 4/9/2017, 12:04:46 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L174](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L174)<br><strong>Comment</strong>: <pre>Can't you just use versionData.Version as string?  Why do you have to Sprintf it?</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L174](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L174)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L304](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L304)<br><strong>Comment</strong>: <pre>Describe the motivation and algorithm here since it is not obvious. e.g. we need the revision number for couchdb updates, we may have the revision number in the cache already, if its not in the cache is is 'missing', add it to the missing list so what we can fetch them in bulk from couchdb.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L304](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L304)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L327](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L327)<br><strong>Comment</strong>: <pre>"Applying" is not the correct word. "Retrieving keys with unknown revision numbers".</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L327](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L327)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L344](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L344)<br><strong>Comment</strong>: <pre>For new document creates the revision will be nil correct?  I assume those will not be found in cache (rather than found in cache with nil revision).  Regardless, state the assumption here.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L344](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L344)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397)<br><strong>Comment</strong>: <pre>So don't we end up with the case that we've updated some documents and failed on some?  And here we return when you find the first doc error?</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397)<br><strong>Comment</strong>: <pre>If one of the batch items fails we'll have to retry the batch (updates are idempotent). 
Similar to the current one-by-one approach if we get a failure halfway through processing the block updates.  We have to do some retries and then eventually return error (which results in a peer panic since peer cant proceed).</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397)<br><strong>Comment</strong>: <pre>Thinking more about this.  Typically the retries are pushed down to the couchdb client layer.  But in this case partial success will return 201 (Created) and therefore no retries at the couchdb client layer.  We typically retry due to concern about the couchdb http connection. In this case the couchdb http connection is ok, we just got partial success within couchdb. The retry will most likely have the same problem.  That being said, it is technically possible for couchdb to have a intermittent problem, so a retry is probably still a good idea here.
Chris, I'd suggest add a TODO comment here that retry logic will be finalized in FAB-2709 to enhance couchdb retry logic across the board.  That needs to be done in the next two weeks.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L397)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L478](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L478)<br><strong>Comment</strong>: <pre>Not obvious what this does and what the return JSON is for.  Need a better function name and comment.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L478](https://github.com/hyperledger-gerrit-archive/fabric/blob/2f1ebdee078900084233a3205fbc6be95129f0ce/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L478)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/9/2017, 5:10:37 PM<br><strong>UnmergedRevision</strong>: [07c0d420717b56f2ce79ddb3e027b731181d0fac](https://github.com/hyperledger-gerrit-archive/fabric/commit/07c0d420717b56f2ce79ddb3e027b731181d0fac)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/9/2017, 6:07:46 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L530](https://github.com/hyperledger-gerrit-archive/fabric/blob/07c0d420717b56f2ce79ddb3e027b731181d0fac/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L530)<br><strong>Comment</strong>: <pre>Typo, no big deal but might as well fix since you have to rebase.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L530](https://github.com/hyperledger-gerrit-archive/fabric/blob/07c0d420717b56f2ce79ddb3e027b731181d0fac/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L530)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/10/2017, 9:55:16 AM<br><strong>UnmergedRevision</strong>: [79a5d6d1c904da9f306b5e72a91fd67f7f082bc2](https://github.com/hyperledger-gerrit-archive/fabric/commit/79a5d6d1c904da9f306b5e72a91fd67f7f082bc2)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/10/2017, 11:12:08 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333](https://github.com/hyperledger-gerrit-archive/fabric/blob/79a5d6d1c904da9f306b5e72a91fd67f7f082bc2/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333)<br><strong>Comment</strong>: <pre>Can you print out the key instead of the pointer location?

Here's what I get for the debug statement:
2017-04-10 14:46:17.912 UTC [statecouchdb] ApplyUpdates -> DEBU 530 Retrieving keys with unknown revision numbers, keys=[[]*statedb.CompositeKey{(*statedb.CompositeKey)(0xc42022ad20), (*statedb.CompositeKey)(0xc42022ad40)}]</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333](https://github.com/hyperledger-gerrit-archive/fabric/blob/79a5d6d1c904da9f306b5e72a91fd67f7f082bc2/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333)<br><strong>Comment</strong>: <pre>Added a small iterator to make a human readable log entry:

Example from unit testing:

2017/04/10 15:36:30 Retrieving keys with unknown revision numbers, keys= [ns1,key6],[ns1,key7],[ns1,key11],[ns1,key2],[ns1,key5],[ns1,key4],[ns1,key8],[ns1,key9],[ns1,key10],[ns1,key1],[ns1,key3],[ns2,key8],[ns2,key9],[ns2,key10],[ns2,key1],[ns2,key2],[ns2,key3],[ns2,key5],[ns2,key6],[ns2,key4],[ns2,key7]</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333](https://github.com/hyperledger-gerrit-archive/fabric/blob/79a5d6d1c904da9f306b5e72a91fd67f7f082bc2/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333)<br><strong>Comment</strong>: <pre>You can use "github.com/davecgh/go-spew/spew" - spew.SDump function. This is supposed to print nested struct.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333](https://github.com/hyperledger-gerrit-archive/fabric/blob/79a5d6d1c904da9f306b5e72a91fd67f7f082bc2/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L333)<br><strong>Comment</strong>: <pre>I don't see that package used anywhere except a unit test package.  I have a simple method with a few lines that prints the keys.  I would not like to add a dependency to the main application if there is a simple alternative.</pre></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 4/10/2017, 11:50:44 AM<br><strong>UnmergedRevision</strong>: [7c468870e8bfb2920d5c2bed43ddfb7b0a7b4729](https://github.com/hyperledger-gerrit-archive/fabric/commit/7c468870e8bfb2920d5c2bed43ddfb7b0a7b4729)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/10/2017, 3:32:00 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 4/10/2017, 2:32:23 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 4/11/2017, 7:58:22 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 7/26/2017, 1:30:45 PM<br><strong>UnmergedRevision</strong>: [7637f7f9a42937f6f6865f48422d54dea44c839e](https://github.com/hyperledger-gerrit-archive/fabric/commit/7637f7f9a42937f6f6865f48422d54dea44c839e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 7/27/2017, 3:57:15 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 8/1/2017, 6:08:08 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 8/2/2017, 8:17:07 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411)<br><strong>Comment</strong>: <pre>FAB-2709 seems to be implemented already?  But not sure how it actually truly applies here</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411)<br><strong>Comment</strong>: <pre>You're right, this is an outdated comment.  Chris is thinking through retry logic. Chris please create a follow-on Jira item for retry/error handling and include Jira number here.</pre><strong>Commenter</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L411)<br><strong>Comment</strong>: <pre>Retry logic has been added here for retrying individual documents from the batch.  The retry uses the same method for a single update document and the number of retries defined in core.yaml.</pre><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414)<br><strong>Comment</strong>: <pre>Unless I am missing something, if we merge this code and there is an error creating/updating one of the docs in the batch, then we are basically in a complete failure scenario because any doc up to the failure will have been updated / created</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414)<br><strong>Comment</strong>: <pre>State DB updates are intentionally idempotent to handle recovery/retry scenarios, where part of a block has been committed and part has not. The retry/recovery will replay all valid transactions in the block and ensure complete success before allowing peer to proceed on.  Retry/error handling will be described here and link to follow-on Jira item will be provided.</pre><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414)<br><strong>Comment</strong>: <pre>Right - but how will you handle the fact that if some docs make it in and some fail after retries expires and we crash, how will you reconcile the fact that there are documents in Couch already for some of the "orphaned" transactions?  I know the block won't be committed, there might still be orphaned records in the database?  Clearly they likely would not be referenced in the index, but will we actually delete them or just leave them?</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414](https://github.com/hyperledger-gerrit-archive/fabric/blob/7637f7f9a42937f6f6865f48422d54dea44c839e/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L414)<br><strong>Comment</strong>: <pre>The scenario with bulk updates is no different than with the previous one-by-one behavior. Either way, CouchDB does not provide transaction support across documents:

- First the block is written to block storage and block indexes updated.
- Then the state db updates are made based on valid writesets in the block.
- If all state db updates for a block are successful, then we do an explicit flush to couchdb disk and write a savepoint to couchdb indicating the last block written.
- Only then do we return from the ledger commit() and release the read/write lock for subsequent endorsements.

If not all state db updates are made, either due to retries exhausted (which panics peer) or an actual crash, then upon peer startup we detect inconsistent state based on lack of savepoint for latest block. The block writesets are re-applied to state db (some will override prior updates that were successful, some will be new, doesn't matter due to idempotent nature), flushed to disk, and savepoint written. Only then do we return a ledger handle to other peer components.

If you are asking about internal CouchDB 'orphaned documents'... yes CouchDB internally keeps older versions of documents for some time, and in the recovery scenario there may be some extra older versions of documents due to the retries or duplicates sent.  But these are never exposed to peer, and CouchDB purges these over time, just like it purges all other older versions of documents.

I think we are covered, do you see any issue here?</pre></blockquote><h3>PatchSet Number: 10</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 8/3/2017, 9:04:18 AM<br><strong>UnmergedRevision</strong>: [43ac58a7c9ba6a08a14701aa66113af285fed45f](https://github.com/hyperledger-gerrit-archive/fabric/commit/43ac58a7c9ba6a08a14701aa66113af285fed45f)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/3/2017, 9:55:57 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 11</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Uploader</strong>: Chris Elder - chris.elder@us.ibm.com<br><strong>Created</strong>: 8/3/2017, 1:03:43 PM<br><strong>GitHubMergedRevision</strong>: [7d90d014729d1be1ddaca9f5eaf287217e19fbd8](https://github.com/hyperledger-gerrit-archive/fabric/commit/7d90d014729d1be1ddaca9f5eaf287217e19fbd8)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/4/2017, 10:55:42 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 8/14/2017, 6:42:04 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 8/7/2017, 4:57:57 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 8/20/2017, 2:50:46 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: David Enyeart<br><strong>Merged</strong>: 8/20/2017, 2:51:25 PM<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312](https://github.com/hyperledger-gerrit-archive/fabric/blob/7d90d014729d1be1ddaca9f5eaf287217e19fbd8/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312)<br><strong>Comment</strong>: <pre>Please remove this line from here. This confuses here because, there is no context when the cache is loaded. In fact, because the cache will be loaded in txmgmt before calling validation, that would be a right place for clearing this as well.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312](https://github.com/hyperledger-gerrit-archive/fabric/blob/7d90d014729d1be1ddaca9f5eaf287217e19fbd8/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312)<br><strong>Comment</strong>: <pre>Will be addressed in FAB-5856.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312](https://github.com/hyperledger-gerrit-archive/fabric/blob/7d90d014729d1be1ddaca9f5eaf287217e19fbd8/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L312)<br><strong>Comment</strong>: <pre>Done</pre></blockquote>