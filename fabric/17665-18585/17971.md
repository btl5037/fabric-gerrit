<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 17971<br><strong>Subject</strong>: [FAB-7777] Suppress couchdb index creation errors<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 2/16/2018, 12:51:17 AM<br><strong>LastUpdated</strong>: 2/16/2018, 2:54:34 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-7777] Suppress couchdb index creation errors

This CR changes the statedb impl for the couchdb such that it does
not propagate the errors that are caused by erroneous db artifacts present
in the chaincode package archive. This is because a bad index file could bring
the peer to a halt until the chaincode package in uninstalled

Change-Id: Iecb8c243fcb5c8e01beb31a6ca21a53a1b14a354
Signed-off-by: manish <manish.sethi@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 2/16/2018, 12:51:17 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 12:51:43 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12653/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 12:54:35 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20970/ (2/2)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 2/16/2018, 12:58:47 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 12:59:18 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12653/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12653/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-end-2-end-x86_64/12653

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20970/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20970/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-x86_64/20970</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 1:01:08 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12654/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 1:02:03 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20971/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 1:32:13 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12654/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-end-2-end-x86_64/12654

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20971/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-x86_64/20971</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 2/16/2018, 7:42:54 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(8 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 2/16/2018, 11:30:55 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 11:33:18 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12659/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 11:33:31 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20975/ (2/2)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 2/16/2018, 11:38:24 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(8 comments)</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 2/16/2018, 11:57:29 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1

LGTM</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 12:04:33 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/12659/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-end-2-end-x86_64/12659

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/20975/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-x86_64/20975</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 2/16/2018, 1:49:49 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 2/16/2018, 2:26:48 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 2/16/2018, 2:26:50 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by David Enyeart</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/16/2018, 2:54:34 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/1866/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/1866

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/3190/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/3190</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 2/16/2018, 12:51:17 AM<br><strong>UnmergedRevision</strong>: [0b7d8ece58e02e7bf953e91bfba4752934c60bb6](https://github.com/hyperledger-gerrit-archive/fabric/commit/0b7d8ece58e02e7bf953e91bfba4752934c60bb6)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/16/2018, 12:59:18 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 2/16/2018, 12:58:47 AM<br><strong>UnmergedRevision</strong>: [78bcffdf6e11c36bcac66479b0227b94829d2bb5](https://github.com/hyperledger-gerrit-archive/fabric/commit/78bcffdf6e11c36bcac66479b0227b94829d2bb5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/16/2018, 1:32:13 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L89](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L89)<br><strong>Comment</strong>: <pre>Also comment that error suppression is acceptable since peer can continue in committing role without the indexes.  But endorsing role may be crippled depending on chaincode queries, until a new chaincode with fixed indexes is installed and instantiated.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L89](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L89)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L111](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L111)<br><strong>Comment</strong>: <pre>Include the err in the log statement.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L111](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L111)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L125](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L125)<br><strong>Comment</strong>: <pre>Include the err in the log statement.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L125](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L125)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L131](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L131)<br><strong>Comment</strong>: <pre>Include the err in the log statement.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L131](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L131)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L356](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L356)<br><strong>Comment</strong>: <pre>Do this one last to make it clear that the following query uses this one.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L356](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L356)<br><strong>Comment</strong>: <pre>This was the existing code. But I agree the query test should immediately follow this. Refactored in this CR to make the context of the queries better.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L367](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L367)<br><strong>Comment</strong>: <pre>If this test is to check nil chaincodeDef only, then don't pass a bad tar file in at the same time.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L367](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L367)<br><strong>Comment</strong>: <pre>Same as above</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L375](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L375)<br><strong>Comment</strong>: <pre>Extend comment to indicate that queries with a sort require the underlying index.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L375](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L375)<br><strong>Comment</strong>: <pre>same as above</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L399](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L399)<br><strong>Comment</strong>: <pre>2</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L399](https://github.com/hyperledger-gerrit-archive/fabric/blob/78bcffdf6e11c36bcac66479b0227b94829d2bb5/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb_test.go#L399)<br><strong>Comment</strong>: <pre>how did you catch this :-)</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 2/16/2018, 11:30:55 AM<br><strong>GitHubMergedRevision</strong>: [876b27473924595a4678d94b8cae0d763e33d1f1](https://github.com/hyperledger-gerrit-archive/fabric/commit/876b27473924595a4678d94b8cae0d763e33d1f1)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/16/2018, 12:04:33 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 2/16/2018, 1:49:49 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 2/16/2018, 2:26:48 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: David Enyeart<br><strong>Merged</strong>: 2/16/2018, 2:26:50 PM<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 2/16/2018, 11:57:29 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L95](https://github.com/hyperledger-gerrit-archive/fabric/blob/876b27473924595a4678d94b8cae0d763e33d1f1/core/ledger/kvledger/txmgmt/statedb/statecouchdb/statecouchdb.go#L95)<br><strong>Comment</strong>: <pre>a nit for future reference - "found a nil chaincodeDefinition" or "a nil chaincodeDefinition was found"</pre></blockquote>