<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 13045<br><strong>Subject</strong>: [FAB-5932] Introduce goroutine worker pools<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/31/2017, 9:44:11 AM<br><strong>LastUpdated</strong>: 10/6/2017, 4:21:45 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-5932] Introduce goroutine worker pools

This change set introduces pools of goroutine workers. This is going to be
useful for parallel VSCC validation and pipelining on the committer side.

Change-Id: Idaa06c3c8899f1b5e375d8e98e418c0a3677b052
Signed-off-by: Alessandro Sorniotti <ale.linux@sopit.net>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/31/2017, 9:44:11 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 9:44:18 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/11987/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 9:45:35 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16345/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 9:46:02 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7926/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 9:46:09 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10357/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 10:16:00 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-z/11987/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-z/11987/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/11987

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16345/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16345/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/16345

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7926/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/7926

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10357/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/10357</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/31/2017, 10:37:10 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 10:37:20 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/11992/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 10:38:48 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16350/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 10:39:09 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7932/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 10:39:10 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10362/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/31/2017, 11:58:08 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/11992/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/11992

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16350/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/16350

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7932/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/7932

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10362/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/10362</pre><strong>Reviewer</strong>: Baohua Yang - yangbaohua@gmail.com<br><strong>Reviewed</strong>: 9/1/2017, 5:55:15 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)

Please help see my comments in line, thanks!</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/1/2017, 6:05:32 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/1/2017, 6:05:39 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12019/ (1/4)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/1/2017, 6:06:33 AM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)

Thanks! See below + next drop</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/1/2017, 6:07:24 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16377/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/1/2017, 6:08:04 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7961/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/1/2017, 6:08:22 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10389/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/1/2017, 7:41:07 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/12019/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12019

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/16377/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/16377

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/7961/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/7961

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/10389/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/10389</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 9/1/2017, 12:34:36 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 9/10/2017, 1:31:53 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review-1

(3 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/21/2017, 12:14:00 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(4 comments)

Thx, Jason and Murali, See the new drop</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/21/2017, 12:14:11 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/21/2017, 12:14:17 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12806/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/21/2017, 12:17:43 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17156/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/21/2017, 12:17:52 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11168/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/21/2017, 12:17:59 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8741/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/21/2017, 1:46:49 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/12806/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12806

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17156/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17156

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11168/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11168

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8741/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/8741</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 9/22/2017, 1:19:55 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/22/2017, 5:09:53 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)

Thanks, Jason, see the next patch set</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/22/2017, 5:09:59 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 5:10:08 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12838/ (1/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 5:11:12 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17182/ (2/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 5:11:51 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11192/ (3/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 5:12:32 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8764/ (4/4)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/22/2017, 6:40:23 AM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/12838/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12838

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17182/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17182

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11192/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11192

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8764/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/8764</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 9/25/2017, 10:51:53 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/25/2017, 11:14:43 AM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:14:51 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12900/ (1/5)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/25/2017, 11:15:26 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(1 comment)

Thanks, Jason, see below + new drop</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:16:32 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17240/ (2/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:16:55 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11250/ (3/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:17:36 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8821/ (4/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:19:26 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/21/ (5/5)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/25/2017, 11:38:54 AM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:39:01 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12905/ (1/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:40:50 AM<br><strong>Message</strong>: <pre>Patch Set 6: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8821/ : ABORTED

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8821/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/8821

https://jenkins.hyperledger.org/job/fabric-verify-z/12900/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-z/12900/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12900

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17240/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17240/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17240

https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/21/ : FAILURE (skipped)

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/21/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-two-staged-ci-check-x86_64/21

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11250/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11250</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:40:51 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17245/ (2/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:41:16 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11255/ (3/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:41:48 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/26/ (5/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 11:41:48 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8826/ (4/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 1:07:55 PM<br><strong>Message</strong>: <pre>Patch Set 7: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/12905/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12905

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17245/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17245

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11255/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11255

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8826/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/8826

https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/26/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-two-staged-ci-check-x86_64/26</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 9/25/2017, 3:08:26 PM<br><strong>Message</strong>: <pre>Patch Set 7: Code-Review-1

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/25/2017, 4:23:45 PM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 4:23:54 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/12927/ (1/5)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 9/25/2017, 4:23:59 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)

Thanks, Jason, see below + new drop</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 4:25:34 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17266/ (2/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 4:25:59 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11275/ (3/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 4:26:34 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8846/ (4/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 4:27:04 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/47/ (5/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 9/25/2017, 5:50:03 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/12927/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/12927

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17266/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17266

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11275/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11275

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/8846/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/8846

https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/47/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-two-staged-ci-check-x86_64/47</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 9/29/2017, 12:38:26 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(2 comments)

Implementation looks good to me now.  Just a few comments on the test.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 9/30/2017, 4:59:55 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/1/2017, 10:41:36 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 2:40:43 AM<br><strong>Message</strong>: <pre>Patch Set 8:

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 10/2/2017, 5:24:50 AM<br><strong>Message</strong>: <pre>Uploaded patch set 9.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 5:25:00 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/13135/ (1/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 5:27:05 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17466/ (2/5)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 10/2/2017, 5:27:06 AM<br><strong>Message</strong>: <pre>Patch Set 8:

(3 comments)

Thanks, Jason and Yacov, see below.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 5:27:10 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/9037/ (3/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 5:28:02 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/229/ (4/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 5:28:08 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11467/ (5/5)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 6:41:37 AM<br><strong>Message</strong>: <pre>Patch Set 9: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-z/13135/ : FAILURE

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-z/13135/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/13135

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/17466/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-x86_64/17466

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/9037/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-end-2-end-x86_64/9037

https://jenkins.hyperledger.org/job/fabric-verify-two-staged-ci-check-x86_64/229/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-two-staged-ci-check-x86_64/229

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/11467/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-behave-x86_64/11467</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 6:47:11 AM<br><strong>Message</strong>: <pre>Patch Set 9:

rebuild-z</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 6:47:21 AM<br><strong>Message</strong>: <pre>Patch Set 9: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-z/13138/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/2/2017, 7:34:34 AM<br><strong>Message</strong>: <pre>Patch Set 9: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-z/13138/ : SUCCESS

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-1/fabric-verify-z/13138</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 11:21:46 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review+2</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 11:25:04 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review-1

(5 comments)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 11:43:35 AM<br><strong>Message</strong>: <pre>Patch Set 9:

(Another nit: package "workers" contains file "worker.go" and the test file is called "workers_test.go". Switch everything to plural ("workers") and call it a day?)</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 11:49:39 AM<br><strong>Message</strong>: <pre>Patch Set 9: Code-Review-2

I'm not sure this patch makes sense.  Go routines and other lightweight concurrency mechanisms (fibers, erlang lwps, clojure core.async, etc) exist as an anti-pattern against thread pools specifcally because they are cheap to create on the fly.  What justification is there to increase our technical debt by adding an abstraction?</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 11:53:00 AM<br><strong>Message</strong>: <pre>Patch Set 9:

> Patch Set 9: Code-Review-2
> 
> I'm not sure this patch makes sense.  Go routines and other lightweight concurrency mechanisms (fibers, erlang lwps, clojure core.async, etc) exist as an anti-pattern against thread pools specifcally because they are cheap to create on the fly.  What justification is there to increase our technical debt by adding an abstraction?

This works for me BTW. (Though I wasn't brave enough to propose it.)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 12:05:32 PM<br><strong>Message</strong>: <pre>Removed Code-Review+2 by Jason Yellick <jyellick@us.ibm.com>
</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 12:12:22 PM<br><strong>Message</strong>: <pre>Patch Set 9:

What I think that Alessandro is trying to do here is less in the notion of abstracting out "green threads" but more in the notion of creating an abstraction that allocates a fixed size of goroutines to process/dispatch workloads of arbitrary size and read the results of the processing in sequential order. 

This is to used in the next change set in the series where he introduces parallel validation of transactions in a block. 

Empirical evidence (and common sense) prove that if we validate the Txns in the block in parallel it greatly improves the critical path of Fabric's transaction lifecycle. 

To me, the only thing remains is to answer whether the worker pool can be utilized by other fabric components and therefore a justification for common/workers exists, or that the logic should be implemented in the txvalidator package.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 12:12:32 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> > Patch Set 9: Code-Review-2
 > >
 > > I'm not sure this patch makes sense.  Go routines and other
 > lightweight concurrency mechanisms (fibers, erlang lwps, clojure
 > core.async, etc) exist as an anti-pattern against thread pools
 > specifcally because they are cheap to create on the fly.  What
 > justification is there to increase our technical debt by adding an
 > abstraction?
 > 
 > This works for me BTW. (Though I wasn't brave enough to propose
 > it.)

I'll let Ale respond himself, but my understanding was that this pool was to be used to prevent the validation functions from starving the rest of the system.

Consider for instance a peer which is joined to 100 channels, and each channel gets a block with 1000 transactions.  Then, using the simple 'go validate(tx)' approach, would spawn 100k go routines, each doing real CPU intensive work.

If there are 100k validation go routines attempting to do work, and 10 gossip go routines attempting to do work, then proportionally, I would expect the go routines to not be scheduled for unacceptable amounts of time.  Even with the go scheduler guaranteeing no starvation, this still seems like a problem.

FWIW, I agree with respect to not including the Async function, though was not a deal breaker for me.</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 12:18:20 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> What I think that Alessandro is trying to do here is less in the
 > notion of abstracting out "green threads" but more in the notion of
 > creating an abstraction that allocates a fixed size of goroutines
 > to process/dispatch workloads of arbitrary size and read the
 > results of the processing in sequential order.
 > 
 > This is to used in the next change set in the series where he
 > introduces parallel validation of transactions in a block.
 > 
 > Empirical evidence (and common sense) prove that if we validate the
 > Txns in the block in parallel it greatly improves the critical path
 > of Fabric's transaction lifecycle.
 > 
 > To me, the only thing remains is to answer whether the worker pool
 > can be utilized by other fabric components and therefore a
 > justification for common/workers exists, or that the logic should
 > be implemented in the txvalidator package.

I would suggest "don't do that".  Go routines already front-end an underlying worker pool.  Just use them directly.  Doing so will be more idiomatic, clear, error-free, and conducive for integration into the rest of the ecosystem such as with other concurrency mechanisms like parallel map/reduce.  Abstract when it makes sense, but this doesn't seem obvious to me that it meets that criteria.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 12:24:13 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> I would suggest "don't do that".  Go routines already front-end an underlying worker pool.  Just use them directly.  Doing so will be more idiomatic, clear, error-free, and conducive for integration into the rest of the ecosystem such as with other concurrency mechanisms like parallel map/reduce.  Abstract when it makes sense, but this doesn't seem obvious to me that it meets that criteria.

So, what Jason said covers this part - since we have a txvalidator instance per channel we need some way of knowing we don't spawn too much goroutines that do expensive ECDSA verification and this starving the other goroutines in the process (i.e gossip also does signature verification for messages)</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 12:29:15 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> 
 > I'll let Ale respond himself, but my understanding was that this
 > pool was to be used to prevent the validation functions from
 > starving the rest of the system.
 > 
 > Consider for instance a peer which is joined to 100 channels, and
 > each channel gets a block with 1000 transactions.  Then, using the
 > simple 'go validate(tx)' approach, would spawn 100k go routines,
 > each doing real CPU intensive work.

FWIW: The idiomatic flow control would be based on channels with finite depth for cases like this.

 > 
 > If there are 100k validation go routines attempting to do work, and
 > 10 gossip go routines attempting to do work, then proportionally, I
 > would expect the go routines to not be scheduled for unacceptable
 > amounts of time.  Even with the go scheduler guaranteeing no
 > starvation, this still seems like a problem.

I didn't mean to suggest that one need not think:  Rather, we should have a high-bar for adding additional concurrency abstractions vs using the ones that exist.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 12:34:23 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> FWIW: The idiomatic flow control would be based on channels with finite depth for cases like this.

So you're basically offering an idea of a shared counting semaphore that each txValidator goroutine acquires 1 resource when it starts validating, and then returns the resource when it finishes validating, and this semaphore will be shared among all instances of txValidator, right?</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 12:38:36 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> > FWIW: The idiomatic flow control would be based on channels with
 > finite depth for cases like this.
 > 
 > So you're basically offering an idea of a shared counting semaphore
 > that each txValidator goroutine acquires 1 resource when it starts
 > validating, and then returns the resource when it finishes
 > validating, and this semaphore will be shared among all instances
 > of txValidator, right?

I haven't thought about what the design might look like.  However, I have done a ton of concurrency design (both with and without CSP model) and there is very little that you can't accomplish with a go-routine, a lambda expression, and a channel.  And the solutions are almost always extremely elegant compared to what we used to have to do when those facilities didn't exist and people manually coded thread-pool management into the code base. ;) . Therefore, I would highly suggest to think about how to apply go-routines/lambdas/channels to the problem rather than create a new abstraction.  If it can't be done, so be it.  However, I am skeptical that is the case.</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 10/2/2017, 12:53:11 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Thx for the comments. As Jason summarized (thx Jason!), the objective is to cap the number of concurrent validation goroutines to ensure that we make progress in other parts of the peer as well. There are surely other ways of achieving this objective, however this approach seems to be clean/simple enough (but of course I may be biased :) ).</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 1:38:27 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> Thx for the comments. As Jason summarized (thx Jason!), the
 > objective is to cap the number of concurrent validation goroutines
 > to ensure that we make progress in other parts of the peer as well.
 > There are surely other ways of achieving this objective, however
 > this approach seems to be clean/simple enough (but of course I may
 > be biased :) ).

Thanks to @yacov for pointing out this pre-canned semaphore-on-channel http://www.golangpatterns.info/concurrency/semaphores

But I would suggest this logic looks something like

func validate() { s.Lock() go func() { defer s.Unlock(); ... }}

where "s" is initialized to the maximum level of concurrency you are willing to tolerate.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 2:26:30 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Greg, I assume you meant not Lock and Unlock but Acquire() and Release() (denoted in the link as P() and V() )

In case the model in this change set is considered an overkill, I would suggest the following: 
- We have a shared counting semaphore S initialized to number of cores.
- in each txValidator object (that is per-channel) we have a channel C that is of size of the number of cores that will be used for input.
- when a block comes, we allocate a "result" channel R that is of size of the number of transactions in the block.
- Afterwards, we spin up an amount of goroutines as the number of cores, and each goroutine first acquires a resource from the semaphore, reads from the channel C, does its thing, and outputs to the channel R and then releases the resource (all in a loop until the channel is closed)
- In parallel in the "main" goroutine (the one executes the block commit) just reads from the result channel R sequentially and finally closes the channel R to indicate the spawned goroutines to die.

What does everyone think?</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 2:43:15 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> Greg, I assume you meant not Lock and Unlock but Acquire() and
 > Release() (denoted in the link as P() and V() )
 > 
 > In case the model in this change set is considered an overkill, I
 > would suggest the following:
 > - We have a shared counting semaphore S initialized to number of
 > cores.
 > - in each txValidator object (that is per-channel) we have a
 > channel C that is of size of the number of cores that will be used
 > for input.
 > - when a block comes, we allocate a "result" channel R that is of
 > size of the number of transactions in the block.
 > - Afterwards, we spin up an amount of goroutines as the number of
 > cores, and each goroutine first acquires a resource from the
 > semaphore, reads from the channel C, does its thing, and outputs to
 > the channel R and then releases the resource (all in a loop until
 > the channel is closed)
 > - In parallel in the "main" goroutine (the one executes the block
 > commit) just reads from the result channel R sequentially and
 > finally closes the channel R to indicate the spawned goroutines to
 > die.
 > 
 > What does everyone think?

I took a look at that link, and I can't say I'm a fan of the way channels are used there.  My understanding, is that in general, golang channel performance becomes very poor when there is a lot of write contention, and more traditional synchronization primitives are better choices for these situations.

There is a package in the golang.org/x/ which implements a semaphore which I would rather see used.

https://godoc.org/golang.org/x/sync/semaphore

Then, the allocation could look simply like:

 go func() {
   s := semaphore.NewWeighted(n)
   for ... {
     s.Acquire(context.TODO, 1)
     go func() {
       ...
       s.Release(1)
     }
   }
 }</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 2:47:30 PM<br><strong>Message</strong>: <pre>Patch Set 9:

In the above code snippet, I actually meant for 's' to be allocated outside of the go routine, and to be shared across validation instances.</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 2:59:59 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> In the above code snippet, I actually meant for 's' to be allocated
 > outside of the go routine, and to be shared across validation
 > instances.

@Yacov, yes, sorry.  Acquire/Release are probably correct.  To many distractions today ...

@Jason, your semaphore lib choice is fine by me.  My main concern is to see it remain pure go-routine+lambda+channel unless it cannot be, and your solution presumably qualifies.  Only comment is I would suggest the .Release() should be the first line of your go routine with a defer guard to prevent leaks.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 3:06:41 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Since we don't acquire more than 1 resource at a time, which means that we only do 1 channel enqueue to acquire a resource I really don't see the difference in the performance between the semaphore in the link and the semaphore implementation in Jason's link - it also uses a mutex...

but forget the semaphore implementation, that's not the main issue here. The issue is should the generic worker pool be embedded inside the txvalidation itself and just use a synchronization construct that limits concurrent validation to the number of cores using a shared semaphore or not.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 3:34:44 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> but forget the semaphore implementation, that's not the main issue here. The issue is should the generic worker pool be embedded inside the txvalidation itself and just use a synchronization construct that limits concurrent validation to the number of cores using a shared semaphore or not.

I vote for the shared semaphore approach. Its initialization (i.e. weight) being set via an `init` function I guess, correct?</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/2/2017, 3:38:08 PM<br><strong>Message</strong>: <pre>Patch Set 9:

@Greg

 > @Jason, your semaphore lib choice is fine by me.  My main concern
 > is to see it remain pure go-routine+lambda+channel unless it cannot
 > be, and your solution presumably qualifies.

This works for me.  Just to clarify, you oppose wrapping this into some common lib?

 > Only comment is I
 > would suggest the .Release() should be the first line of your go
 > routine with a defer guard to prevent leaks.
100% agree with this

@Yacov
 > Since we don't acquire more than 1 resource at a time, which means
 > that we only do 1 channel enqueue to acquire a resource I really
 > don't see the difference in the performance between the semaphore
 > in the link and the semaphore implementation in Jason's link - it
 > also uses a mutex...

Remember that the for loop is once per channel, so, we could have up to n concurrent sempahore acquire calls where n is the number of (fabric) channels.  Granted, the performance difference is probably pretty minimal for the typical magnitude of (fabric) channels, but (at least last time I checked), using a mutex to synchronize writers vs using a channel was notably faster.

 > 
 > but forget the semaphore implementation, that's not the main issue
 > here. The issue is should the generic worker pool be embedded
 > inside the txvalidation itself and just use a synchronization
 > construct that limits concurrent validation to the number of cores
 > using a shared semaphore or not.

I don't particularly see the harm in wrapping the logic, if for no other reason that to give names which are more obvious ('WaitForAvailableWorkSlot' vs. 'Acquire' or whatnot).  Then again, idiomatic go seems to discourage wrappers like this, and I can't see it doing much to reduce code complexity, so maybe it's not worth it.</pre><strong>Reviewer</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Reviewed</strong>: 10/2/2017, 9:46:42 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> @Greg
 > 
 > This works for me.  Just to clarify, you oppose wrapping this into
 > some common lib?
 
I just think the notion of a pool of go-routines runs counter to how they should be used.  Go-routines and channels are literally an interface to an existing thread pool.  The problem as I see it is, making any algorithm a common library fucntion promotes the adoption of the model within the code base.  Therefore, I think the bar should be fairly high for common concurrency primitives that capture things like true design patterns.  The semaphore discussion is a good example of that. 
 This CR feels like an anti-pattern especially when the solution using idiomatic practices is likely trivial and readily available.  Maybe I am wrong.</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 10/3/2017, 3:55:26 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Been  (trying) to follow all the comments.  So is the collective group coming to the following conclusions:

1) There will be no library / package which implements a worker pool but rather the code will be "inlined" where it is needed

2) There will be a global pool (or maybe just counter) for goroutines which will be available for transaction validation across all Fabric channels?   So the fewer Fabric channels one has, the more "parallel" processing of transactions will be for a Fabric channel?

3) Maybe not stated here, but given the whole goal was to validate transactions in a block in parallel, I don't think it really makes sense for the pool/counter size to exceed the number of cores on the system?   I suppose if you are perhaps trying to give more weight to these tasks, ok, but if the goal is parallelism, you are limited to available cores on the system</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/3/2017, 4:13:50 AM<br><strong>Message</strong>: <pre>Removed reviewer Srinivasan Muralidharan.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 10/3/2017, 4:20:17 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Gari- you're correct w.r.t to 3:
The processing "power" is capped at NumCPU() globally since you saturate your CPU starting from this number of parallel processing.
I understand that @Chrysoula and @Marko have empiric performance evidence that back this claim. 

However, what this change set also attempts to do is to make sure the global pool is shared among channels, and this is to prevent reaching a situation where we have lots of goroutines that do validation, that starve other components of the peer like gossip (out performance seriously deteriorates when the CPU is overloaded, because - we - do the verification that the block is signed by the orderer, and if that considerably slows down, our queues get full and we start dropping messages that could be blocks themselves).</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 10/3/2017, 6:47:10 AM<br><strong>Message</strong>: <pre>Patch Set 9:

goroutines vs worker pool -  simple test case in https://github.com/muralisrini/randomtests shows that with growing N goroutines have a decided advantage (for small N doesn;t matter). Basically proves Greg's point I think.</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 10/3/2017, 7:44:40 AM<br><strong>Message</strong>: <pre>Patch Set 9:

> Gari- you're correct w.r.t to 3:
 > The processing "power" is capped at NumCPU() globally since you
 > saturate your CPU starting from this number of parallel processing.
 > I understand that @Chrysoula and @Marko have empiric performance
 > evidence that back this claim.
 > 
 > However, what this change set also attempts to do is to make sure
 > the global pool is shared among channels, and this is to prevent
 > reaching a situation where we have lots of goroutines that do
 > validation, that starve other components of the peer like gossip
 > (out performance seriously deteriorates when the CPU is overloaded,
 > because - we - do the verification that the block is signed by the
 > orderer, and if that considerably slows down, our queues get full
 > and we start dropping messages that could be blocks themselves).

Cool.  Got it.  Just making sure  :-)</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 10/3/2017, 4:42:58 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Any decision on how to proceed with this and https://gerrit.hyperledger.org/r/#/c/12849/ ?  However we decide to do this, this really is a nice performance/throughout boost</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/3/2017, 6:06:48 PM<br><strong>Message</strong>: <pre>Patch Set 9:

> Patch Set 9:
> 
> Any decision on how to proceed with this and https://gerrit.hyperledger.org/r/#/c/12849/ ?  However we decide to do this, this really is a nice performance/throughout boost

I'm voting exactly for what was summarized here: https://gerrit.hyperledger.org/r/c/13045/#message-b3ea0215_b36184f5</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 10/4/2017, 8:49:07 AM<br><strong>Message</strong>: <pre>Patch Set 9:

> Any decision on how to proceed with this and https://gerrit.hyperledger.org/r/#/c/12849/
 > ?  However we decide to do this, this really is a nice
 > performance/throughout boost

my 2c... accept this CR but implement the direct goroutine in https://gerrit.hyperledger.org/r/#/c/12849/. We can move to this workerpool approach if we decide thats better. Shouldn't be hard to switch and its all internal anyway.
Or if consensus is to use workerpool given all the thought and work that has gone into it, that's fine too.</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 10/6/2017, 4:21:45 AM<br><strong>Message</strong>: <pre>Abandoned</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 8/31/2017, 9:44:11 AM<br><strong>UnmergedRevision</strong>: 02f3a218a5143094ed18cf1b740697f93866f747<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/31/2017, 10:16:00 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 8/31/2017, 10:37:10 AM<br><strong>UnmergedRevision</strong>: 57777ee67817cb55621b4de52336decfdbc9bebf<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/31/2017, 11:58:08 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/1/2017, 6:05:32 AM<br><strong>UnmergedRevision</strong>: b5b2fc46a00024b61e4ece738737b427a9ed2577<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/1/2017, 7:41:07 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 9/10/2017, 1:31:53 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/21/2017, 12:14:11 PM<br><strong>UnmergedRevision</strong>: 43d12c744afb9bfb5f7541bec32e1a0914fce0d6<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/21/2017, 1:46:49 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/22/2017, 5:09:59 AM<br><strong>UnmergedRevision</strong>: 3db9900c55192c1e643d1acbf8af5e579f28f6e8<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/22/2017, 6:40:23 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/25/2017, 11:14:43 AM<br><strong>UnmergedRevision</strong>: 1946fd99b5f8f55095a1938ca28ab25550240d9d<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/25/2017, 11:40:50 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/25/2017, 11:38:54 AM<br><strong>UnmergedRevision</strong>: 93a000fb62f09060dae49a1fb5e693dcde449041<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/25/2017, 1:07:55 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 9/25/2017, 3:08:26 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 9/25/2017, 4:23:45 PM<br><strong>UnmergedRevision</strong>: d4308a9e0220023c4ef6d28808d02b9a2b07991e<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 9/25/2017, 5:50:03 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 10/2/2017, 5:24:50 AM<br><strong>UnmergedRevision</strong>: 8f19d510630b45f1d40b26b0f088f5958f4948e6<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 10/2/2017, 7:34:34 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Greg Haskins - gregory.haskins@gmail.com<br><strong>Approved</strong>: 10/2/2017, 11:49:39 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 10/2/2017, 11:25:04 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote>