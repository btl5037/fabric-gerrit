<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 5989<br><strong>Subject</strong>: [FAB-2226] Move anchor peers to app org level<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 2/14/2017, 1:06:48 AM<br><strong>LastUpdated</strong>: 2/15/2017, 4:37:39 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-2226] Move anchor peers to app org level

https://jira.hyperledger.org/browse/FAB-2226

The anchor peers are per application organization, so should be stored
at the app org level.

Change-Id: I930244c44c759d628531af2f71da3ced43b85631
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 1:06:48 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 1:09:32 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6940/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 2:12:59 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6940/ : SUCCESS</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 4:38:07 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1

(3 comments)</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 4:50:49 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 4:54:12 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 9:21:02 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(4 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 9:51:04 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 9:58:46 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 10:09:59 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 10:13:44 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6958/</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 10:53:26 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 10:57:38 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6962/</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 11:00:10 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2

Perfect, thanks</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 11:00:36 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6958/ : FAILURE</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 11:01:46 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 2/14/2017, 11:03:39 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 11:05:58 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6963/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 12:09:13 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6962/ : SUCCESS</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/14/2017, 12:10:53 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/6963/ : SUCCESS</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 2/14/2017, 3:19:25 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 2/15/2017, 1:24:03 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5: Patch Set 4 was rebased.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/15/2017, 1:25:51 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/7030/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/15/2017, 2:37:30 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/7030/ : SUCCESS</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 2/15/2017, 3:03:21 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 2/15/2017, 3:12:34 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 2/15/2017, 3:13:37 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Srinivasan Muralidharan</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/15/2017, 3:16:02 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/1085/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 2/15/2017, 4:37:39 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/1085/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 2/14/2017, 1:06:48 AM<br><strong>UnmergedRevision</strong>: [a17f202bcffc5d0266917e647c1b92a60be1aa31](https://github.com/hyperledger-gerrit-archive/fabric/commit/a17f202bcffc5d0266917e647c1b92a60be1aa31)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/14/2017, 2:12:59 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 2/14/2017, 4:38:07 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L58](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L58)<br><strong>Comment</strong>: <pre>This is a nice trick. However, I think it would benefit to use https://godoc.org/github.com/stretchr/testify/assert#Assertions.Panics in the future

This is in the vendor folder of fabric.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L58](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L58)<br><strong>Comment</strong>: <pre>Yes, good idea.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L58](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L58)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L58](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L58)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L68)<br><strong>Comment</strong>: <pre>I guess this is a typo, right? Should something like, "Should have panicked since no one began configs"...</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L68)<br><strong>Comment</strong>: <pre>Or "cannot commit before config begins"...</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/organization_test.go#L68](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/organization_test.go#L68)<br><strong>Comment</strong>: <pre>Yes, a typo.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/sharedconfig_util.go#L45](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/sharedconfig_util.go#L45)<br><strong>Comment</strong>: <pre>This isn't used anymore, am I correct?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/sharedconfig_util.go#L45](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/sharedconfig_util.go#L45)<br><strong>Comment</strong>: <pre>Yes, that's correct.  I can remove it if you see no use for it going forward.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [common/configtx/handlers/application/sharedconfig_util.go#L45](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/common/configtx/handlers/application/sharedconfig_util.go#L45)<br><strong>Comment</strong>: <pre>You should know more than me, since this method returns a type of your area ;)</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/service/eventer.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/gossip/service/eventer.go#L75)<br><strong>Comment</strong>: <pre>In this for loop, you build gradually the newAnchorPeers slice as you iterate over all the orgs, right?

but- in line 82 what you do is iterate over the previous anchor peers and for each such an anchor peer, you seek it in the current newAnchorPeers slice.

But if you have 2 orgs, and anchor peers:
orgA: [ap0, ap1]
orgB: [ap2, ap3]

when you're in the first iteration of line 75 the newAnchorPeers slice will only contain [ap0, ap1], and then in the 3rd iteration of line 82 you'll seek [ap2] and in line 83 you'll iterate over [ap0, ap1] but you won't find ap2, so I think that changed will be set to true.

So (unless I missed something)- even if you have a config which is identical to your previous config, you'll call configUpdated in any case.

This 3-way loop seems a redundant optimization in my opinion.
why not:
- Flatten the config.Organizations() 
- Compare them with deep equal like on the left (red) side
?

It's much simpler.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [gossip/service/eventer.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/gossip/service/eventer.go#L75)<br><strong>Comment</strong>: <pre>Yes, on second reading this code is generally wrong.  Sorry about that.

Really, my intention was that this be a stopgap solution.  My hope was that once the per org anchor peers were populated into the gossip component, that this "did any anchor peer among all orgs change" logic could be modified to be "Did any org's anchor peers change?" but thought that would be better handled by the gossip team.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/service/eventer.go#L75](https://github.com/hyperledger-gerrit-archive/fabric/blob/a17f202bcffc5d0266917e647c1b92a60be1aa31/gossip/service/eventer.go#L75)<br><strong>Comment</strong>: <pre>So, just some more information- having an anchor peer defined as:
- host
- port
- identity

is just temporary until your work is done.
Once we could get the channel members (organizations of channel), we won't need anymore the identities and then we would need to change the JoinChannelMessage api to provide:
1) anchor peers:
       - host
       - port
2) list of organizations

The reason is that in gossip we handle these 2 things in 2 different places:
The anchor peers- we just connect to them, and let gossip do its stuff.
The list of organizations- we currently just use it to know if a remote peer `p` is eligible of receiving any data regarding a channel (we check if the remote peer is in the right org- we extract its organization ID and search it in the list of organizations of the channel. In the future, we'll use somehow also an MSP method to know if the peer fulfills a channel reader policy).</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 2/14/2017, 10:09:59 AM<br><strong>UnmergedRevision</strong>: [3311f3b0ceaec5e39f6d62fb7a0edff2545520e8](https://github.com/hyperledger-gerrit-archive/fabric/commit/3311f3b0ceaec5e39f6d62fb7a0edff2545520e8)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/14/2017, 11:00:36 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 2/14/2017, 10:53:26 AM<br><strong>UnmergedRevision</strong>: [8edd719aeab3ae8457c8e0d3c0d22b13754358d0](https://github.com/hyperledger-gerrit-archive/fabric/commit/8edd719aeab3ae8457c8e0d3c0d22b13754358d0)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/14/2017, 12:09:13 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 2/14/2017, 11:00:10 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 2/14/2017, 11:01:46 AM<br><strong>UnmergedRevision</strong>: [150c5c227c4cb6a71766ab9e46e8a2d938635a1e](https://github.com/hyperledger-gerrit-archive/fabric/commit/150c5c227c4cb6a71766ab9e46e8a2d938635a1e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/14/2017, 12:10:53 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Approved</strong>: 2/14/2017, 3:19:25 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 2/14/2017, 11:03:39 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 2/15/2017, 1:24:03 PM<br><strong>GitHubMergedRevision</strong>: [7e0b4bf4e01c923ab81d1a18c69c618f08f3f440](https://github.com/hyperledger-gerrit-archive/fabric/commit/7e0b4bf4e01c923ab81d1a18c69c618f08f3f440)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 2/15/2017, 2:37:30 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Approved</strong>: 2/15/2017, 3:03:21 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Approved</strong>: 2/15/2017, 3:12:34 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Srinivasan Muralidharan<br><strong>Merged</strong>: 2/15/2017, 3:13:37 PM<br><br></blockquote>