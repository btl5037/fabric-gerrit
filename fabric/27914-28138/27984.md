<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 27984<br><strong>Subject</strong>: [FAB-13178] BlockCreator does not return nil #done<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 12/6/2018, 6:04:08 AM<br><strong>LastUpdated</strong>: 1/8/2019, 1:19:12 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-13178] BlockCreator does not return nil #done

This CR changes BlockCreator.CreateNextBlock to block waiting when
buffer is full. It used to return nil in this case.

It also move block commitment to seperate go routine in etcdraft
chain. This is necessary because once we make BlockCreator block
waiting for free space in buffer, `serveRequest` go routine is
blocked, and we need to be able to commit blocks to free
BlockCreator buffer, otherwise we have a deadlock.

Change-Id: Id9988b1a23f6745268f6bd6f46460b71cc3fd9c6
Signed-off-by: Jay Guo <guojiannan1101@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 6:04:08 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:08:55 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7913/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:09:21 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 6:11:05 AM<br><strong>Message</strong>: <pre>Patch Set 1:

we could
- get this in before current stack, or
- i'll rebase it once stack is stable</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:13:41 AM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:14:26 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7913/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7913</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:16:30 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6872/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:17:05 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:17:30 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3923/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:18:18 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:39:29 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:39:36 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 6:40:26 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6872/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6872

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3923/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3923</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 10:46:22 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 10:54:06 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7923/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 10:54:37 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:00:21 AM<br><strong>Message</strong>: <pre>Patch Set 2: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:01:20 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7923/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7923</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:02:58 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6883/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:03:22 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3929/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:03:28 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:05:00 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting Integration tests</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 11:17:45 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 11:19:14 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:19:15 AM<br><strong>Message</strong>: <pre>Patch Set 3:

No Builds Executed</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 11:20:33 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Run VerifyBuild</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:20:34 AM<br><strong>Message</strong>: <pre>Patch Set 4:

No Builds Executed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:22:52 AM<br><strong>Message</strong>: <pre>Patch Set 2: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:24:14 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7926/</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 11:25:03 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+1

(4 comments)

@Jay: I've highjacked this CR slightly by doing some doc fixes on the blockcreator file - sorry about that. @Adarsh: Please double-check me here, and feel free to push a patchset with a corrections.

Back to the crux of this CR: I follow what we're doing, and it LGTM.

+1 until you guys have a pass on the doc changes as well.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:25:04 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:27:10 AM<br><strong>Message</strong>: <pre>Patch Set 2: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:28:12 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6883/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6883

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3929/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3929</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:30:02 AM<br><strong>Message</strong>: <pre>Patch Set 4: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:33:09 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6889/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:33:47 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:34:07 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3932/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 11:35:06 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 12:00:32 PM<br><strong>Message</strong>: <pre>Patch Set 4: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 12:08:44 PM<br><strong>Message</strong>: <pre>Patch Set 4: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/6/2018, 12:09:45 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7926/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7926

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6889/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6889

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3932/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3932</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 8:41:45 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/6/2018, 10:12:46 PM<br><strong>Message</strong>: <pre>Patch Set 4:

> Patch Set 4: Code-Review+1
> 
> (4 comments)
> 
> @Jay: I've highjacked this CR slightly by doing some doc fixes on the blockcreator file - sorry about that. @Adarsh: Please double-check me here, and feel free to push a patchset with a corrections.
> 
> Back to the crux of this CR: I follow what we're doing, and it LGTM.
> 
> +1 until you guys have a pass on the doc changes as well.

Doc change LGTM</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 12:40:35 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(4 comments)

An important CR indeed! My bad in not taking care of this case. However, I am not convinced that we should drop a batch if the block creator is full and I will -1 for now until there is discussion on that.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 6:51:15 AM<br><strong>Message</strong>: <pre>Patch Set 4:

> Patch Set 4:
> 
> (4 comments)
> 
> An important CR indeed! My bad in not taking care of this case. However, I am not convinced that we should drop a batch if the block creator is full and I will -1 for now until there is discussion on that.

To recap the offline conversation i had with Adarsh:
In general, I agree. Although that would require some refactoring of chain, mostly due to the coordination of go routines. And I'd like to do that after reconfiguration.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 9:59:06 AM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:00:51 AM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+1

(4 comments)

@Adarsh: See my comments inline. WDYT?</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:03:45 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7953/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:04:17 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:07:58 AM<br><strong>Message</strong>: <pre>Patch Set 5: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:08:44 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7953/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7953</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:10:30 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6908/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:11:05 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:11:24 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3945/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:12:16 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting Integration tests</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:15:31 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

@Kostas I do believe we need some discussion on this unless we are all agreed with the silent dropping of the batch. There are some real considerations here if we want to do away with the silent dropping.</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:16:51 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:26:48 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:31:11 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:33:32 AM<br><strong>Message</strong>: <pre>Patch Set 5: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:39:23 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:39:31 AM<br><strong>Message</strong>: <pre>Patch Set 5: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 10:40:26 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6908/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6908

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3945/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3945</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:45:30 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 10:58:16 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 11:03:48 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6912/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 11:04:18 AM<br><strong>Message</strong>: <pre>Patch Set 5: -F3-UnitTest

Starting unit tests</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 11:07:30 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 11:25:47 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

> Patch Set 5:
> 
> (1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 11:31:28 AM<br><strong>Message</strong>: <pre>Patch Set 5: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/7/2018, 11:32:09 AM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6912/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6912</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 1:50:45 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 1:53:17 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 6:37:50 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 7:34:08 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

> Patch Set 5:
> 
> (1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 8:00:47 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 8:27:09 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/7/2018, 8:46:06 PM<br><strong>Message</strong>: <pre>Patch Set 5:

> Patch Set 5:
> 
> (1 comment)

Got it.

> clients block waiting on envelopes being consumed by chain?

@Adarsh: Your take?</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 12:43:03 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 5:20:12 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 5:26:06 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)

> Patch Set 5:
> 
> (1 comment)</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 8:11:17 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 11:06:37 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>Reviewed</strong>: 12/8/2018, 11:33:51 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(1 comment)</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 12/9/2018, 5:54:00 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(3 comments)</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 12/9/2018, 5:56:30 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review-1

will -1 for a while just for us to consider the serviceability aspect and some hints about envelopes to be dropped.</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 12/9/2018, 6:07:33 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 12/10/2018, 4:09:38 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 12/10/2018, 4:11:31 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/10/2018, 4:19:36 AM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review-1

per discussion in CR comments, we should keep clients block waiting for envelopes to be consumed, instead of dropping them. I'll update the CR accordingly, tentatively -1</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 12/10/2018, 10:51:16 AM<br><strong>Message</strong>: <pre>Patch Set 5: -Code-Review

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 12/10/2018, 11:21:32 AM<br><strong>Message</strong>: <pre>Patch Set 4:

(1 comment)</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/16/2018, 3:46:07 PM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/16/2018, 3:47:48 PM<br><strong>Message</strong>: <pre>Uploaded patch set 7: Commit message was updated.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:48:34 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8264/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:49:03 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting verify build</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/16/2018, 3:49:10 PM<br><strong>Message</strong>: <pre>Uploaded patch set 8: Patch Set 7 was rebased.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:49:57 PM<br><strong>Message</strong>: <pre>Patch Set 6: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8264/ : ABORTED

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8264</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:52:11 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8266/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:52:39 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:52:40 PM<br><strong>Message</strong>: <pre>Patch Set 8:

WIP - No Build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/16/2018, 3:53:34 PM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8266/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8266</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/21/2018, 7:34:48 AM<br><strong>Message</strong>: <pre>Uploaded patch set 9.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:38:44 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8465/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:39:17 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:44:55 AM<br><strong>Message</strong>: <pre>Patch Set 9: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:45:58 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8465/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8465</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:48:00 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7440/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:48:44 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:49:44 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4306/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 7:50:27 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 8:09:37 AM<br><strong>Message</strong>: <pre>Patch Set 9: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 8:21:41 AM<br><strong>Message</strong>: <pre>Patch Set 9: F3-IntegrationTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 8:22:31 AM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7440/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/7440

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4306/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/4306</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/21/2018, 9:40:14 AM<br><strong>Message</strong>: <pre>Uploaded patch set 10.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:44:10 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8471/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:44:38 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:49:37 AM<br><strong>Message</strong>: <pre>Patch Set 10: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:50:16 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8471/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8471</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:51:59 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7447/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:52:28 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:53:00 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4312/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 9:53:36 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 10:11:17 AM<br><strong>Message</strong>: <pre>Patch Set 10: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 10:20:14 AM<br><strong>Message</strong>: <pre>Patch Set 10: F3-IntegrationTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/21/2018, 10:21:11 AM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7447/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/7447

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4312/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/4312</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/23/2018, 7:30:15 AM<br><strong>Message</strong>: <pre>Uploaded patch set 11: Patch Set 10 was rebased.</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/23/2018, 7:30:56 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Run VerifyBuild</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:35:37 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8492/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:36:04 AM<br><strong>Message</strong>: <pre>Patch Set 11: -F2-DocBuild -F1-VerifyBuild -F3-IntegrationTest -F3-UnitTest

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:40:50 AM<br><strong>Message</strong>: <pre>Patch Set 11: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:44:14 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4329/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:44:15 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7475/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:44:47 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 7:44:58 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 8:14:48 AM<br><strong>Message</strong>: <pre>Patch Set 11: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 8:16:20 AM<br><strong>Message</strong>: <pre>Patch Set 11: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 12/23/2018, 8:17:05 AM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/8492/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/8492

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/7475/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/7475

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/4329/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/4329</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 12/23/2018, 8:25:53 AM<br><strong>Message</strong>: <pre>Patch Set 11: Code-Review-1

-1 because we need to make `BlockCreator` tread safe</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 1/4/2019, 12:45:07 PM<br><strong>Message</strong>: <pre>Patch Set 11:

What's the status of this one?</pre><strong>Reviewer</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Reviewed</strong>: 1/8/2019, 1:19:12 AM<br><strong>Message</strong>: <pre>Abandoned

abandon in favor of https://gerrit.hyperledger.org/r/c/28541/1</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/6/2018, 6:04:08 AM<br><strong>UnmergedRevision</strong>: [1d812d0c8dd8f4a41d716612452f036754052db9](https://github.com/hyperledger-gerrit-archive/fabric/commit/1d812d0c8dd8f4a41d716612452f036754052db9)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 6:13:41 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 6:13:41 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 6:39:29 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 6:39:36 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/6/2018, 10:46:22 AM<br><strong>UnmergedRevision</strong>: [ea5d8cccbc656d5352595b84bd8cc67365c8bedd](https://github.com/hyperledger-gerrit-archive/fabric/commit/ea5d8cccbc656d5352595b84bd8cc67365c8bedd)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:00:21 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:00:21 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:22:52 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:27:10 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L19](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/blockcreator.go#L19)<br><strong>Comment</strong>: <pre>This phrasing suggests that if we reach this size even once, *all* subsequent calls to CreateNextBlock will return nil. I do not believe this is true? Instead, the call returns nil only *when* this many blocks are in-flight. LMK if I'm wrong.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L19](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/blockcreator.go#L19)<br><strong>Comment</strong>: <pre>you are correct, and thank you for editing it. Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L101](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/blockcreator.go#L101)<br><strong>Comment</strong>: <pre>Stack is not the right term because it suggests a LIFO order. Queue is more appropriate here.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L101](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/blockcreator.go#L101)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain_test.go#L1575](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/chain_test.go#L1575)<br><strong>Comment</strong>: <pre>Unclear what you mean here?</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain_test.go#L1575](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/chain_test.go#L1575)<br><strong>Comment</strong>: <pre>This is a TODO item with low priority. in this test, we are basically competing with raft go routine to saturate blockcreator's buffer. (most likely we are not going to lose)

To make it deterministic, we could introduce a delay factor to network, so we guarantee that consensus is delayed after blockcreator is full</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain_test.go#L1575](https://github.com/hyperledger-gerrit-archive/fabric/blob/ea5d8cccbc656d5352595b84bd8cc67365c8bedd/orderer/consensus/etcdraft/chain_test.go#L1575)<br><strong>Comment</strong>: <pre>Ack</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Created</strong>: 12/6/2018, 11:17:45 AM<br><strong>UnmergedRevision</strong>: [b2f0f6f978cf8e9b96b68799c802320683b8dff3](https://github.com/hyperledger-gerrit-archive/fabric/commit/b2f0f6f978cf8e9b96b68799c802320683b8dff3)<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Created</strong>: 12/6/2018, 11:19:14 AM<br><strong>UnmergedRevision</strong>: [6a81ba732d52605ad89a66e81ee8ae465c96f967](https://github.com/hyperledger-gerrit-archive/fabric/commit/6a81ba732d52605ad89a66e81ee8ae465c96f967)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:30:02 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 11:30:02 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 12:00:32 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/6/2018, 12:08:44 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 12/6/2018, 11:25:03 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L18](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L18)<br><strong>Comment</strong>: <pre>"... can be optimistically created by the leader."
IMO, this should suffice since the "not appended to the ledger yet" is implied in optimistic creation. The emphasis though is on having "can be" instead of "have been".</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L18](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L18)<br><strong>Comment</strong>: <pre>Excellent point. Corrected.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L46](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L46)<br><strong>Comment</strong>: <pre>probably now we need to add here blocks buffer size.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L116)<br><strong>Comment</strong>: <pre>@Adarsh: Can you please remind me what we mean here exactly? I was reading this comment and I was slightly lost.</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L116)<br><strong>Comment</strong>: <pre>This was in response to an earlier comment I believe in the original CR that sought clarification on when calls to WriteBlock are being made without calls to CreateNextBlock. The comment explains here that this happens for the followers in etcd/raft.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/blockcreator.go#L116)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>While it is important to handle the nil case (and I had done a shoddy job of not taking care of it) I don't see why we should return an error here leading to this batch being dropped. Will it be better to have `createNextBlock` block until there is free slot in the `CreatedBlocks` queue instead of returning nil? The other option would be to implement retries and then we come down to the problems of how many retries, etc.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Good point. I would really like us to avoid retries for the reason you mention above. The blocking option seems to suffer from the same criticism as well. Do you block just the `MaxBlocksCreated`+1 block? If not, how many do you hold? You need a buffer, and you need to decide on its size, etc.

I am slightly uneasy about this silent dropping that we're doing here, but I can't think of a better alternative. Wide open to suggestions though, and I'm good with discussing this further.</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>@Kostas I do remember you not liking retries (with which I agree) from our earlier discussions and the comment on retries was borrowed from your ideas :)

I agree that the silent dropping is not too much of a problem since we do not provide any guarantees to the users. In any case this should be an extremely rare case when the consensus is way too slow for the incoming load. But thinking twice this may not be such a rare case too depending upon the kind of workload that is being handled. 

At the same time I do not see any complication with the blocking API since the thread that is responsible for creating blocks would itself be blocked (and will therefore not process any new blocks) and there is no decision on how many blocks to hold, etc. Makes sense?</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> At the same time I do not see any complication with the blocking API since the thread that is responsible for creating blocks would itself be blocked (and will therefore not process any new blocks) and there is no decision on how many blocks to hold, etc. Makes sense?

Ah, interesting. What happens to new transactions that are proposed to the leader this timeframe?</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Nothing! The proposed transactions are required to be added to the submitC channel. Since the submitC channel is not bufferred, these routines trying to add the transactions to the submitC channel will block waiting for the serveRequest goroutine to read from the submitC channel, while serveRequest is blocked on the createNextBlock. So we should be safe on that front.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>There *must* be some effect higher up in the stack, no?

Assume that we have clients that keep pushing transactions to the system.

What happens then? The only way out is for the calls of the clients, or the proposals of the clients to the leader to fail.

Does this make sense?</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>I would think there is no prior to such a thing and it is up to us to decide the API we want to expose now. My take would be that if we want we can add a timeout to the following code block that attempts to add the transaction to the submitC channel:

> 
	if lead == c.raftID {
		select {
		case c.submitC <- req:
			return nil
		case <-c.doneC:
			return errors.Errorf("chain is stopped")
		}
	}</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Unless I'm missing something, it comes down to this: we either drop transactions _somewhere_ to relieve the system, or block the calls somewhere along the stack (from client to the OSN).  There is no other way, right?

With the current CR we get the former, and transactions are dropped silently as far as the client is concerned.

With the idea that we're entertaining now, we'd still be looking at one of the solutions above, and —

1. Dropping the transactions at any place other than the leader seems awfully complicated. If you are to drop these at the ingress points (followers or leader), it means that the followers need to keep track of whether the leader is backlogged or not.
2. Blocking any call means you need to have a buffer right at the point where you're blocked. If we don't want a buffer, we can make it the client's problem, which means we block at the call that the client is making to push a transaction to the system. But that strikes me as a bad design, and it also means that the proposal now becomes a synchronous call: client -> follower -> leader -> follower -> client response.

Again, I might be missing something, but the current approach strikes me as the least bad/complicated one, all things considered.</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>My take would be dropping individual transactions would be way better than dropping entire batches. We definitely need to drop these transactions at the leader. Dropping transactions would also be in-line with the no-promises approach to ordering that we have. Also, I think that is a fair thing to do since this implies that the system is overloaded and an overloaded system always drops packets ;)

> Blocking any call means you need to have a buffer right at the point where you're blocked.
The buffer here is the `CreatedBlocks` buffer and there is nothing new to add. 

> the proposal now becomes a synchronous call
I believe that is how it currently is at least for proposals submitted to the leader since these proposals are only 'accepted' once the leader's serveRequest routine is free to 'accept' them. I also just realized that we are exposing non-uniform APIs from the leader and the followers. Proposals to the leader in the current design are snychronous while that to the followers are asynchronous (need to verify the second part further).</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Ah, these are both great points. I had missed them both. Let's see what Jay thinks as well. Thanks Adarsh!</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Why couldn't we regress to the behavior prior to optimistic block creation - clients block waiting on envelopes being consumed by chain?

On the other hand, if we are to drop envelopes, we'd better surface the reason back to clients since we are certain about the reason. Otherwise, from client point of view, if envelope is silently dropped, it could not tell the different between consensus error (network partition, etc) *or* buffer overflow. I know we are not guaranteeing anything for clients anyway, but i think we shouldn't make it too mysterious.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>And what I'm suggesting here is to drop the message for now, and make it blocking after reconfiguration is settled. (or we could jump directly to that)</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> On the other hand, if we are to drop envelopes, we'd better surface the reason back to clients since we are certain about the reason. Otherwise, from client point of view, if envelope is silently dropped, it could not tell the different between consensus error (network partition, etc) *or* buffer overflow. I know we are not guaranteeing anything for clients anyway, but i think we shouldn't make it too mysterious.

I don't think we should invest any cycles on that, and being opaque is the way to go, even though we _know_ what's up. Let's stick to a contract that will be (almost?) identical to the BFT one.

> Why couldn't we regress to the behavior prior to optimistic block creation - clients block waiting on envelopes being consumed by chain?

Wait, was that the case? Fabric client foo would block in its broadcast until the proposed envelope was consumed by the chain?</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> Wait, was that the case? Fabric client foo would block in its broadcast until the proposed envelope was consumed by the chain?

Yes, that's true for
- solo (waiting for env to be consumed by `sendChan`
- and kafka, we are using SyncProducer
- and etcdraft prior to optimistic creation.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Define "consumed by the chain"? I had misinterpreted it as "appended to the chain" (as in the blockchain) whereas I think you're referring to the local Chain object.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>yep, consumed by Chain object. So, blocking point in our implementations are:
in solo: https://github.com/hyperledger/fabric/blob/abe9d79667ba7ccc2adca041449998d333b911d1/orderer/consensus/solo/consensus.go#L86-L89
in kafka: https://github.com/hyperledger/fabric/blob/abe9d79667ba7ccc2adca041449998d333b911d1/orderer/consensus/kafka/chain.go#L240-L243
in etcdraft: https://github.com/hyperledger/fabric/blob/master/orderer/consensus/etcdraft/chain.go#L392</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> Why couldn't we regress to the behavior prior to optimistic block creation - clients block waiting on envelopes being consumed by chain?

I do not think that the optimistic block creation has lead to any behavior change as far as the clients are concerned. Therefore, I can't make out the intent of this comment.

> we'd better surface the reason back to clients since we are certain about the reason.

I agree with Kostas that there is no point wasting cycles on this. Although, I am curious what could the clients do even if the errors were indeed propagated to them and even if do spend cycles on that if that would bring any benefit. I guess logging such transaction drops should suffice so that the orderer admins can diagnose the system.

> And what I'm suggesting here is to drop the message for now, and make it blocking after reconfiguration is settled.

Jay, it isn't clear to me if you meant dropping batches since that is what we are doing right now as the CR stands or if you meant we actually drop the envelopes during submit for which i would think that we need to add a timeout while waiting to add the envelope to the submitC channel.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>OK, let me summarize, we basically have two options here:
1. clients block waiting for envelopes to be consumed by `serveReq`. This is the behavior we had before
2. drop envelopes or batches

And I'm proposing #1. but i'd like to wait out the reconfiguration.

> I do not think that the optimistic block creation has lead to any behavior change as far as the clients are concerned. Therefore, I can't make out the intent of this comment.

It does. with optimistic, we have to make this decision, otherwise orderer crashes. without optimistic, we don't have any decision to make (and we don't even have the option of droping envelopes)</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> we need to add a timeout while waiting to add the envelope to the submitC channel.

Although i'm not in favor of dropping env, but if we are ever considering it, i'd say we should not introduce timeout - we just drop them silently and call it a day, simply because it makes code simpler.</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>> clients block waiting for envelopes to be consumed by `serveReq`

I agree with this and that is what I had proposed in the beginning of this comment thread. But then would we like to have the clients wait indefinitely? I think not. And therefore I was proposing the timeout and I do not see any code complications here beyond adding another timer case to the select. 

> It does. with optimistic, we have to make this decision, otherwise orderer crashes. without optimistic, we don't have any decision to make

Actually even without optimistic we had _implicitly_ made this decision to make the clients block. This is what I had meant by saying that optimistic does not change the behavior as seen by clients. With optimistic this decision takes effect much later since we have the opportunity to accommodate multiple blocks before having to come to the state where clients are blocked.</pre><strong>Commenter</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>i'm not really sure what we are arguing about here... let's simplify this by asking:

do you agree that clients should block waiting for some more room freed up in buffer? If yes, then we have consensus.

In terms of timeout, i think it's at least out of scope of this CR. We didn't have this api contract before, and more reasoning is needed IMO, e.g. why shouldn't that timeout be at client side?</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>Oh yes I definitely agree just as I had said in the previous comment :)
Sure we can discuss the timeout issue for a separate CR.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>I know I'm a bit late to this discussion, but I think that blocking or throttling clients seems much more intuitive and client friendly approach, rather than dropping batches or envelopes.

Also I think if we are to drop something we at least have to put information about dropped envelopes into log, by the end of the day someone has to support. So bare minimum is to put information about dropped message at least txid's pr something.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>What also bothers me here, is that for overly saturated leader we going constantly to drop batches, moreover we are dropping all batches once buffer is full. E.g. buffer is with 19 blocks we trying to commit another 11 batches, 10 of which will be dropped w/o any feedback to the client.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>I'm even more late for this discussion, but I'll add my opinion regardless :) 

TLDR - like Artem said, I think we should not drop blocks... let me explain why and what we should do intstead:

Long term: 
I don't think we should adopt the current behavior that (unless I'm mistaken) - makes the batch be dropped, while at the same time I don't think we should block at the leader side. 
Essentially what we have here is a queue placed in the leader that has an upper bound at the rate of queue consumption, and several followers, all forwarding transactions to the leader, which makes it want to cut blocks (but it can't do that fast enough...). 
There are 2 places where we can block:
1) Blocking at the leader, when the submitC channel is too full and we can't enqueue further transactions.
This is only possible if we change the semantic of the block creator to block when enqueuing and not return nil like we do now. I think we should do that, because blocking the submit channel makes all Submit RPC streams in all followers to be throttled. Recall that there is a single gRPC stream between a follower and its leader, so the number of producers that produce "work" for the queue in the leader is finite and small, so this is a safe way of throttling. 

2) Blocking at the followers when forwarding transactions - here I don't think we should block, but instead we should have an internal buffer (i.e a channel) for transactions forwarded to the leader, and if that buffer fills up - we should return service unavailable or something similar. This is because there is no upper bound on the number of clients, and if the consensus can't deal with the rate of incoming work - the application layer should handle it. 

Why I don't think we should drop transactions: 
- Transactions are usually based on previous transactions. If we drop a transaction T0 that was created before T1, if T1 gets into the block - it'll be invalidated by MVCC.
- Dropping transactions makes applications wait for a commit of a block that never arrives, and this is only resolved by a timeout, which impairs user experience. 


Short term:
We need to get this thing done one way or another... I think that we can table throttling at the followers for a later time (and open a JIRA for it), and for now - we can just change the semantic of the block creator to not return nil, but instead block, which would throttle the SubmitC, which would transitively throttle all followers, and make requests pile up in them via the gRPC infrastructure.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>By the way - the block cutting is actually not the real bottleneck here, but (I think) it is the raft proposals.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>I agree with the short-term solution.

For the long-term solution, the contract with the client essentially becomes:
1. Success: "I forwarded your transaction to the leader successfully"
2. Service unavailable: "I'm full, I cannot process your transaction"
Correct?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain.go#L548](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain.go#L548)<br><strong>Comment</strong>: <pre>yeah, but - that's already the existing contract... clients should know how to handle service unavailable since a Kafka OSN also throws this when it's disconnected from Kafka</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/chain_test.go#L1570](https://github.com/hyperledger-gerrit-archive/fabric/blob/6a81ba732d52605ad89a66e81ee8ae465c96f967/orderer/consensus/etcdraft/chain_test.go#L1570)<br><strong>Comment</strong>: <pre>I believe this test can be better written differently (since we have access to the exported `CreatedBlocks` queue). But I will defer that until there is an answer to my comment on whether we should return error when the block creator is full.</pre></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Created</strong>: 12/7/2018, 9:59:06 AM<br><strong>UnmergedRevision</strong>: [ba5bbff24f835cef458b2be91da19129e6b24884](https://github.com/hyperledger-gerrit-archive/fabric/commit/ba5bbff24f835cef458b2be91da19129e6b24884)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/7/2018, 10:07:58 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/7/2018, 10:07:58 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/7/2018, 10:33:32 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/7/2018, 11:31:28 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Approved</strong>: 12/9/2018, 5:56:30 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Approved</strong>: 12/10/2018, 4:19:36 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L21](https://github.com/hyperledger-gerrit-archive/fabric/blob/ba5bbff24f835cef458b2be91da19129e6b24884/orderer/consensus/etcdraft/blockcreator.go#L21)<br><strong>Comment</strong>: <pre>Can we expose this into orderer.yaml file? Also 20 seems a bit too conservative? Why can't we have larger default, say 100?</pre><strong>Commenter</strong>: Adarsh Saraf - adarshsaraf123@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/etcdraft/blockcreator.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/ba5bbff24f835cef458b2be91da19129e6b24884/orderer/consensus/etcdraft/blockcreator.go#L116)<br><strong>Comment</strong>: <pre>Definitely better phrased! Thanks!</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/16/2018, 3:46:07 PM<br><strong>UnmergedRevision</strong>: [16e27d22912f50f6b82f145614efc1f523dad6e3](https://github.com/hyperledger-gerrit-archive/fabric/commit/16e27d22912f50f6b82f145614efc1f523dad6e3)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/16/2018, 3:49:57 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: NO_CODE_CHANGE<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/16/2018, 3:47:48 PM<br><strong>UnmergedRevision</strong>: [375eabfbed4bf93cba523aaccf34c7a2e3e99fb5](https://github.com/hyperledger-gerrit-archive/fabric/commit/375eabfbed4bf93cba523aaccf34c7a2e3e99fb5)<br><br></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: NO_CHANGE<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/16/2018, 3:49:10 PM<br><strong>UnmergedRevision</strong>: [3598123113fcbc98eeef8e8c9726c73960098def](https://github.com/hyperledger-gerrit-archive/fabric/commit/3598123113fcbc98eeef8e8c9726c73960098def)<br><br></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/21/2018, 7:34:48 AM<br><strong>UnmergedRevision</strong>: [449be1e1c398762ad487d7f0a908c44138d00baa](https://github.com/hyperledger-gerrit-archive/fabric/commit/449be1e1c398762ad487d7f0a908c44138d00baa)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 7:44:55 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 7:44:55 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 8:21:41 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 8:09:37 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 10</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/21/2018, 9:40:14 AM<br><strong>UnmergedRevision</strong>: [42462c2d530d53a0e268d6369b7511365ba13bc7](https://github.com/hyperledger-gerrit-archive/fabric/commit/42462c2d530d53a0e268d6369b7511365ba13bc7)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 9:49:37 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 9:49:37 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 10:20:14 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/21/2018, 10:11:17 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 11</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Uploader</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Created</strong>: 12/23/2018, 7:30:15 AM<br><strong>UnmergedRevision</strong>: [8d02ee07493c5cb2a779ef02291c69f6c32f48f6](https://github.com/hyperledger-gerrit-archive/fabric/commit/8d02ee07493c5cb2a779ef02291c69f6c32f48f6)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/23/2018, 7:40:50 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/23/2018, 7:40:50 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/23/2018, 8:16:20 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 12/23/2018, 8:14:48 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jay Guo - guojiannan1101@gmail.com<br><strong>Approved</strong>: 12/23/2018, 8:25:53 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote>