<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 2503<br><strong>Subject</strong>: Fix bugs in MockStub implementation of GetRows<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 11/16/2016, 12:41:39 AM<br><strong>LastUpdated</strong>: 12/11/2016, 10:39:09 PM<br><strong>CommitMessage</strong>:<br><pre>Fix bugs in MockStub implementation of GetRows

This also adds more unit tests for MockStub GetRows.

Change-Id: I1d56da359a49769c2dc653cb3aa1d0d0aaa8413d
Signed-off-by: Victor Dods <victor.dods@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Reviewed</strong>: 11/16/2016, 12:41:39 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 12:42:31 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1651/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 12:44:36 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2806/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/16/2016, 1:01:20 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1651/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2806/ : FAILURE</pre><strong>Reviewer</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Reviewed</strong>: 11/17/2016, 2:56:53 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 3:01:03 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1765/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 4:21:45 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1765/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2921/ : SUCCESS</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 11/18/2016, 1:24:55 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

(3 comments)

1. LGTM. Nice work Victor!

2. I put a few inline comments that are "nice to haves", should you choose to address them. But we can merge this without them.

3. BTW (in the future): Even though it's a small fix, you may want to open issues in JIRA so that we can better document such changes.</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 11/18/2016, 4:47:27 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+1</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 11/18/2016, 7:43:41 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(2 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 11/20/2016, 12:46:46 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 11/20/2016, 1:18:44 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review-1

(Given Manish's response.)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 11/20/2016, 1:36:13 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 12/6/2016, 1:00:53 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Reviewed</strong>: 12/11/2016, 10:39:09 PM<br><strong>Message</strong>: <pre>Abandoned

Abandoned in order to re-submit with a single commit.</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Victor Dods - victor.dods@gmail.com<br><strong>Uploader</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Created</strong>: 11/16/2016, 12:41:39 AM<br><strong>UnmergedRevision</strong>: [b45deab6927237a077a2ba463408cf1bb04366b5](https://github.com/hyperledger-gerrit-archive/fabric/commit/b45deab6927237a077a2ba463408cf1bb04366b5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/16/2016, 1:01:20 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Victor Dods - victor.dods@gmail.com<br><strong>Uploader</strong>: Victor Dods - victor.dods@ledgerdomain.com<br><strong>Created</strong>: 11/17/2016, 2:56:53 PM<br><strong>UnmergedRevision</strong>: [76449687514ed8428c5ff27963a6c4c963c71cd1](https://github.com/hyperledger-gerrit-archive/fabric/commit/76449687514ed8428c5ff27963a6c4c963c71cd1)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/17/2016, 4:21:45 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Approved</strong>: 11/18/2016, 7:43:41 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Approved</strong>: 11/20/2016, 1:18:44 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 11/18/2016, 4:47:27 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/shim/chaincode.go#L642](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/chaincode.go#L642)<br><strong>Comment</strong>: <pre>I'd like Manish to weigh in on this.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/shim/chaincode.go#L642](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/chaincode.go#L642)<br><strong>Comment</strong>: <pre>If I understand this correctly - the attempt is to handle a special case where the caller of this method supplies the values for all the primary key columns. The answer should be a single row which would be missed with the previous logic. 

If my understanding is correct, can we simply enhance the condition at line 629 to cover this case as well (just an alternate suggestion) 

I am fine with the new logic as well however, in that case, I would prefer to move the appending of `0` at the end of the key (for exact lookup case) inside the method `buildKeyString()` rather than repeating it at different places.

Please correct me if I have misunderstood the whole story here as I could not find the reference to the bug in the commit message and just guessing what bug may have surfaced.</pre><strong>Commenter</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/shim/chaincode.go#L656](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/chaincode.go#L656)<br><strong>Comment</strong>: <pre>we also need a "recover()" in the defer where blocking "rows <- row" raises a panic because the iterator has been closed. This will happen if the invoke / query returns without draining all the rows.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/shim/chaincode.go#L656](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/chaincode.go#L656)<br><strong>Comment</strong>: <pre>Murali - I think that I do not understand this comment fully. Do you mean that the caller closes the channel `rows`? If yes then that is not possible because the return type of this function is a read only channel and cannot be closed by the caller. Please clarify if you meant something else...</pre><strong>Commenter</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/shim/chaincode.go#L656](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/chaincode.go#L656)<br><strong>Comment</strong>: <pre>Hi Manish, I did not mean that. What I meant was the request returns from the chaincode without the chaincode draining all the rows. The underlying framework would clean up. I have to recall the exact details but this cause the block channel read to raise a panic. This is easy to test create 1000 rows but just read 1 in the chaincode and return from the query.</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [core/chaincode/shim/mockstub.go#L366](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/mockstub.go#L366)<br><strong>Comment</strong>: <pre>How about:

"Called HasNext() on an iterator that is already closed."</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [core/chaincode/shim/mockstub.go#L373](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/mockstub.go#L373)<br><strong>Comment</strong>: <pre>Maybe some more details? E.g. shedding more light about the logic (now that you are at it).

Maybe more along the lines of: "Error in HasNext() as Current is nil and ..."</pre><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [core/chaincode/shim/mockstub.go#L388](https://github.com/hyperledger-gerrit-archive/fabric/blob/76449687514ed8428c5ff27963a6c4c963c71cd1/core/chaincode/shim/mockstub.go#L388)<br><strong>Comment</strong>: <pre>Speaking of debugging: we could also print out that Value.(string)... when at the end of the range, etc.</pre></blockquote>