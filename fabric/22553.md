<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 22553<br><strong>Subject</strong>: [FAB-10469] Gossip: Don't lock when sending<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 5/30/2018, 2:01:29 PM<br><strong>LastUpdated</strong>: 6/8/2018, 11:11:17 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-10469] Gossip: Don't lock when sending

The gossip connection locks the connection to preserve FIFO order
when waiting for room in the output buffer to be available.

A gossip connection has a corresponding goroutine for each reading
or writing from the input/output buffer for the connection.

When a connection is ordered to send a message, it tries to enqueue
it into the output buffer, and if there is no room - it discards
the message to not block the application layer.

However, private data message shouldn't be discarded and the goroutine
sending them should wait for room to be available in the buffer.
The problem is, that this is done under a lock and thus the following
might occur:

peer p sends to peer q a private data message and q sends one to p.
If p's and q's output buffers are full, the goroutine that send()s
holds the lock, and waits for the output buffer to have room.

However, to drain the receive buffer on the other side, both
peers also need to obtain a lock on the connection.
This results in a distributed deadlock.

The most sensible fix in my opinion is to just no lock the connection
when waiting on the output buffer.

Change-Id: I63a64e9cf08364d2023d99f2bedb1e382765e6a8
Signed-off-by: yacovm <yacovm@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/30/2018, 2:01:29 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:05:11 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/2199/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:05:32 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:11:01 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1 F3-IntegrationTest+1

Succeeded, Run SmokeTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:11:24 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/2199/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/2199</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:13:25 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-smoke-tests-x86_64/1473/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:13:54 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting smoke tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:26:08 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-SmokeTest+1

Succeeded, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:30:16 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2357/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:30:40 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:37:26 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:38:01 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2357/ : FAILURE (skipped)

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2357/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/2357

https://jenkins.hyperledger.org/job/fabric-smoke-tests-x86_64/1473/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-smoke-tests-x86_64/1473</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/30/2018, 2:38:12 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:41:12 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2359/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:41:38 PM<br><strong>Message</strong>: <pre>Patch Set 1: -F3-UnitTest

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:55:45 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/30/2018, 2:56:17 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2359/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/2359</pre><strong>Reviewer</strong>: Divyank Katira - divyanktk@gmail.com<br><strong>Reviewed</strong>: 6/7/2018, 4:38:23 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+1</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 6/7/2018, 5:46:44 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 6/8/2018, 10:46:04 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2

Thanks to Yacov for DM discussion on this. Given that FIFO order preservation is just a small optimization (receiving peer has to order anyway) and that we are now dropping messages instead of blocking (and given other's approvals of course), LGTM.</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 6/8/2018, 10:48:04 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Srinivasan Muralidharan</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/8/2018, 10:50:39 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/3984/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/8/2018, 10:50:55 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/2654/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/8/2018, 11:11:17 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/2654/ : FAILURE (skipped)

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/2654/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/2654

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/3984/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/3984</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Uploader</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Created</strong>: 1527703289<br><strong>GitHubRevision</strong>: [f9e47ada6a4ea0f62f6f17e856833c7602ad7b7e](https://github.com/hyperledger/fabric/commit/f9e47ada6a4ea0f62f6f17e856833c7602ad7b7e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/30/2018, 2:11:01 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/30/2018, 2:11:01 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/30/2018, 2:26:08 PM<br><strong>Type</strong>: F2-SmokeTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/30/2018, 2:11:01 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/30/2018, 2:55:45 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Approved</strong>: 6/8/2018, 10:46:04 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Srinivasan Muralidharan<br><strong>Merged</strong>: 6/8/2018, 10:48:04 AM<br><br><strong>Approver</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Approved</strong>: 6/7/2018, 5:46:44 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Divyank Katira - divyanktk@gmail.com<br><strong>Approved</strong>: 6/7/2018, 4:38:23 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>