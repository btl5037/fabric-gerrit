<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 27520<br><strong>Subject</strong>: [FAB-11837] Track membership changes<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Inbar Badian - inbar.badian@ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 11/13/2018, 8:16:09 AM<br><strong>LastUpdated</strong>: 11/20/2018, 10:00:26 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-11837] Track membership changes

adding a struct named mt to gossip channel to
track after membership changes per channel

Change-Id: Ibdc87ef300a491a5960179b913f27c6f6fe50518
Signed-off-by: Inbar Badian <Inbar.Badian@ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Inbar Badian - inbar.badian@ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 8:16:09 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/13/2018, 8:20:48 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7054/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/13/2018, 8:21:23 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/13/2018, 8:23:01 AM<br><strong>Message</strong>: <pre>Patch Set 1: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/13/2018, 8:23:50 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7054/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7054</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 8:44:55 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1

(6 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 8:50:16 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 8:52:17 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 8:55:53 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(7 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 1:27:57 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(19 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 4:26:09 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(5 comments)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/13/2018, 4:27:39 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 11/20/2018, 10:00:26 AM<br><strong>Message</strong>: <pre>Abandoned

.</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Inbar Badian - Inbar.Badian@ibm.com<br><strong>Uploader</strong>: Inbar Badian - inbar.badian@ibm.com<br><strong>Created</strong>: 11/13/2018, 8:16:09 AM<br><strong>UnmergedRevision</strong>: [ca04dd911102dbc29c18880212f7b1a40742ad34](https://github.com/hyperledger-gerrit-archive/fabric/commit/ca04dd911102dbc29c18880212f7b1a40742ad34)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/13/2018, 8:23:01 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 11/13/2018, 8:44:55 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [/COMMIT_MSG#L9](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34//COMMIT_MSG#L9)<br><strong>Comment</strong>: <pre>membershipTracker</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L17](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L17)<br><strong>Comment</strong>: <pre>please fix imports</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L147](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L147)<br><strong>Comment</strong>: <pre>remove space</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L273](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L273)<br><strong>Comment</strong>: <pre>please make this configurable in core.yaml</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L281](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L281)<br><strong>Comment</strong>: <pre>INFO</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L978](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L978)<br><strong>Comment</strong>: <pre>tracking</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L978](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L978)<br><strong>Comment</strong>: <pre>of the channel</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L986](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L986)<br><strong>Comment</strong>: <pre>the description doesn't quite fit the signature</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L986](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L986)<br><strong>Comment</strong>: <pre>prefix with 'checkIfPeersChanged'</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L989](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L989)<br><strong>Comment</strong>: <pre>is still online</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L991](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L991)<br><strong>Comment</strong>: <pre>var wereInPrev [][]string

see https://stackoverflow.com/a/29164565/8211613</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L997](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L997)<br><strong>Comment</strong>: <pre>I hope this is not too much to ask, but - in many cases, the internal and external endpoint are the same. 

Can you make it that only one of them is printed in case they are the same?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1006](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1006)<br><strong>Comment</strong>: <pre>var x [][]string</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1017](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1017)<br><strong>Comment</strong>: <pre>please extract this into a function</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1020](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1020)<br><strong>Comment</strong>: <pre>I think that "Membership view has changed" is preferable over "Peers have been changed"</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1029](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1029)<br><strong>Comment</strong>: <pre>// trackMembershipChanges tracks changes in peer membership.


No need to explain in the method comment about the implementation details :)</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1043](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1043)<br><strong>Comment</strong>: <pre>I think this can be removed</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1045](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1045)<br><strong>Comment</strong>: <pre>is this used in any way?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1059](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1059)<br><strong>Comment</strong>: <pre>I think this can be removed</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1061](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1061)<br><strong>Comment</strong>: <pre>is this used in any way?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel.go#L1063](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel.go#L1063)<br><strong>Comment</strong>: <pre>what if the membership view changes between this invocation to the next iteration?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L69](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L69)<br><strong>Comment</strong>: <pre>these are only used in the test you added, so perhaps you should define them in the test body?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L1991](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L1991)<br><strong>Comment</strong>: <pre>perhaps consider renaming this?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L1992](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L1992)<br><strong>Comment</strong>: <pre>maybe something like "expectedReportInvocation" ?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L1997](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L1997)<br><strong>Comment</strong>: <pre>you can just use an anonymous function here instead</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L1999](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L1999)<br><strong>Comment</strong>: <pre>can you use an anonymous function  instead?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2001](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2001)<br><strong>Comment</strong>: <pre>why not move this into the test function? after all - it is not reused in any way...</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2070](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2070)<br><strong>Comment</strong>: <pre>any reason this is not parallelized?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2075](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2075)<br><strong>Comment</strong>: <pre>you change this to true, and then at line 2135 you compare with the expected from the test case.
However - once this is set to true, it is never re-set to false. 

you should add:

			defer func() {
				invokedReport = false
			}()

or something equivalent in the testcase function body, to avoid false positives.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2082](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2082)<br><strong>Comment</strong>: <pre>can you explain why we need this?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2102](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2102)<br><strong>Comment</strong>: <pre>consider some refactoring that involves extracting to a function and calling it.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2120](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2120)<br><strong>Comment</strong>: <pre>remove</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2131](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2131)<br><strong>Comment</strong>: <pre>you don't need the if condition</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2144](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2144)<br><strong>Comment</strong>: <pre>please add some comments explaining the scenario that is tested</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2145](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2145)<br><strong>Comment</strong>: <pre>any reason not to add t.Parallel() ?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2152](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2152)<br><strong>Comment</strong>: <pre>consider grouping the adapter setup together if possible.
You can move this block below to join the block in line 2172.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2154](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2154)<br><strong>Comment</strong>: <pre>remove</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2178](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2178)<br><strong>Comment</strong>: <pre>can we try not to sleep in the test?</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2181](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2181)<br><strong>Comment</strong>: <pre>remove</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2193](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2193)<br><strong>Comment</strong>: <pre>if you replace this line with: 
panic("bla")

the test still passes...</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/channel/channel_test.go#L2206](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/channel/channel_test.go#L2206)<br><strong>Comment</strong>: <pre>what is missing here (I think...) is an assertion that GetMembership was invoked at all. 

Consider using adapter.AssertCalled or adapter.AssertNumberOfCalls()</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/gossip/gossip_impl.go#L299](https://github.com/hyperledger-gerrit-archive/fabric/blob/ca04dd911102dbc29c18880212f7b1a40742ad34/gossip/gossip/gossip_impl.go#L299)<br><strong>Comment</strong>: <pre>is this needed?</pre></blockquote>