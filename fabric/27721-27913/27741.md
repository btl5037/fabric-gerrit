<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 27741<br><strong>Subject</strong>: FAB-613 Add Kafka metrics for orderer<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 11/26/2018, 3:17:03 PM<br><strong>LastUpdated</strong>: 11/28/2018, 4:41:50 PM<br><strong>CommitMessage</strong>:<br><pre>FAB-613 Add Kafka metrics for orderer

This CR adds a simple polling wrapper around the go-metrics metric
registry logic that Sarama already implements.  It converts all of the
exposed per broker/topic metrics to gauges and exposes those gauges
through the go-kit metrics.

Change-Id: I0847cf01262f2fdd87b5ae3e4338c7a49314cd08
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/26/2018, 3:17:03 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/26/2018, 3:19:12 PM<br><strong>Message</strong>: <pre>Patch Set 1:

I still don't like the way the polling go routine is spawned/managed, but, wanted to get this pushed out here for review in case there are more structural objections before I begin trying to wire cleanup of the polling go routine into the orderer server/main.go</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 3:22:21 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7500/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 3:22:58 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 3:23:00 PM<br><strong>Message</strong>: <pre>Patch Set 1: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 3:24:01 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7500/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7500</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/26/2018, 9:11:26 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 9:16:52 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7507/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 9:17:35 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 9:19:08 PM<br><strong>Message</strong>: <pre>Patch Set 2: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 9:20:11 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7507/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7507</pre><strong>Reviewer</strong>: Sambhav Nidamarty - sambhavdutt@gmail.com<br><strong>Reviewed</strong>: 11/26/2018, 10:42:23 PM<br><strong>Message</strong>: <pre>Patch Set 2:

VerifyBuild</pre><strong>Reviewer</strong>: Sambhav Nidamarty - sambhavdutt@gmail.com<br><strong>Reviewed</strong>: 11/26/2018, 10:42:27 PM<br><strong>Message</strong>: <pre>Removed reviewer Sambhav Nidamarty.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 10:47:54 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7508/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 10:48:34 PM<br><strong>Message</strong>: <pre>Patch Set 2: -F1-VerifyBuild

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 10:49:59 PM<br><strong>Message</strong>: <pre>Patch Set 2: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/26/2018, 10:50:49 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7508/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7508</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 12:34:52 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:39:42 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7509/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:40:23 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:48:12 AM<br><strong>Message</strong>: <pre>Patch Set 3: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:48:52 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7509/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7509</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:50:33 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6499/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:51:11 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:51:30 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3583/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 12:52:23 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:12:08 AM<br><strong>Message</strong>: <pre>Patch Set 3: F3-IntegrationTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:16:59 AM<br><strong>Message</strong>: <pre>Patch Set 3: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:17:40 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6499/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6499

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3583/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3583</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 9:53:32 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 9:56:54 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7528/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 9:57:38 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:07:26 AM<br><strong>Message</strong>: <pre>Patch Set 4: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:08:15 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7528/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7528</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:10:20 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6517/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:10:25 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3597/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:11:01 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:11:18 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:30:56 AM<br><strong>Message</strong>: <pre>Patch Set 4: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:38:59 AM<br><strong>Message</strong>: <pre>Patch Set 4: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 10:39:48 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6517/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6517

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3597/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3597</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 12:22:39 PM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+1

(7 comments)

I believe sarama.NewConfig() already creates a registry and sets it on the config object. Is there a reason why that reference can't be used instead of having to wire it to config?

The rest of the comments are style based so feel free to do what you wish.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 1:17:24 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 1:18:15 PM<br><strong>Message</strong>: <pre>Patch Set 4:

(7 comments)

Modified to re-use the metrics registry that sarama creates and added panic-ing behavior.  Would prefer to leave the other style points intact.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:21:23 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7538/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:22:06 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:30:26 PM<br><strong>Message</strong>: <pre>Patch Set 5: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:31:13 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7538/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7538</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:32:53 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6526/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:33:26 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3605/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:33:49 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:34:22 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 1:56:56 PM<br><strong>Message</strong>: <pre>Patch Set 5: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 2:03:55 PM<br><strong>Message</strong>: <pre>Patch Set 5: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/27/2018, 2:04:48 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6526/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6526

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3605/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3605</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 11/27/2018, 2:33:42 PM<br><strong>Message</strong>: <pre>Patch Set 5: Code-Review+2</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/27/2018, 3:27:14 PM<br><strong>Message</strong>: <pre>Patch Set 5:

(3 comments)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 9:48:40 AM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 9:49:03 AM<br><strong>Message</strong>: <pre>Patch Set 6:

(3 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 9:51:16 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7580/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 9:51:53 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 9:59:48 AM<br><strong>Message</strong>: <pre>Patch Set 6: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:00:34 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/7580/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/7580</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:01:51 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6559/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:02:26 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3649/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:02:30 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:03:36 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:20:46 AM<br><strong>Message</strong>: <pre>Patch Set 6: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/28/2018, 10:30:58 AM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+2

(2 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:39:13 AM<br><strong>Message</strong>: <pre>Patch Set 6: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 10:40:04 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6559/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6559

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/3649/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/3649</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 11:45:22 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 11:49:39 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6566/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 11:50:21 AM<br><strong>Message</strong>: <pre>Patch Set 6: -F3-UnitTest

Starting unit tests</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 12:01:49 PM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 12:13:46 PM<br><strong>Message</strong>: <pre>Patch Set 6: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 12:14:28 PM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6566/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6566</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 2:20:49 PM<br><strong>Message</strong>: <pre>Patch Set 7: Patch Set 6 was rebased</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/28/2018, 2:25:53 PM<br><strong>Message</strong>: <pre>Patch Set 7:

(1 comment)

Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 2:33:52 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6575/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 2:34:36 PM<br><strong>Message</strong>: <pre>Patch Set 7: -F3-UnitTest

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 3:01:29 PM<br><strong>Message</strong>: <pre>Patch Set 7: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 3:02:15 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/6575/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/6575</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/28/2018, 4:05:06 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Kostas Christidis</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 4:08:07 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/3723/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 4:08:37 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5045/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/28/2018, 4:41:50 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5045/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/5045

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/3723/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/3723</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/26/2018, 3:17:03 PM<br><strong>UnmergedRevision</strong>: [1313c0f9bbd3662a8afe927325008a2e369203c8](https://github.com/hyperledger-gerrit-archive/fabric/commit/1313c0f9bbd3662a8afe927325008a2e369203c8)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/26/2018, 3:23:00 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/26/2018, 9:11:26 PM<br><strong>UnmergedRevision</strong>: [a5dc6c1314c9dcb84d1b5b147630cb08b3b8c5dd](https://github.com/hyperledger-gerrit-archive/fabric/commit/a5dc6c1314c9dcb84d1b5b147630cb08b3b8c5dd)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/26/2018, 10:49:59 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/27/2018, 12:34:52 AM<br><strong>UnmergedRevision</strong>: [752731c18138f09b6e77d68d1dc747c2c460ce75](https://github.com/hyperledger-gerrit-archive/fabric/commit/752731c18138f09b6e77d68d1dc747c2c460ce75)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 12:48:12 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 12:48:12 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 1:12:08 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 1:16:59 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/27/2018, 9:53:32 AM<br><strong>UnmergedRevision</strong>: [2ed2d969085d877979e00b97df0dc8b8a7ac3e93](https://github.com/hyperledger-gerrit-archive/fabric/commit/2ed2d969085d877979e00b97df0dc8b8a7ac3e93)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 10:07:26 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 10:07:26 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 10:30:56 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 10:38:59 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 11/27/2018, 12:22:39 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>Can we put a CR on top that makes this duration configurable?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>I am a bit on the fence about this.  The issue is that for the "Meters" the duration pulled over is hardcoded at "Rate1" (ie, rate over the last minute).  So, polling less frequently than every minute means you are discarding data.  We can of course make this configurable, it just seemed like the odds of people getting it wrong was a bit high.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>Isn't this an argument for not making this an input argument at all then?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>Yes, however, it would make testing this function rather obnoxious (as the timer would be fixed ticking at one minute).  I don't love the idea of exposing the 'minute' cadence outside of the Kafka package, but the complexity of not doing it did not seem worth it.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>Ack</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>Jason, I don't really follow what you're saying but I am not the domain expert here. To me, we're mirroring what's maintained by Sarama in go-metrics as fabric gauges. It shouldn't matter how often that mirroring takes place.

go-metrics maintains a registry that should only be modified when observations are made - not necessarily when they're read.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/server/main.go#L406](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/common/server/main.go#L406)<br><strong>Comment</strong>: <pre>When reading the go-metric meters, you must specify the history period over which to read them.  e.g. Rate1 gives you the rate for the meter based on the data collected over the last minute and Rate5 gives you the rate for the meter based on the data collected over the last 5 minutes.

So, if we were to call Rate1 (as is hardcoded) once every 5 minutes, we would effectively be ignoring all of the samples gathered in the four minutes prior to the minute prior to the invocation.

One would naturally expect that if you set the polling frequency to 5 minutes, that you would be receiving data from the last 5 minutes, but this is not the case.  You are receiving data from the last minute regardless of when the poll takes place.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/config.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/config.go#L30)<br><strong>Comment</strong>: <pre>doesn't this build the metrics registry?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/config.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/config.go#L30)<br><strong>Comment</strong>: <pre>It does build one, yes.  I suppose we could simply yank it out on return and avoid this step wiring.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/consenter.go#L26](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/consenter.go#L26)<br><strong>Comment</strong>: <pre>I thought that the implementation of sarama.NewConfig already created a registry and exposed it on the resulting config struct?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/consenter.go#L26](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/consenter.go#L26)<br><strong>Comment</strong>: <pre>It does, though the examples in the Sarama documentation showed wiring in an external registry rather than pulling out the automatically created one.  But yes, I see no reason why we can't simply re-use the sarama generated one.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L217)<br><strong>Comment</strong>: <pre>Seems like this is the sort of invariant that should actually result in a panic during integration tests.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L217)<br><strong>Comment</strong>: <pre>Will modify to panic.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L233](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L233)<br><strong>Comment</strong>: <pre>Seems like this is the sort of invariant that should actually result in a panic during integration tests.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L233](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L233)<br><strong>Comment</strong>: <pre>I can modify this to panic, sure.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L240)<br><strong>Comment</strong>: <pre>It's a style thing but I'd prefer to see all three of these closing functions implemented as named methods or functions. What's here works but it's unclear.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L240)<br><strong>Comment</strong>: <pre>My initial implementation approach was to separate these as named functions.  But, then the metric name and value had to also be passed in as parameters, which seemed to bloat the calls unnecessarily to me.  Since these are so specific to the naming convention of the metrics exposed by sarama, I didn't see a ton of re-usability in making them named functions, so I would prefer to leave them as closures.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L256](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L256)<br><strong>Comment</strong>: <pre>I also think this is less clear than it could be by relying on the side effect of returning false to continue through the cases instead of matching on the name that was provided during the walk.

It's not wrong and it works.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L256](https://github.com/hyperledger-gerrit-archive/fabric/blob/2ed2d969085d877979e00b97df0dc8b8a7ac3e93/orderer/consensus/kafka/metrics.go#L256)<br><strong>Comment</strong>: <pre>Matching on the metric name, then triggering processing was also part of my first pass.  However, because it stretched the switch over more lines and added a bit more repetition, I opted to consolidate it with the false return cascade seen here.  So, baring other objections, I will leave this as is.</pre></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/27/2018, 1:17:24 PM<br><strong>UnmergedRevision</strong>: [20a56c6017db7439d0d238ece5cf5ed924d258d7](https://github.com/hyperledger-gerrit-archive/fabric/commit/20a56c6017db7439d0d238ece5cf5ed924d258d7)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 1:30:26 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 1:30:26 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 1:56:56 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/27/2018, 2:03:55 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 11/27/2018, 2:33:42 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/20a56c6017db7439d0d238ece5cf5ed924d258d7/orderer/consensus/kafka/metrics.go#L80)<br><strong>Comment</strong>: <pre>(consensus — applies to all other instances as well)

(Also, if/when you do fix this: line 64 in metrics/provider.go: s/memter/meter)</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/20a56c6017db7439d0d238ece5cf5ed924d258d7/orderer/consensus/kafka/metrics.go#L80)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L175](https://github.com/hyperledger-gerrit-archive/fabric/blob/20a56c6017db7439d0d238ece5cf5ed924d258d7/orderer/consensus/kafka/metrics.go#L175)<br><strong>Comment</strong>: <pre>Is there any particular reason we capture these (+ response size below) as gauges, when sarama exposes them as histograms?

(I suppose we're only doing gauges for now, even though our own metrics package does histograms?)</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L175](https://github.com/hyperledger-gerrit-archive/fabric/blob/20a56c6017db7439d0d238ece5cf5ed924d258d7/orderer/consensus/kafka/metrics.go#L175)<br><strong>Comment</strong>: <pre>Right, so, there are basically two approaches we could have taken.

1) Re-implement the go-metrics APIs and try to find a way to map the calls which populate the histogram data into go-metrics into calls against go-kit.  This is IMO the 'best' way to approach things, but is obviously a non-trivial amount of work.
2) Ignore the underlying source of the data, and instead consider the outputs of metrics themselves to be what we are reporting.  So, everything becomes a gauge.  This was the approach taken https://github.com/deathowl/go-metrics-prometheus/blob/master/prometheusmetrics.go#L65-L89

Although (1) is probably superior, given the relatively limited set of metrics exposed and that Sarama is the only user of go-metrics we seem to have, the payoff doesn't seem there.  As you can see, approach (2) only requires about 40 lines of actual code beyond the metadata that would be required either way.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/consensus/kafka/metrics.go#L175](https://github.com/hyperledger-gerrit-archive/fabric/blob/20a56c6017db7439d0d238ece5cf5ed924d258d7/orderer/consensus/kafka/metrics.go#L175)<br><strong>Comment</strong>: <pre>Ack</pre></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/28/2018, 9:48:40 AM<br><strong>UnmergedRevision</strong>: [64025956c8521c13449431072d031beeaadd8e38](https://github.com/hyperledger-gerrit-archive/fabric/commit/64025956c8521c13449431072d031beeaadd8e38)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 9:59:48 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 9:59:48 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 10:20:46 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 12:13:46 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 11/28/2018, 10:30:58 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 11/28/2018, 12:01:49 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 11/28/2018, 2:20:49 PM<br><strong>GitHubMergedRevision</strong>: [4cf2ff5b83abd094f1674df08e3dea286172e77f](https://github.com/hyperledger-gerrit-archive/fabric/commit/4cf2ff5b83abd094f1674df08e3dea286172e77f)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 9:59:48 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 9:59:48 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 10:20:46 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/28/2018, 3:01:29 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 11/28/2018, 10:30:58 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Kostas Christidis<br><strong>Merged</strong>: 11/28/2018, 4:05:06 PM<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 11/28/2018, 12:01:49 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>