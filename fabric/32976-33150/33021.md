<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 33021<br><strong>Subject</strong>: FAB-16353 Introduce unpacked proposal struct<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 8/20/2019, 12:52:46 AM<br><strong>LastUpdated</strong>: 8/22/2019, 4:14:58 AM<br><strong>CommitMessage</strong>:<br><pre>FAB-16353 Introduce unpacked proposal struct

Currently, the endorser calls validation code, which unpacks a proposal,
and returns a subset of the bits it unpacked as multiple return values.
Then, the endorser re-unpacks some of those bits, duplicating error
checking, etc.  This CR reworks the validation flow to do all the
unpacking first, then do the required validations.

This CR also adds tests to cover the unpacking path.  More rework to
come.

Change-Id: I4126d8073fa4681540c4561eb95e408fb7bac67d
Signed-off-by: Jason Yellick <jyellick@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2019, 12:52:46 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 12:54:49 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16532/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 12:55:44 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 12:55:46 AM<br><strong>Message</strong>: <pre>Patch Set 1: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 12:56:45 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16532/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16532</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2019, 8:50:02 AM<br><strong>Message</strong>: <pre>Patch Set 1:

04:55:45 The following files are missing SPDX-License-Identifier headers:
04:55:45 core/endorser/endorser_suite_test.go
04:55:45 core/endorser/msgvalidation_test.go
04:55:45 
04:55:45 Please replace the Apache license header comment text with:
04:55:45 SPDX-License-Identifier: Apache-2.0</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2019, 9:20:00 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(12 comments)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2019, 1:53:59 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 8/20/2019, 1:54:01 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(10 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 1:57:35 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16579/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 1:58:11 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:05:00 PM<br><strong>Message</strong>: <pre>Patch Set 2: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:05:10 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14666/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:05:46 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/16579/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/16579</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:05:47 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:10:12 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11293/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:10:44 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 2:25:43 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 3:14:08 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/20/2019, 3:14:50 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/14666/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/14666

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/11293/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/11293</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/21/2019, 5:38:25 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(6 comments)</pre><strong>Reviewer</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Reviewed</strong>: 8/21/2019, 9:07:17 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 8/21/2019, 10:17:30 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(6 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/21/2019, 10:31:24 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(6 comments)

Thx Jason, see my replies below</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 8/22/2019, 1:45:05 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(5 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/22/2019, 3:32:34 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

(5 comments)

Thx Jason!</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 8/22/2019, 3:32:36 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Alessandro Sorniotti</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/22/2019, 3:34:10 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/6182/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/22/2019, 3:35:11 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/7486/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 8/22/2019, 4:14:58 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/6182/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/6182

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/7486/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/7486</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 8/20/2019, 12:52:46 AM<br><strong>UnmergedRevision</strong>: [99cd77e5b9dade0202f0271f7c488ed66a8f798a](https://github.com/hyperledger-gerrit-archive/fabric/commit/99cd77e5b9dade0202f0271f7c488ed66a8f798a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/20/2019, 12:55:46 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L287](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L287)<br><strong>Comment</strong>: <pre>not sure this is used</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L287](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L287)<br><strong>Comment</strong>: <pre>this is only used on 290. Should this be inlined or should references to chaincodeId.Name use this instead?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L287](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L287)<br><strong>Comment</strong>: <pre>Presumably it would be a compile error, but I'll take a look.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L287](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L287)<br><strong>Comment</strong>: <pre>Yes, ultimately I get rid of all these header references.  I was aiming for the minimal change in endorser.go to accompany the more substantive one in msgvalidator.go.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L302](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L302)<br><strong>Comment</strong>: <pre>does this differ from chaincodeName? If so, how?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L302](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/endorser.go#L302)<br><strong>Comment</strong>: <pre>No, they are the same.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L21](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L21)<br><strong>Comment</strong>: <pre>commented in different CR - name seems wrong</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L21](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L21)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L39](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L39)<br><strong>Comment</strong>: <pre>consider wrapping the error like we do on 51 so which know which item in the signed proposal failed to unmarshal

Same on line 43</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L59](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L59)<br><strong>Comment</strong>: <pre>commented earlier - the numbers seem wrong in context</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L59](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L59)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L62](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L62)<br><strong>Comment</strong>: <pre>so, the utility includes context in the error that we're throwing away. Why?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L62](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L62)<br><strong>Comment</strong>: <pre>Was trying to simply move code around without modifying output, but done.</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L111](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L111)<br><strong>Comment</strong>: <pre>Consider refactoring to a method on UnpackedProposal.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L111](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L111)<br><strong>Comment</strong>: <pre>Ack</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L147](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L147)<br><strong>Comment</strong>: <pre>nit - closing paren on its own line when multi-line (please)</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L147](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L147)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L221](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L221)<br><strong>Comment</strong>: <pre>Given the indentation, I can't tell if this is for the config block or the default block.

So, blank line after the comment, blank line before the comment and unindent, or move after the default key word.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L221](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L221)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L221](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation.go#L221)<br><strong>Comment</strong>: <pre>I see this as "done" but don't see a change here. That mean it's addressed higher up the stack?</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation_test.go#L1](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation_test.go#L1)<br><strong>Comment</strong>: <pre>needs boilerplate</pre><strong>Commenter</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation_test.go#L35](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation_test.go#L35)<br><strong>Comment</strong>: <pre>not a fan. Between this and the JustBeforeEach, I feel the indirections needlessly complicated things.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation_test.go#L35](https://github.com/hyperledger-gerrit-archive/fabric/blob/99cd77e5b9dade0202f0271f7c488ed66a8f798a/core/endorser/msgvalidation_test.go#L35)<br><strong>Comment</strong>: <pre>As an experiment,I removed all of these function pointers, and used literals everywhere instead.  The problem is that the very top level thing -- the proposal bytes -- is marshaled, which means any change requires an entire copy of the structure.  So, there is effectively zero shared setup across any of the tests.

The indirections obviously make the initial setup more complicated, though do reduce the lines of code.  I'll see if I can't come up with a way to simplify things, while retaining the shared setup.

Edit: After a few iterations of play, I'm still convinced this is the least awful way to get things done.  I tried using a generic marshaling function that was overridden (cryptic, and worse).  I tried copying all the marshaling (tons of code, no shared setup, worse).  I looked at unmarshaling and remarshaling, but for deep fields this was even more code than just copying.  I looked at using the UnpackedProposal struct to remarshal, but it doesn't work for bad proto encodings nor for fields which must not be set like payload visibility.

In conclusion, it may be a little unconventional and ugly, but I still think it's an improvement.</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Uploader</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Created</strong>: 8/20/2019, 1:53:59 PM<br><strong>GitHubMergedRevision</strong>: [05f37c80fc22d72d622e4d10ddc7b21c101aeb2f](https://github.com/hyperledger-gerrit-archive/fabric/commit/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/20/2019, 2:05:00 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/20/2019, 2:05:00 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/20/2019, 3:14:08 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 8/20/2019, 2:25:43 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Approved</strong>: 8/22/2019, 3:32:34 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Alessandro Sorniotti<br><strong>Merged</strong>: 8/22/2019, 3:32:36 AM<br><br><strong>Approver</strong>: Matthew Sykes - sykesmat@us.ibm.com<br><strong>Approved</strong>: 8/21/2019, 9:07:17 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L292](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/endorser.go#L292)<br><strong>Comment</strong>: <pre>The UnpackProposal function does return a ChaincodeHeaderExtension so it seems odd that we are re-creaating one here. I would suggest removing any mention of ChaincodeHeaderExtension from the endorser code altogether and just tracking the chaincode name - this would pave the way for the removal of the field. We could consider determining the name of the chaincode to be invoked from the chaincode invocation spec instead and just stop parsing this header extension - wdyt?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L292](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/endorser.go#L292)<br><strong>Comment</strong>: <pre>By the end of this stack, this and all references to to the extension, is gone.  So, I'd prefer not to address here.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/endorser.go#L292](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/endorser.go#L292)<br><strong>Comment</strong>: <pre>perfect - thx, works for me</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L226)<br><strong>Comment</strong>: <pre>Let's please leave this check till we have a longer discussion about epochs - whether we need to start using them or can ditch them for good.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L226)<br><strong>Comment</strong>: <pre>What's the value in leaving this check? This is in the endorser flow, so, we don't need to worry about being deterministic.  And practically, all of our clients already set it to 0.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L226)<br><strong>Comment</strong>: <pre>from a security perspective, the best practice is to treat external input as tainted and potentially malicious and validate it against a whitelist - "only accept known good". We have a field which we admittedly don't use yet, but we've been asserting that its value must be zero. A nonzero value here should lead us to drop this message immediately since - as you say - none of our clients legitimately produce it and it has no business being nonzero. Plus, there's no real reason to remove it since it's basically for free (given speculative execution and our tps rate). For these reasons, I don't think we have any real reason to remove it.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L226)<br><strong>Comment</strong>: <pre>If I had time, I would actually completely remove all of our proto structures from the 'UnpackedProposal'.  We have some problems downstream, in that we expose the signed proposal through the chaincode shim, but IMO, the safest form of white-listing is to take only the bits of data which you know you have explicitly validated and pass them on.  This form of check is really more of a 'black list of fields which we have applied white listing to" (rather than a white list of fields and acceptable values).

That being said, as we have the downstream problems and I don't have time to actually fix this up, I'll add the check on top of this stack. https://gerrit.hyperledger.org/r/c/fabric/+/33112/</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L226)<br><strong>Comment</strong>: <pre>Thanks Jason, understood!</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L56](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L56)<br><strong>Comment</strong>: <pre>Why don't we just go ahead and check the transaction type? I know it looks cleaner to do it in the validation step below, but it seems risky to perform two actions (get the extension here and the chaincode invocation spec below) speculatively under the assumption that the transaction is of the right type, only to realise later that it may not be.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L56](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L56)<br><strong>Comment</strong>: <pre>As you can see in the weirdo header type below, it unfortunately doesn't buy us much.  We effectively have 3 transaction types in the system, endorser, config, and config update.  And, the old check allowed all 3.  I've pared it back to only endorser and config, but a config tx if actually a config tx will still cause the extension etc unmarshaling to blow up.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L56](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L56)<br><strong>Comment</strong>: <pre>So, just to confirm: it's okay to attempt to unmarshal header extension and cc invocation spec *always*? Is there any chance that we can construct a tx that "looks legitimate" and causes the endorser to fail badly or panic if we leave the code as is and speculatively assume that it's an endorser tx?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L56](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L56)<br><strong>Comment</strong>: <pre>Yes, I do get what you're driving at.  But... if you are doing a well formed invoke of the endorse API, then these unmarshals will succeed.  If you are not doing a well-formed invoke of the endorse API, then despite proto's non-fail-fast propensity to return false negatives when unmarshaling, we will catch the wrong header type just below in the validate steps.  If you are a clever attacker who, by giving us incorrectly encoded data for these fields can make soemthing bad happen, then you are probably clever enough to set your header type to bypass any check against its value.

TLDR; I do get your point, but you do understand me correctly, and it is safe to proceed here even with a bad header type.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L56](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L56)<br><strong>Comment</strong>: <pre>Agreed - I think that this is as good as it gets without a full redesign of the proto messages. Thx</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L80)<br><strong>Comment</strong>: <pre>Just making a note for our future selves that this payload visibility business can be ditched</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L80)<br><strong>Comment</strong>: <pre>Confirmed, I'll kill this check when I remove the field from the proto.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L80)<br><strong>Comment</strong>: <pre>Yay, thx! :)</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L80)<br><strong>Comment</strong>: <pre>https://gerrit.hyperledger.org/r/c/fabric/+/33082/</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L80)<br><strong>Comment</strong>: <pre>Thx!</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L82)<br><strong>Comment</strong>: <pre>GetChaincodeInvocationSpec unmarshals the header again - can we avoid this, since you already have the unmarshalled header? I checked and this function is only used in a handful of places so the refactoring should be minimal and we save a redundant unmarshalling per processed proposal.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L82)<br><strong>Comment</strong>: <pre>I'll add it to the stack.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L82)<br><strong>Comment</strong>: <pre>Thx! Want me to create a JIRA?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L82)<br><strong>Comment</strong>: <pre>Already fixed. https://gerrit.hyperledger.org/r/c/fabric/+/33088/2/core/endorser/msgvalidation.go#b81</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L82](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L82)<br><strong>Comment</strong>: <pre>Ah wow, that was quick. Thx</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L217)<br><strong>Comment</strong>: <pre>Not sure I follow: when we join a channel don't we use the propose API and submit the genesis tx? Or maybe it's an endorser tx with a config tx payload? At any rate, as you know I would definitely welcome getting rid of cscc for channel operations..</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L217)<br><strong>Comment</strong>: <pre>https://github.com/hyperledger/fabric/blob/7d1256f355de5451f3d8b88b2d67a00de457a746/internal/peer/channel/join.go#L93

It's the propose API, with an invocation to joinchain, on cscc.  But, for some reason that boggles the mind, at least the peer CLI sets the header type for this transaction incorrectly to CONFIG.  It is an ENDORSER_TRANSACTION, so, we have to continue to tolerate this weird header type here so as not to break old clients.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L217)<br><strong>Comment</strong>: <pre>Oh dear.. but then it means that in practice, we only ever receive endorser tx and so can't we just make this check even more selective?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L217)<br><strong>Comment</strong>: <pre>We should probably fix the peer CLI to set the tx type properly.  But I don't think we can be more selective for fear of breaking old clients.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/endorser/msgvalidation.go#L217](https://github.com/hyperledger-gerrit-archive/fabric/blob/05f37c80fc22d72d622e4d10ddc7b21c101aeb2f/core/endorser/msgvalidation.go#L217)<br><strong>Comment</strong>: <pre>Right, let's fix the CLI first and a few releases after it'll probably be safe enough to be stricter here</pre></blockquote>