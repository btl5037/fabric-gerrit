<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 4003<br><strong>Subject</strong>: [FAB-187] - using policies in VSCC<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/16/2017, 9:25:05 AM<br><strong>LastUpdated</strong>: 1/17/2017, 6:16:19 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-187] - using policies in VSCC

This code drop integrates cauthdsl into the VSCC. The flow is the following:
the validator code extracts from LCCC the policy specified by the deployer.
The policy is an additional argument to VSCC. VSCC deserializes the policy
and uses cauthdsl to validate the endorsements against it.

Currently the chaincode deployer doesn't specify a policy when it deploys a
chaincode and so for now the validator uses a policy that says "signed by any
member of the specified MSP". This is to be removed as soon as chaincode
deploy transactions specify policies when a new chaincode is deployed.

Change-Id: I9e5ff1effa75934cdfef231a37e66f2941a45d10
Signed-off-by: Alessandro Sorniotti <ale.linux@sopit.net>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/16/2017, 9:25:05 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 9:28:31 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5244/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 10:07:12 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5244/ : SUCCESS</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/16/2017, 10:42:23 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 10:44:36 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5246/</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 11:14:58 AM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+1

(1 comment)

Looking good to me.  Nice to see this all pulling together!</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/16/2017, 11:22:00 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5246/ : SUCCESS</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/16/2017, 11:29:23 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)

Thanks, Jason. See below!</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 4:21:14 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 4:38:21 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(4 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/16/2017, 4:46:55 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(4 comments)

Thx for the comments, Yacov, I'll push a new drop shortly</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 4:50:50 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(2 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/17/2017, 2:10:42 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 2:11:41 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5274/</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 1/17/2017, 2:13:34 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Thanks Yacov, I've addressed your comments</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 2:50:18 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5274/ : SUCCESS</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 3:09:00 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2

Thanks! LGTM now</pre><strong>Reviewer</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Reviewed</strong>: 1/17/2017, 5:37:59 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 5:38:01 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jonathan Levi</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 5:38:59 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/775/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 6:16:19 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/775/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 1/16/2017, 9:25:05 AM<br><strong>UnmergedRevision</strong>: [5996d569f4a624eafa868bf9159bb2f78d1b4d50](https://github.com/hyperledger-gerrit-archive/fabric/commit/5996d569f4a624eafa868bf9159bb2f78d1b4d50)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/16/2017, 10:07:12 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 1/16/2017, 10:42:23 AM<br><strong>UnmergedRevision</strong>: [3c13f8bbeafa6c0c9f44a623d6df611930748feb](https://github.com/hyperledger-gerrit-archive/fabric/commit/3c13f8bbeafa6c0c9f44a623d6df611930748feb)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/16/2017, 11:22:00 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 1/16/2017, 4:21:14 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L166](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/committer/txvalidator/validator.go#L166)<br><strong>Comment</strong>: <pre>Why so many?</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L166](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/committer/txvalidator/validator.go#L166)<br><strong>Comment</strong>: <pre>If you want I can just leave 1</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L166](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/committer/txvalidator/validator.go#L166)<br><strong>Comment</strong>: <pre>Please just leave 1. Might as well change it to TODO while you're at it. Unless, you have FIXME comments in all your code</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L53](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L53)<br><strong>Comment</strong>: <pre>args</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L53](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L53)<br><strong>Comment</strong>: <pre>ah yeah, good catch</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L57](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L57)<br><strong>Comment</strong>: <pre>I wish someone would document this. Or at least, make this an enum. But, this is not the change set for it.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L57](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L57)<br><strong>Comment</strong>: <pre>Yeah, this is still a bit of a moving target but I guess as soon as we finalize the interfaces we can document them</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L57](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L57)<br><strong>Comment</strong>: <pre>Can you please add a TODO here? so *someone* would hopefully notice and see.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L123](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L123)<br><strong>Comment</strong>: <pre>I can't be certain that it's the best idea, but for `Envelope` and `SignedConfigurationItem` I added `AsSignedData` methods to the protos which creates the slice of `SignedData`.  In general, adding methods to proto items is a bit of an odd thing, but especially if you see any other piece of code needing to verify an endorsement using a policy, I think it might be useful</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L123](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L123)<br><strong>Comment</strong>: <pre>You are talking about an "AsSignedData" method that takes a tx Action and converts it into a slice of `SignedData`? If so, I think it would end up being a method that only VSCC code calls, as it's very much a VSCC-specific thing. I can add it, though - your call.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature.go#L123](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature.go#L123)<br><strong>Comment</strong>: <pre>Fine by me if it is only `VSCC, let's keep it here.</pre><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature_test.go#L64](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature_test.go#L64)<br><strong>Comment</strong>: <pre>where are 2 and 1?</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/system_chaincode/vscc/validator_onevalidsignature_test.go#L64](https://github.com/hyperledger-gerrit-archive/fabric/blob/3c13f8bbeafa6c0c9f44a623d6df611930748feb/core/system_chaincode/vscc/validator_onevalidsignature_test.go#L64)<br><strong>Comment</strong>: <pre>whoops :)</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 1/17/2017, 2:10:42 AM<br><strong>GitHubMergedRevision</strong>: [03771991371e931a44457f727620d98a7237bb59](https://github.com/hyperledger-gerrit-archive/fabric/commit/03771991371e931a44457f727620d98a7237bb59)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2017, 2:50:18 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>Approved</strong>: 1/17/2017, 5:37:59 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jonathan Levi (HACERA)<br><strong>Merged</strong>: 1/17/2017, 5:38:01 AM<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 1/17/2017, 3:09:00 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jonathan Levi (HACERA) - jonathan@hacera.com<br><strong>CommentLine</strong>: [core/committer/txvalidator/validator.go#L185](https://github.com/hyperledger-gerrit-archive/fabric/blob/03771991371e931a44457f727620d98a7237bb59/core/committer/txvalidator/validator.go#L185)<br><strong>Comment</strong>: <pre>We may want to use MSP (capitals) for consistency.</pre></blockquote>