<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 4061<br><strong>Subject</strong>: FAB-609: Ledger VerifyChain<br><strong>Status</strong>: ABANDONED<br><strong>Owner</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/17/2017, 4:36:52 AM<br><strong>LastUpdated</strong>: 10/5/2017, 10:30:33 AM<br><strong>CommitMessage</strong>:<br><pre>FAB-609: Ledger VerifyChain

Method outside ledger which uses ledger exported methods to
walk the block chain and verify its integrity. It checks the Data Hash for
each block and verify the Header hash against the next block in the chain

Change-Id: I836d6a14838ab4a19ecdca07a7fb34efbab1efd5
Signed-off-by: Balaji Viswanathan <balaji.viswanathan@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 4:36:52 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 4:37:44 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5278/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 5:16:16 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5278/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 6:21:14 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 7:11:26 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 11:36:39 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 11:38:55 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5301/</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 11:50:56 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(5 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 12:06:03 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5301/ : SUCCESS</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 12:31:18 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 1:25:25 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/17/2017, 11:37:56 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 12:10:47 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 1:13:55 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(3 comments)</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 9:45:31 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 10:18:52 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 12:41:02 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 12:42:07 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/18/2017, 12:42:42 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5356/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/18/2017, 1:23:24 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5356/ : FAILURE</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/18/2017, 1:26:36 PM<br><strong>Message</strong>: <pre>Patch Set 3:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/18/2017, 1:31:09 PM<br><strong>Message</strong>: <pre>Patch Set 3: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5361/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/18/2017, 2:14:33 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5361/ : SUCCESS</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 2:44:20 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review-1

(3 comments)

I am not sure the motivation of this function and who would use it.  Every time we commit a block, we check its integrity, so unless facing byzantine, which this check would not be sufficient by itself.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/18/2017, 5:21:42 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(3 comments)

Binh - The use case is that an auditor may want to verify the integrity of the hash chain.  This is the internal API to provide that verification check.  We discussed needing to work through the design on how to externalize, but I thought the internal impl could proceed and we would externalize later after talking to design team.

If you prefer, we could put the change on hold until those discussions are complete.

The hash chain verification would also be one of the steps in the eventual checkpoint post-v1.</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 1/18/2017, 5:52:14 PM<br><strong>Message</strong>: <pre>Patch Set 3:

> (3 comments)
 > 
 > Binh - The use case is that an auditor may want to verify the
 > integrity of the hash chain.  This is the internal API to provide
 > that verification check.  We discussed needing to work through the
 > design on how to externalize, but I thought the internal impl could
 > proceed and we would externalize later after talking to design
 > team.
 > 
 > If you prefer, we could put the change on hold until those
 > discussions are complete.
 > 
 > The hash chain verification would also be one of the steps in the
 > eventual checkpoint post-v1.

I am not convinced that an auditor would do this as it would not prove anything. When facing byzantine, auditor would need to look at f+1 peers and compare them against each other, not trying to validate hash within the same ledger like this function does. So I don't believe there is an application here.</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 1/18/2017, 9:34:04 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Ok, I thought this single peer verification would be a building block to the larger cross-peer verification and checkpoint, and have some utility in the interim for single-peer.  I agree though, if there is no intent to exploit it in v1, it is better to defer until there is a more comprehensive design in a future release. Thanks for the submission Balaji, we'll re-visit next time around.</pre><strong>Reviewer</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Reviewed</strong>: 2/4/2017, 4:04:27 AM<br><strong>Message</strong>: <pre>Abandoned</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 7/16/2017, 11:45:54 AM<br><strong>Message</strong>: <pre>Patch Set 3:

> I am not sure the motivation of this function and who would use it.
 >  Every time we commit a block, we check its integrity, so unless
 > facing byzantine, which this check would not be sufficient by
 > itself.

This check alone is indeed not sufficient to protect you from wreckless ledger management.

It is better than nothing however.

Consider the case of a peer/orderer administrator where they update the volume that carries the ledger in an improper way. (This happened by the way.)

Ledger-carrying nodes (i.e. peers and orderers) could make use of this function when booting up; this would allow them to detect if they have a contiguous chain, and panic/error/whatever if they're not.</pre><strong>Reviewer</strong>: Jim Zhang - jim_the_matrix@hotmail.com<br><strong>Reviewed</strong>: 10/5/2017, 10:30:33 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Agree with Kostas, the code here is a good way for peer owners to ensure that everything in the ledger is in good order, as a sanity check after for instance disk archiving/restore, or showing proof of integrity to an audit. I think as an example a command like "peer ledger checkintegrity" could be very useful to a peer admin</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Uploader</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Created</strong>: 1/17/2017, 4:36:52 AM<br><strong>UnmergedRevision</strong>: [0b248647636323fdc9e171a3405bac3b6493033b](https://github.com/hyperledger-gerrit-archive/fabric/commit/0b248647636323fdc9e171a3405bac3b6493033b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2017, 5:16:16 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>Balaji, ClosableLedger was meant to be something internal to ledgermgmt package. My mistake that I left it as a public one... I'll make it a private in a separate change-set. 

If we want to define this function on ledger then we should add it to the `Ledger` interface in the ledger_interface.go. But because, the implementation remains pretty much the same irrespective of the ledger implementation, it is better that we write this as a util function that takes the `Ledger` as one of the input params.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>will keep it as a function within ledger_mgmt.go not a method for any type. is that ok or do you think it should be outside ledger_mgmt and within say util/util.go?

Btw, there is a potential race condition if the peer is running when this utility is invoked externally (unless you are doing file locking in flblkstorage).</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>I think that better to keep in package 'fabric/core/ledger/util' or in 'fabric/peer/util'. Dave do you have any opinion?

What race condition do you refer to? Can you help with an example?</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>In my opinion the utils are meant for internal code helpers, whereas VerifyChain() seems more like a function on a ledger, therefore I would have put it as a function under Ledger interface.  Is there a concern with that?

Once we understand how it will be called by externals, then we could put a wrapper somewhere else as well.

Binh, do you have ideas on how VerifyChain() would be exposed to external people that want to verify the integrity of the hash chain? For example auditors.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>"seems more like a function on a ledger, therefore I would have put it as a function under Ledger interface. Is there a concern with that?" - Just another way to look at it could be that the methods in Ledger interface are those that a ledger implementation could implement in a different way. If something is going to be implemented in a same way, it can well be a utility on top. In fact, earlier it was defined as a function in Ledger interface but Jason was in favor of moving it out which seemed convincing enough to me.

Finally, even if we expose it as method on Ledger interface, internally we would want to implement as a util function that is reused for both OrdererLedger and KVLedger.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>If we have external interface to this, which means that it is invoked and runs as a separate process than peer, then it's accessing (reading) blkstorage which could simultaneously be written to by peer. It's possible then that this will read partially written index or block unless we have file level locking in place.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>Any access to blkstorage is supposed to go via it's APIs which makes sure delivering a block when it is fully written to disk.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>Ok, how about NewKVLedger call which invokes recovery within. This interface will end up calling it, which in turn will try recovery on a running system.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L165](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L165)<br><strong>Comment</strong>: <pre>Probably should also log info the fact that we are starting VerifyChain.  And then at the end log info the result for the verified block range.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L165](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L165)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L166](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L166)<br><strong>Comment</strong>: <pre>Also, need to validate that startBlockNum is less than endBlockNum.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L166](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L166)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L186](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L186)<br><strong>Comment</strong>: <pre>The return type here is not common.Block. you just need to cast it to type `BlockHolder` defined 'fabric/core/ledger/ledger_interface.go' and then call `GetBlock()` function on that.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L186](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L186)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L202](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L202)<br><strong>Comment</strong>: <pre>Shouldn't this if block be before evaluating for the exit condition? Else, the datahash verification for the last block will be missed out.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L202](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L202)<br><strong>Comment</strong>: <pre>line 197-199 are the actual exit clause for happy path. at this point in code, its processing block+1.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L202](https://github.com/hyperledger-gerrit-archive/fabric/blob/0b248647636323fdc9e171a3405bac3b6493033b/core/ledger/ledgermgmt/ledger_mgmt.go#L202)<br><strong>Comment</strong>: <pre>I am not sure if I am missing something here... you are first incrementing blockNum at line 195 and later performing the dataHash check. So when you got the last block won't it increment the blockNum before even verifying it's data hash? Also, will block be ever nil in line 202 (and in line 181)?</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Uploader</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Created</strong>: 1/17/2017, 11:36:39 AM<br><strong>UnmergedRevision</strong>: [81aa5e6e6fdca5386f803631c561560085a5d760](https://github.com/hyperledger-gerrit-archive/fabric/commit/81aa5e6e6fdca5386f803631c561560085a5d760)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/17/2017, 12:06:03 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/81aa5e6e6fdca5386f803631c561560085a5d760/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>After the renaming of ledgers (https://gerrit.hyperledger.org/r/#/c/3575/) 
Better to take `ledger.Ledger` as a first parameter so this function can be used across OrdererLedger and PeerLedger.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L184](https://github.com/hyperledger-gerrit-archive/fabric/blob/81aa5e6e6fdca5386f803631c561560085a5d760/core/ledger/ledgermgmt/ledger_mgmt.go#L184)<br><strong>Comment</strong>: <pre>Balaji, can we simplify the code a bit? I am getting lost in the presence of many if conditions.

Just a thought: 

If you retrieve the first block outside the for loop then prevBlock and block will never be nil. 

If you set the endBlockNum to blockChainInfo.Height - 1, you can safely iterate till endBlockNum + 1 (in all situations). The for loop itself can check for the range.

Also, line 200 check is not required - as far as I recall, the Next() is a blocking call and never returns nil unless there is an error; please correct me if you found it otherwise.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L184](https://github.com/hyperledger-gerrit-archive/fabric/blob/81aa5e6e6fdca5386f803631c561560085a5d760/core/ledger/ledgermgmt/ledger_mgmt.go#L184)<br><strong>Comment</strong>: <pre>Ok, i will make it a bit more readable. However, will keep the nil checks as defensive programming practice since this is using external interface. tomorrow if behaviour changes (blocking to non-blocking say) it shouldn't break the code.</pre><strong>Commenter</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L184](https://github.com/hyperledger-gerrit-archive/fabric/blob/81aa5e6e6fdca5386f803631c561560085a5d760/core/ledger/ledgermgmt/ledger_mgmt.go#L184)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Uploader</strong>: Balaji Viswanathan - balaji.viswanathan@gmail.com<br><strong>Created</strong>: 1/18/2017, 12:41:02 PM<br><strong>UnmergedRevision</strong>: [600a3caeb73be8c2d5be16a5b783764525f65780](https://github.com/hyperledger-gerrit-archive/fabric/commit/600a3caeb73be8c2d5be16a5b783764525f65780)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/18/2017, 2:14:33 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Approved</strong>: 1/18/2017, 2:44:20 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L157](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L157)<br><strong>Comment</strong>: <pre>I think the function location and signature is fine now... once we know exactly how clients will call the verify function, we may change/move at that time, but for now this makes sense.</pre><strong>Commenter</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L158)<br><strong>Comment</strong>: <pre>Why would we want to log info? Maybe debug?  
I wouldn't consider this as significant, like an auto checkpoint, to log info for serviceability.  Furthermore, this is an external function to be called by someone, who would act on the information.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L158)<br><strong>Comment</strong>: <pre>Since an administrator may want to know when the last verification was, I suggested that this be log info.  Once a higher level wrapper is added to expose this to externals, we may move the log info to the wrapper level.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L170](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L170)<br><strong>Comment</strong>: <pre>In the error and in the log, I would specify the exact error message (VerifyChain start block number must be lower than blockchain height X).</pre><strong>Commenter</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L176](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L176)<br><strong>Comment</strong>: <pre>same as above</pre><strong>Commenter</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L226](https://github.com/hyperledger-gerrit-archive/fabric/blob/600a3caeb73be8c2d5be16a5b783764525f65780/core/ledger/ledgermgmt/ledger_mgmt.go#L226)<br><strong>Comment</strong>: <pre>same as above</pre></blockquote>