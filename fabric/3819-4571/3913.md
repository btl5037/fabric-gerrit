<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 3913<br><strong>Subject</strong>: [FAB-1242] Limit batch size to AbsoluteMaxBytes<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Luis Sanchez - luiss@me.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 1/12/2017, 1:21:36 PM<br><strong>LastUpdated</strong>: 1/17/2017, 4:34:38 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-1242] Limit batch size to AbsoluteMaxBytes

 - Receiver.Ordered() should not produce a batch of
   messages larger BatchSize.AbsoluteMaxBytes.

Change-Id: I3fcdc49c5756ee2215c8a7837ac3e0e49073aa13
Signed-off-by: Luis Sanchez <sanchezl@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 1/12/2017, 1:21:36 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/12/2017, 1:24:56 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5082/</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 1/12/2017, 1:29:50 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/12/2017, 2:02:58 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5082/ : SUCCESS</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/12/2017, 5:34:14 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Baohua Yang - yangbaohua@gmail.com<br><strong>Reviewed</strong>: 1/12/2017, 7:31:14 PM<br><strong>Message</strong>: <pre>Patch Set 1:

If the order has such limit, do we need limit the transaction size by peer/client, too?</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 1/13/2017, 2:58:03 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 1/13/2017, 2:59:52 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 3:04:17 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5143/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/13/2017, 3:45:05 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5143/ : SUCCESS</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/13/2017, 6:01:55 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(2 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 1/14/2017, 12:30:01 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3: Patch Set 2 was rebased.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2017, 12:32:02 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5157/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/14/2017, 1:09:29 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/5157/ : SUCCESS</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 1/16/2017, 5:24:17 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 1/16/2017, 8:25:17 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1

(2 comments)

LGTM, thanks.

(No need to push a new patchset for the comments below, just keep them in mind whenever you push something that touches this package.)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 1/17/2017, 3:52:14 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 3:52:20 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Yacov Manevich</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 3:55:32 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/773/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 1/17/2017, 4:34:38 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/773/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 1/12/2017, 1:21:36 PM<br><strong>UnmergedRevision</strong>: [6d88b89a73a5aacc2b3466d9ac0f24d90d88f798](https://github.com/hyperledger-gerrit-archive/fabric/commit/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/12/2017, 2:02:58 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L80)<br><strong>Comment</strong>: <pre>This doesn't cause two batches to be returned, does it?  It looks like the new message goes into the next batch?</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L80)<br><strong>Comment</strong>: <pre>I will re-word this.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L80](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L80)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L87](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L87)<br><strong>Comment</strong>: <pre>I'm expecting that these filters include a filter that rejects messages that are larger than BatchSize.AbsoluteMaxBytes (I've added such a filter to the defaults). Is this an appropriate assumption? Meaning a chain should include such a filter if it has a limit on message size, or should I check the message size again after applying the filters?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L87](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L87)<br><strong>Comment</strong>: <pre>You must apply the filter a second time here, because the max size may have changed between the transaction ingress (first pass) filter, and the the block cutting phase.

(The block cutter uses the same filter set as the ingress, so this should be doing it for you)</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L87](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L87)<br><strong>Comment</strong>: <pre>I guess I'm really asking if I should explicitly check one more time, after the highlighted section, resulting in possibly the third time that the size of the message is checked. I'm asking if I should be concerned about a chain that does not have the default set of Filters configured ( and hence might allow a message that is too large to make it past this second application of the filters), or should such a chain just be considered to be configured incorrectly?</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L87](https://github.com/hyperledger-gerrit-archive/fabric/blob/6d88b89a73a5aacc2b3466d9ac0f24d90d88f798/orderer/common/blockcutter/blockcutter.go#L87)<br><strong>Comment</strong>: <pre>Especially since filters are configured at build time, not runtime, I think we are okay to assume filters are set up correctly.

No need to check size a third time, by my estimation.  I would assume the filters have appropriately checked.</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 1/13/2017, 2:59:52 PM<br><strong>UnmergedRevision</strong>: [a20188c7b8578cb80e9b7ae4b5f82798b61ccc7a](https://github.com/hyperledger-gerrit-archive/fabric/commit/a20188c7b8578cb80e9b7ae4b5f82798b61ccc7a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/13/2017, 3:45:05 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: TRIVIAL_REBASE<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 1/14/2017, 12:30:01 AM<br><strong>GitHubMergedRevision</strong>: [67455b333c40a036a1da83f9ba6587d1b977dddd](https://github.com/hyperledger-gerrit-archive/fabric/commit/67455b333c40a036a1da83f9ba6587d1b977dddd)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 1/14/2017, 1:09:29 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 1/16/2017, 8:25:17 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 1/16/2017, 5:24:17 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 1/17/2017, 3:52:14 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Yacov Manevich<br><strong>Merged</strong>: 1/17/2017, 3:52:19 AM<br><br><h2>Comments</h2><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L32](https://github.com/hyperledger-gerrit-archive/fabric/blob/67455b333c40a036a1da83f9ba6587d1b977dddd/orderer/common/blockcutter/blockcutter.go#L32)<br><strong>Comment</strong>: <pre>(is) - same thing applies to line 34</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/common/blockcutter/blockcutter.go#L41](https://github.com/hyperledger-gerrit-archive/fabric/blob/67455b333c40a036a1da83f9ba6587d1b977dddd/orderer/common/blockcutter/blockcutter.go#L41)<br><strong>Comment</strong>: <pre>(I assume "of (previous) messages", or something along these lines.)</pre></blockquote>