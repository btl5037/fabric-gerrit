<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 31315<br><strong>Subject</strong>: FAB-15425 lock when reading self.Endpoint in discovery<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 5/9/2019, 8:44:16 PM<br><strong>LastUpdated</strong>: 5/11/2019, 5:52:10 PM<br><strong>CommitMessage</strong>:<br><pre>FAB-15425 lock when reading self.Endpoint in discovery

 - Use pre-existing lock to avoid data race with UpdateEndpoint write
   to self.Endpoint

Change-Id: Ieec70e4e6d6345dcd424a2cf76afeafb32fd20c6
Signed-off-by: Morgan Bauer <mbauer@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Reviewed</strong>: 5/9/2019, 8:44:16 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:49:35 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13679/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:49:59 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:54:57 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:55:39 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13679/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/13679</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:57:24 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8715/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:57:45 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:57:57 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12055/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 8:58:23 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 9:25:41 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 9:35:11 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/9/2019, 9:35:59 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8715/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/8715

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12055/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/12055</pre><strong>Reviewer</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 4:24:51 AM<br><strong>Message</strong>: <pre>Patch Set 1:

A patch to only exactly hit the problem reported by the racer.

Can do a deeper look at the overall arrangement later.</pre><strong>Reviewer</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 4:25:24 AM<br><strong>Message</strong>: <pre>Patch Set 1:

trigger with 
go test -count 10000 -failfast -race -v -run TestUpdate</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 12:11:23 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2

I'm good with this, but we can just remove UpdateEndpoint. It's not used in production.

It was added as wishful thinking that the peer might update its endpoint dynamically without a restart.</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 12:12:51 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+1

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 12:35:06 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1</pre><strong>Reviewer</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 1:38:38 PM<br><strong>Message</strong>: <pre>Patch Set 2: Published edit on patch set 1.</pre><strong>Reviewer</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 1:38:55 PM<br><strong>Message</strong>: <pre>Patch Set 2:

sure, but we need to have comments in there for what's protecting what.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:41:39 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13685/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:42:02 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:47:05 PM<br><strong>Message</strong>: <pre>Patch Set 2: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:47:48 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/13685/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/13685</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:49:24 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8720/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:49:46 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:50:17 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12069/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 1:50:39 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting unit tests</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 2:11:16 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/10/2019, 2:12:47 PM<br><strong>Message</strong>: <pre>Patch Set 2:

> sure, but we need to have comments in there for what's protecting what.

I'd rather have no comment than a misleading one. We're mainly protecting the maps, not the self.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 2:15:08 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 2:26:26 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/10/2019, 2:27:14 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/8720/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/8720

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/12069/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/12069</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 5/11/2019, 4:57:55 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 5/11/2019, 4:57:57 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Artem Barger</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/11/2019, 4:59:25 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6657/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/11/2019, 5:00:20 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5342/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/11/2019, 5:52:10 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6657/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/6657

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/5342/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/5342</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Uploader</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Created</strong>: 5/9/2019, 8:44:16 PM<br><strong>UnmergedRevision</strong>: [5622c8faad8092f9ea04d8b8810d424d5c9f4917](https://github.com/hyperledger-gerrit-archive/fabric/commit/5622c8faad8092f9ea04d8b8810d424d5c9f4917)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/9/2019, 8:54:57 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/9/2019, 8:54:57 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/9/2019, 9:35:11 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/9/2019, 9:25:41 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 5/10/2019, 12:35:06 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [gossip/discovery/discovery_impl.go#L66](https://github.com/hyperledger-gerrit-archive/fabric/blob/5622c8faad8092f9ea04d8b8810d424d5c9f4917/gossip/discovery/discovery_impl.go#L66)<br><strong>Comment</strong>: <pre>this actually protects access to the the stuff above. can you remove this comment please?</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Uploader</strong>: Morgan Bauer - mbauer@us.ibm.com<br><strong>Created</strong>: 5/10/2019, 1:38:38 PM<br><strong>GitHubMergedRevision</strong>: [19fa02289af44831dfbaf5c7d8cfa076e2cdb83b](https://github.com/hyperledger-gerrit-archive/fabric/commit/19fa02289af44831dfbaf5c7d8cfa076e2cdb83b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/10/2019, 1:47:05 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/10/2019, 1:47:05 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/10/2019, 2:26:26 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/10/2019, 2:15:08 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 5/10/2019, 2:11:16 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Approved</strong>: 5/11/2019, 4:57:55 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Artem Barger<br><strong>Merged</strong>: 5/11/2019, 4:57:57 PM<br><br></blockquote>