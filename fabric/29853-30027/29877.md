<strong>Project</strong>: fabric<br><strong>Branch</strong>: release-1.3<br><strong>ID</strong>: 29877<br><strong>Subject</strong>: FAB-14327 Race in BlockWriter corrupts config sequence<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 3/6/2019, 5:54:59 AM<br><strong>LastUpdated</strong>: 3/7/2019, 9:16:22 AM<br><strong>CommitMessage</strong>:<br><pre>FAB-14327 Race in BlockWriter corrupts config sequence

There is a race between the go-routine that submits a config-update
block to the internal thread that writes the (previous) block
asynchronously to the ledger.

The race may cause to back-to-back config-update transactions to have bad
block metadata - in the first the LAST_CONFIG will be ok, but in the
second the LAST_CONFIG will point to the first, rather then the second.
This may happen independently in different ledgers, creating a fork.

This fix avoid Bundle update before the go-routine in WriteBlock()
finished writing the previous block. We do this (in particular) to
prevent bw.support.Sequence() from advancing before the go-routine
in WriteBlock() reads it. In general, this prevents the StableBundle
from changing before the go-routine in WriteBlock() finishes.

The unit test replicates the condtions that cause the bug and verifies
it is fixed (without the fix it fails).

See respective JIRA for more details.

Change-Id: If26654e006b4fe6d48d2d8fc73894eaff2426dcd
Signed-off-by: Yoav Tock <tock@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/6/2019, 5:54:59 AM<br><strong>Message</strong>: <pre>Patch Set 1: Cherry Picked from branch master.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 5:59:09 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11315/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 5:59:51 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:04:06 AM<br><strong>Message</strong>: <pre>Patch Set 1: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:04:56 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11315/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/11315</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/6/2019, 6:31:36 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Run VerifyBuild</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:35:56 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11320/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:36:24 AM<br><strong>Message</strong>: <pre>Patch Set 1: -F1-VerifyBuild

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:40:50 AM<br><strong>Message</strong>: <pre>Patch Set 1: F1-VerifyBuild-1

code checks are failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/6/2019, 6:41:58 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11320/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/11320</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/6/2019, 9:02:51 AM<br><strong>Message</strong>: <pre>Abandoned

Conflicts, need to use CLI</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 3:02:46 AM<br><strong>Message</strong>: <pre>Restored

Will push a new patch manually</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 3:04:28 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:06:12 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11371/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:06:41 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:11:46 AM<br><strong>Message</strong>: <pre>Patch Set 2: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:12:24 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11371/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/11371</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 3:13:36 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:13:39 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10147/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:14:08 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/6881/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:14:45 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:14:50 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:15:54 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11374/</pre><strong>Reviewer</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 3:16:14 AM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:16:32 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:17:26 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11377/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:18:15 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:21:59 AM<br><strong>Message</strong>: <pre>Patch Set 3: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:22:53 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11374/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/11374</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:23:20 AM<br><strong>Message</strong>: <pre>Patch Set 4: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:23:21 AM<br><strong>Message</strong>: <pre>Patch Set 3:

No Builds Executed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:23:38 AM<br><strong>Message</strong>: <pre>Patch Set 2: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10147/ : ABORTED

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/10147

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/6881/ : ABORTED

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/6881</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:24:17 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/11377/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/11377</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:24:59 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10150/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:25:09 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/6884/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:25:42 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:25:49 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:41:20 AM<br><strong>Message</strong>: <pre>Patch Set 4: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:43:04 AM<br><strong>Message</strong>: <pre>Patch Set 4: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 3:43:44 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10150/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/10150

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/6884/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/6884</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 3:52:30 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 8:53:42 AM<br><strong>Message</strong>: <pre>Patch Set 4: Code-Review+2</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 3/7/2019, 8:53:44 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Artem Barger</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 8:56:17 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5988/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 8:56:17 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4674/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/7/2019, 9:16:22 AM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4674/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/4674

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/5988/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/5988</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1551869699<br><strong>GitHubRevision</strong>: [4b9b7cdf89bc3202e5a2431a10ec55da54f2bea8](https://github.com/hyperledger/fabric/commit/4b9b7cdf89bc3202e5a2431a10ec55da54f2bea8)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/6/2019, 6:40:50 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1551945868<br><strong>GitHubRevision</strong>: [ad2b08a77c1fe49823db121baaea935590f155ad](https://github.com/hyperledger/fabric/commit/ad2b08a77c1fe49823db121baaea935590f155ad)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:11:46 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:11:46 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:23:38 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1551946416<br><strong>GitHubRevision</strong>: [0727f52d0386ea69273e5b7143ce1be2b82a45eb](https://github.com/hyperledger/fabric/commit/0727f52d0386ea69273e5b7143ce1be2b82a45eb)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:21:59 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:21:59 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Uploader</strong>: Yoav Tock - tock@il.ibm.com<br><strong>Created</strong>: 1551946574<br><strong>GitHubRevision</strong>: [85441660ff865f79e7e62a6a2870b8ee78921be5](https://github.com/hyperledger/fabric/commit/85441660ff865f79e7e62a6a2870b8ee78921be5)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:23:20 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:23:20 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:41:20 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/7/2019, 3:43:04 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 3/7/2019, 3:52:30 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Approved</strong>: 3/7/2019, 8:53:42 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Artem Barger<br><strong>Merged</strong>: 3/7/2019, 8:53:44 AM<br><br></blockquote>