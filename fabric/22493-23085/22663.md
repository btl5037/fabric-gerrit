<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 22663<br><strong>Subject</strong>: [FAB-10505] Memory coherent channel.Resources fetching<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 5/31/2018, 5:00:04 PM<br><strong>LastUpdated</strong>: 6/1/2018, 6:43:13 AM<br><strong>CommitMessage</strong>:<br><pre>[FAB-10505] Memory coherent channel.Resources fetching

The discovery calls peer.GetChannelConfig to fetch the latest
channelconfig.Resources object and extract from it the the
Sequence() of the channel (the config block sequence).

However, it might read a stale reference of the channelconfig.Resources
because that reference is updated via an atomic pointer,
while the peer.GetChannelConfig doesn't call an atomic load, but
relies on the channels map's RLock which the callback that
updates the map - doesn't lock.

This can be easily solved via just calling GetStableChannelConfig
instead of GetChannelConfig

Change-Id: I7374ebdc8cb991d0c38a1d39e7f39c0e717dce63
Signed-off-by: yacovm <yacovm@il.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/31/2018, 5:00:04 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:02:21 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/2250/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:02:38 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:08:58 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1 F3-IntegrationTest+1

Succeeded, Run SmokeTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:09:33 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/2250/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/2250</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:11:51 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-smoke-tests-x86_64/1503/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:12:19 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting smoke tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:23:32 PM<br><strong>Message</strong>: <pre>Patch Set 1: F2-SmokeTest+1

Succeeded, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:28:40 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2401/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:29:00 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:41:49 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest-1

Failed</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:42:10 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2401/ : FAILURE (skipped)

No problems were identified. If you know why this problem occurred, please add a suitable Cause for it. ( https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2401/ )

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/2401

https://jenkins.hyperledger.org/job/fabric-smoke-tests-x86_64/1503/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-smoke-tests-x86_64/1503</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 5/31/2018, 5:42:46 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:42:54 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2404/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:43:16 PM<br><strong>Message</strong>: <pre>Patch Set 1: -F3-UnitTest

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:56:12 PM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 5/31/2018, 5:56:33 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/2404/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/2404</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 5/31/2018, 7:42:57 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 6/1/2018, 6:03:53 AM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 6/1/2018, 6:03:55 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by David Enyeart</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/1/2018, 6:06:39 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/3949/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/1/2018, 6:07:51 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/2619/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 6/1/2018, 6:43:13 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/3949/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/3949

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/2619/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/2619</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Uploader</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Created</strong>: 5/31/2018, 5:00:04 PM<br><strong>GitHubMergedRevision</strong>: [578c7db15e6bc4dbd0bbf55ddbf3883897616286](https://github.com/hyperledger/fabric/commit/578c7db15e6bc4dbd0bbf55ddbf3883897616286)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/31/2018, 5:08:58 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/31/2018, 5:08:58 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/31/2018, 5:23:32 PM<br><strong>Type</strong>: F2-SmokeTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/31/2018, 5:08:58 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 5/31/2018, 5:56:12 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 5/31/2018, 7:42:57 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 6/1/2018, 6:03:53 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: David Enyeart<br><strong>Merged</strong>: 6/1/2018, 6:03:55 AM<br><br></blockquote>