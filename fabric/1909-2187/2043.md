<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 2043<br><strong>Subject</strong>: Do not block on Broadcast responses<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Luis Sanchez - luiss@me.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 10/26/2016, 12:22:46 PM<br><strong>LastUpdated</strong>: 11/17/2016, 12:10:40 PM<br><strong>CommitMessage</strong>:<br><pre>Do not block on Broadcast responses

FAB-839

Added per-connection buffered channel of size QueueSize
for responses.

Added unit test TestBroadcastResponseQueueOverflow.

Change-Id: I317d127f74dcc8115201f8c127e83230d9d13a58
Signed-off-by: Luis Sanchez <sanchezl@us.ibm.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/26/2016, 12:22:46 PM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/26/2016, 1:37:13 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2079/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/26/2016, 1:38:50 PM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/974/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/26/2016, 2:38:30 PM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/974/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2079/ : SUCCESS</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/26/2016, 3:28:11 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review-1

Thank you for submitting this. What we're looking for in FAB-839 is a per-connection, buffered, *response* channel. So, I suggest we adjust the logic here should be adjusted along the following lines: 

1. Pass the response object to the per-connection buffered channel.
2. Have the per-connection goroutine that you spawn (drainQueue()) read from that channel and do a stream.Send(), i.e. move the second half of recvRequests() to drainQueue() (which will have to be renamed).</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/27/2016, 11:25:07 AM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/27/2016, 11:27:17 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2120/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/27/2016, 11:30:39 AM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1015/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/27/2016, 12:25:53 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1015/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2120/ : SUCCESS</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/28/2016, 9:56:28 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(2 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/28/2016, 1:16:08 PM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/28/2016, 1:17:10 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1042/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/28/2016, 1:19:10 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2147/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/28/2016, 2:39:00 PM<br><strong>Message</strong>: <pre>Patch Set 3: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1042/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2147/ : FAILURE</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 10/28/2016, 4:23:26 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(1 comment)</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/28/2016, 6:55:56 PM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review-1

(5 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/29/2016, 5:40:40 PM<br><strong>Message</strong>: <pre>Uploaded patch set 4.</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/29/2016, 5:41:10 PM<br><strong>Message</strong>: <pre>Patch Set 3:

(5 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 5:41:26 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1052/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 5:43:28 PM<br><strong>Message</strong>: <pre>Patch Set 4:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2157/ (2/2)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/29/2016, 5:44:35 PM<br><strong>Message</strong>: <pre>Uploaded patch set 5.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 5:46:00 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1053/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 5:48:21 PM<br><strong>Message</strong>: <pre>Patch Set 5:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2158/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 6:20:45 PM<br><strong>Message</strong>: <pre>Patch Set 5: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1053/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2158/ : FAILURE</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/29/2016, 6:28:12 PM<br><strong>Message</strong>: <pre>Patch Set 4: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1052/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2157/ : FAILURE</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/30/2016, 12:03:37 AM<br><strong>Message</strong>: <pre>Patch Set 5:

(3 comments)

We're almost there. Give the BDD tests a check though. (I've only had a quick look, but as far as I can tell, it's always the second consecutive Kafka-related test that fails (whichever you want that to be), so I'm guessing that something is leaking.)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 10/31/2016, 11:31:46 AM<br><strong>Message</strong>: <pre>Uploaded patch set 6.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/31/2016, 11:33:57 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1064/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/31/2016, 11:36:04 AM<br><strong>Message</strong>: <pre>Patch Set 6:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2169/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 10/31/2016, 12:48:15 PM<br><strong>Message</strong>: <pre>Patch Set 6: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1064/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2169/ : FAILURE</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 10/31/2016, 7:11:29 PM<br><strong>Message</strong>: <pre>Patch Set 6: Code-Review-1

BDD tests fail, can you look into it?</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/1/2016, 12:58:05 PM<br><strong>Message</strong>: <pre>Uploaded patch set 7.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/1/2016, 12:59:06 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1105/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/1/2016, 1:00:51 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2210/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/1/2016, 1:44:05 PM<br><strong>Message</strong>: <pre>Patch Set 7: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1105/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2210/ : FAILURE</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/2/2016, 7:42:08 PM<br><strong>Message</strong>: <pre>Patch Set 7: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2293/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/2/2016, 7:42:11 PM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1182/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/2/2016, 8:25:13 PM<br><strong>Message</strong>: <pre>Patch Set 7: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2293/ : FAILURE

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1182/ : FAILURE (skipped)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/3/2016, 12:08:51 PM<br><strong>Message</strong>: <pre>Patch Set 7:

CI Failure:


00:25:11 orderer/kafka/broadcast.go:20:2: cannot find package "context" in any of:
00:25:11 	/w/workspace/fabric-verify-x86_64/gopath/src/github.com/hyperledger/fabric/vendor/context (vendor tree)
00:25:11 	/opt/go/go1.6.linux.amd64/src/context (from $GOROOT)
00:25:11 	/w/workspace/fabric-verify-x86_64/gopath/src/context (from $GOPATH)
00:25:11 error: exit status 1
00:25:11 panic: EOF
00:25:11</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/3/2016, 1:33:02 PM<br><strong>Message</strong>: <pre>Patch Set 7:

> CI Failure:
 > 
 > 00:25:11 orderer/kafka/broadcast.go:20:2: cannot find package
 > "context" in any of:
 > 00:25:11 	/w/workspace/fabric-verify-x86_64/gopath/src/github.com/hyperledger/fabric/vendor/context
 > (vendor tree)
 > 00:25:11 	/opt/go/go1.6.linux.amd64/src/context (from $GOROOT)
 > 00:25:11 	/w/workspace/fabric-verify-x86_64/gopath/src/context
 > (from $GOPATH)
 > 00:25:11 error: exit status 1
 > 00:25:11 panic: EOF
 > 00:25:11

I suspect that what goes on here is that Luis is referencing the "context" package (the way he's supposed to) in Go 1.7, but the CI still runs on an older version, which expects the "context" package to be in a different location.

This link offers more info: https://golang.org/doc/go1.7#context

I suggest getting in touch with Ry and/or Greg and see if the upgrade to a Go 1.7-'ed CI is imminent. I know it's on their radar for sure, but from what I gathered it's not a straightforward process.</pre><strong>Reviewer</strong>: Ry Jones - ry@linux.com<br><strong>Reviewed</strong>: 11/4/2016, 9:54:00 AM<br><strong>Message</strong>: <pre>Removed the following votes:

* Verified-1 by Hyperledger Jobbuilder <jobbuilder@jenkins.hyperledger.org>
</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 9:56:35 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1232/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 9:58:50 AM<br><strong>Message</strong>: <pre>Patch Set 7:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2368/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 10:39:18 AM<br><strong>Message</strong>: <pre>Patch Set 7: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1232/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2368/ : FAILURE</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/4/2016, 11:27:20 AM<br><strong>Message</strong>: <pre>Uploaded patch set 8.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 11:27:26 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1237/ (1/2)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/4/2016, 11:29:52 AM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+1

(2 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 11:32:11 AM<br><strong>Message</strong>: <pre>Patch Set 8:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2373/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/4/2016, 12:27:04 PM<br><strong>Message</strong>: <pre>Patch Set 8: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1237/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2373/ : SUCCESS</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 11/4/2016, 2:27:45 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(1 comment)</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 11/4/2016, 2:33:30 PM<br><strong>Message</strong>: <pre>Patch Set 8: Code-Review+1</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/4/2016, 3:19:18 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(2 comments)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/4/2016, 3:20:15 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(2 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/8/2016, 2:13:00 PM<br><strong>Message</strong>: <pre>Uploaded patch set 9.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 2:14:55 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1392/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 2:19:27 PM<br><strong>Message</strong>: <pre>Patch Set 9:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2542/ (2/2)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/8/2016, 2:47:47 PM<br><strong>Message</strong>: <pre>Uploaded patch set 10.</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/8/2016, 2:48:05 PM<br><strong>Message</strong>: <pre>Patch Set 8:

(4 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 2:57:28 PM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1402/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 2:57:30 PM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2553/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 3:07:08 PM<br><strong>Message</strong>: <pre>Patch Set 9: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1392/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2542/ : SUCCESS</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 3:21:19 PM<br><strong>Message</strong>: <pre>Patch Set 10: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1402/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2553/ : FAILURE</pre><strong>Reviewer</strong>: Ry Jones - ry@linux.com<br><strong>Reviewed</strong>: 11/8/2016, 3:52:34 PM<br><strong>Message</strong>: <pre>Patch Set 10:

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 3:53:46 PM<br><strong>Message</strong>: <pre>Patch Set 10: -Verified

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1403/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 3:54:50 PM<br><strong>Message</strong>: <pre>Patch Set 10:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2554/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/8/2016, 4:21:57 PM<br><strong>Message</strong>: <pre>Patch Set 10: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1403/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2554/ : FAILURE</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/8/2016, 5:14:05 PM<br><strong>Message</strong>: <pre>Patch Set 10: Code-Review-1

(13 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 2:20:17 PM<br><strong>Message</strong>: <pre>Patch Set 10:

(9 comments)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 2:22:14 PM<br><strong>Message</strong>: <pre>Uploaded patch set 11.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 2:22:23 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1427/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 2:23:06 PM<br><strong>Message</strong>: <pre>Patch Set 11:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2578/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 2:30:38 PM<br><strong>Message</strong>: <pre>Patch Set 11: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1427/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2578/ : FAILURE</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 3:44:29 PM<br><strong>Message</strong>: <pre>Uploaded patch set 12.</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 3:45:22 PM<br><strong>Message</strong>: <pre>Patch Set 12: Code-Review+1

reverify</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 3:46:18 PM<br><strong>Message</strong>: <pre>Patch Set 12:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1450/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 3:46:34 PM<br><strong>Message</strong>: <pre>Patch Set 12:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2601/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 3:47:17 PM<br><strong>Message</strong>: <pre>Patch Set 12:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1451/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 3:47:18 PM<br><strong>Message</strong>: <pre>Patch Set 12:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2602/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 3:52:25 PM<br><strong>Message</strong>: <pre>Patch Set 12: Verified-1

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1451/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2602/ : FAILURE</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 4:01:01 PM<br><strong>Message</strong>: <pre>Patch Set 12:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1450/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2601/ : FAILURE</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 8:23:36 PM<br><strong>Message</strong>: <pre>Uploaded patch set 13.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 8:25:10 PM<br><strong>Message</strong>: <pre>Patch Set 13:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1468/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 8:26:51 PM<br><strong>Message</strong>: <pre>Patch Set 13:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2619/ (2/2)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/9/2016, 8:41:35 PM<br><strong>Message</strong>: <pre>Uploaded patch set 14.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 8:43:56 PM<br><strong>Message</strong>: <pre>Patch Set 14:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1471/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 8:47:18 PM<br><strong>Message</strong>: <pre>Patch Set 14:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2622/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 9:16:04 PM<br><strong>Message</strong>: <pre>Patch Set 13: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1468/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2619/ : SUCCESS</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/9/2016, 9:37:07 PM<br><strong>Message</strong>: <pre>Patch Set 14: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1471/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2622/ : SUCCESS</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/10/2016, 1:39:00 PM<br><strong>Message</strong>: <pre>Uploaded patch set 15.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/10/2016, 1:39:09 PM<br><strong>Message</strong>: <pre>Patch Set 15:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1498/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/10/2016, 1:42:07 PM<br><strong>Message</strong>: <pre>Patch Set 15:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2649/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/10/2016, 2:10:02 PM<br><strong>Message</strong>: <pre>Patch Set 15: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1498/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2649/ : SUCCESS</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/11/2016, 4:25:18 AM<br><strong>Message</strong>: <pre>Patch Set 15: Code-Review-1

(17 comments)

I can't quite figure out what the unit test, the way it's written, is supposed to do. The test's goal aside, I think the test-related code written here (1) is logic-wise far more complex than it should be, and (2) introduces methods, struct fields, and checks which are either not necessary or in clear violation of Go's guidelines (this was also brought up in the review of patchset #10).

To begin with, I do not understand why we need a "BlockSend()" and "UnblockSend()", and why we need to add a variable of "context.Context" type inside the "mockBroadcastStream" type.

As suggested in the comments of patchset #10, we really need two lines to achieve a blocking send:
1. A "closed" bool in the "mockBroadcastStream"
2. A "for mbs.blocked {}" as the first line the mockBroadcastStream's existing Send() method.

Then for the test, please correct me if I'm wrong, but the whole point is to (a) get the response queue to overflow, and (b) test for the expected result. The expected result is that we will never get back a block (it goes without saying that we won't get any replies along the process either).

Then, doesn't this test achieve the expected result in a much more straightforward manner?
https://gist.github.com/kchristidis/e2110e05220c0a3c244288d0b254ddea

I may well be missing something here, and I'll gladly stand correct if that's the case.

I do stand by my initial comment though that both the logic and the code presented in this patchset is far too complex and quite possibly unnecessarily so. I would also like us to strongly avoid going against Go's guidelines; if we want to cancel a goroutine to avoid leakage, and the only way to do it with a context.Context is by adding it in a struct type, then we should change course cause we're going against the spec ("Do not store Contexts inside a struct type."). We can easily cancel the goroutine via other means; the dieChan/deadChan idiom for instance.</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/14/2016, 4:19:31 PM<br><strong>Message</strong>: <pre>Uploaded patch set 16.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:21:13 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1575/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:21:19 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2729/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:24:40 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1576/ (1/2)</pre><strong>Reviewer</strong>: Luis Sanchez - luiss@me.com<br><strong>Reviewed</strong>: 11/14/2016, 4:24:40 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Refactored TestBroadcastResponseQueueOverflow as per the comments on patch set 15 by Kostas.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:27:01 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2730/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:52:15 PM<br><strong>Message</strong>: <pre>Patch Set 16: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1576/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2730/ : SUCCESS</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/14/2016, 4:53:07 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/1575/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/2729/ : SUCCESS</pre><strong>Reviewer</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Reviewed</strong>: 11/14/2016, 5:01:37 PM<br><strong>Message</strong>: <pre>Patch Set 16: Code-Review+1</pre><strong>Reviewer</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Reviewed</strong>: 11/17/2016, 10:27:30 AM<br><strong>Message</strong>: <pre>Patch Set 16: Code-Review+2</pre><strong>Reviewer</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>Reviewed</strong>: 11/17/2016, 10:53:16 AM<br><strong>Message</strong>: <pre>Patch Set 16:

(1 comment)

One comment requiring a comment response in this change set (not necessarily a code comment unless you would like to do that as well).</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 11/17/2016, 11:24:12 AM<br><strong>Message</strong>: <pre>Patch Set 16: Code-Review+2</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 11:24:16 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Jason Yellick</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 11:37:57 AM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-behave-x86_64/230/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 11:38:57 AM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/409/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 11/17/2016, 12:10:40 PM<br><strong>Message</strong>: <pre>Patch Set 16:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-merge-behave-x86_64/230/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/409/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/26/2016, 12:22:46 PM<br><strong>UnmergedRevision</strong>: [06e4c4645ad0088eccea76293c764b24944b5e4e](https://github.com/hyperledger-gerrit-archive/fabric/commit/06e4c4645ad0088eccea76293c764b24944b5e4e)<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 10/26/2016, 3:28:11 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L134](https://github.com/hyperledger-gerrit-archive/fabric/blob/06e4c4645ad0088eccea76293c764b24944b5e4e/orderer/kafka/broadcast.go#L134)<br><strong>Comment</strong>: <pre>Instead of blocking on a full queue, should I return Status_SERVICE_UNAVAILABLE on a full queue?</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L134](https://github.com/hyperledger-gerrit-archive/fabric/blob/06e4c4645ad0088eccea76293c764b24944b5e4e/orderer/kafka/broadcast.go#L134)<br><strong>Comment</strong>: <pre>I think that is a good idea. (Let's check to make sure that is the case with the solo orderer as well, so as to be consistent across implementations.)</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/27/2016, 11:25:07 AM<br><strong>UnmergedRevision</strong>: [3166502913acbba61553646ded95eeaa24eb0ae8](https://github.com/hyperledger-gerrit-archive/fabric/commit/3166502913acbba61553646ded95eeaa24eb0ae8)<br><br></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/28/2016, 1:16:08 PM<br><strong>UnmergedRevision</strong>: [767407f460f088ba08127bae889308ab1ae34e73](https://github.com/hyperledger-gerrit-archive/fabric/commit/767407f460f088ba08127bae889308ab1ae34e73)<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 10/28/2016, 6:55:56 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L121](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L121)<br><strong>Comment</strong>: <pre>Interesting, I would have simply used a channel, but maybe 'context' is something we should be utilizing more widely across the code.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L121](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L121)<br><strong>Comment</strong>: <pre>FYI: http://golang.rakyll.org/leakingctx/</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L138](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L138)<br><strong>Comment</strong>: <pre>Just to keep things inline with the rest of the code in this package, can we move this type definition towards the top of the file, along with the other type definitions? (Above newBroadcaster.)

I would also suggest that we rename this to a broadcastSessionResponder, to make it clear that this happens on a per-session basis.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L138](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L138)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L139](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L139)<br><strong>Comment</strong>: <pre>Given that ab.AtomicBroadcast_BroadcastServer is an interface, you do not need a pointer here.
Start from here: https://golang.org/doc/faq#pointer_to_interface

(And of course you can skip the 'stream' field on the broadcastResponder struct and just pass the stream reference directly from the newBroadcastResponder directly to the sendReplies method.)</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L139](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L139)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L152)<br><strong>Comment</strong>: <pre>I guess that the intent behind capitalizing this is to signal that this is meant to be called by a different object. I would however prefer that we keep this method unexported until we have to do otherwise (e.g. have an external package call it).

A one-line comment above the method to signal that it's meant to be be called by the broadcasterImpl will do. (Note that you should have had a comment for this exported method anyway.)</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L152)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L160](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L160)<br><strong>Comment</strong>: <pre>Removing the pointer to the interface will also simplify this reference.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L160](https://github.com/hyperledger-gerrit-archive/fabric/blob/767407f460f088ba08127bae889308ab1ae34e73/orderer/kafka/broadcast.go#L160)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 4</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/29/2016, 5:40:40 PM<br><strong>UnmergedRevision</strong>: [04cb5035678044c7024eb26aad9221d10ae36c48](https://github.com/hyperledger-gerrit-archive/fabric/commit/04cb5035678044c7024eb26aad9221d10ae36c48)<br><br></blockquote><h3>PatchSet Number: 5</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/29/2016, 5:44:35 PM<br><strong>UnmergedRevision</strong>: [45edec03735838572617758bafd8d07842850170](https://github.com/hyperledger-gerrit-archive/fabric/commit/45edec03735838572617758bafd8d07842850170)<br><br></blockquote><h3>PatchSet Number: 6</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 10/31/2016, 11:31:46 AM<br><strong>UnmergedRevision</strong>: [5b6e580fa7801f7f2546622aa2b424e7685a8ef6](https://github.com/hyperledger-gerrit-archive/fabric/commit/5b6e580fa7801f7f2546622aa2b424e7685a8ef6)<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 10/31/2016, 7:11:29 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 7</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/1/2016, 12:58:05 PM<br><strong>UnmergedRevision</strong>: [cd8f4fd5b05abbea678e44e7ec7415560ad2310d](https://github.com/hyperledger-gerrit-archive/fabric/commit/cd8f4fd5b05abbea678e44e7ec7415560ad2310d)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/4/2016, 10:39:18 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L133](https://github.com/hyperledger-gerrit-archive/fabric/blob/cd8f4fd5b05abbea678e44e7ec7415560ad2310d/orderer/kafka/broadcast.go#L133)<br><strong>Comment</strong>: <pre>I undid my changes from the previous patch sets for this review here. The intent was to return Status_UNAVAILABLE here if the 'batchChan' is full. I removed it because there does not seem to be enough breathing room for a client to send more than general.BatchSize messages at a time. See https://jira.hyperledger.org/browse/FAB-821</pre></blockquote><h3>PatchSet Number: 8</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/4/2016, 11:27:20 AM<br><strong>UnmergedRevision</strong>: [6822b7cd27542d388bcd7e46ebf991372ac38490](https://github.com/hyperledger-gerrit-archive/fabric/commit/6822b7cd27542d388bcd7e46ebf991372ac38490)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/4/2016, 12:27:04 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Luis Sanchez - luiss@me.com<br><strong>Approved</strong>: 11/4/2016, 11:29:52 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 11/4/2016, 2:33:30 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L21](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L21)<br><strong>Comment</strong>: <pre>I had to use the golang 1.6 name for this package, as the CI runs golang 1.6, not 1.7 (like the dev env)</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L138](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L138)<br><strong>Comment</strong>: <pre>Unless I'm mistaken, this closing is redundant. What will prompt the termination of the sendReplies goroutine is recvRequests returning, at which point you don't run risk of anyone attempting to write to the queue. And w/r/t reading from the queue, that's where the cancellation of the context (line 136) comes in.

Feel free to correct me if I'm wrong.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L138](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L138)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L158)<br><strong>Comment</strong>: <pre>perhaps we should add a new test in order to see what happens if we overflow the queue here?</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L158)<br><strong>Comment</strong>: <pre>I second that.

I suspect that what makes your life difficult is that you cannot mess around with the broadcastSessionResponder easily for a unit test.

You can create an interface to capture broadcastSessionResponder's behavior, and then use a mockBroadcastSessionResponder to mess around with for your unit test.

Or you can resort to the technique that I'm employing for the ClientDeliverer tests where I use brokerFunc and consumerFunc fields in the clientDelivererImpl to store the functions that are used for communicating with the broker, and consuming from the broker respectively, and then in the mockClientDelivererImpl I simply overwrite these two fields for the functions that I want for the unit test.

In your case, you would probably add a sessionRespFunc field in your broadcasterImpl, and proceed accordingly.</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L158)<br><strong>Comment</strong>: <pre>Might not be a bad idea.  I think the idea is that once the queue is full, writing to the queue will block, restoring the old blocking response behavior.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L158](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/kafka/broadcast.go#L158)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [orderer/orderer.yaml#L27](https://github.com/hyperledger-gerrit-archive/fabric/blob/6822b7cd27542d388bcd7e46ebf991372ac38490/orderer/orderer.yaml#L27)<br><strong>Comment</strong>: <pre>Perhaps clarify that this is being used as both the size for the client ingress and the client reply egress paths.  Either that, or maybe make the description more generic that it is the queue size used internally for non-blocking network IO.</pre></blockquote><h3>PatchSet Number: 9</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/8/2016, 2:13:00 PM<br><strong>UnmergedRevision</strong>: [ee0b23c39a7f023af4013cd8e92f9aae1da75cc4](https://github.com/hyperledger-gerrit-archive/fabric/commit/ee0b23c39a7f023af4013cd8e92f9aae1da75cc4)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/8/2016, 3:07:08 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L117](https://github.com/hyperledger-gerrit-archive/fabric/blob/ee0b23c39a7f023af4013cd8e92f9aae1da75cc4/orderer/kafka/broadcast_test.go#L117)<br><strong>Comment</strong>: <pre>I couldn't figure out the correct syntax to make a copy of testConf and just edit the BatchSize.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L181](https://github.com/hyperledger-gerrit-archive/fabric/blob/ee0b23c39a7f023af4013cd8e92f9aae1da75cc4/orderer/kafka/broadcast_test.go#L181)<br><strong>Comment</strong>: <pre>whoops, I accidentally deleted the call to t.Fatal() here.</pre></blockquote><h3>PatchSet Number: 10</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/8/2016, 2:47:47 PM<br><strong>UnmergedRevision</strong>: [e73bfc545f163c50d3013ecb5ea49169653dee04](https://github.com/hyperledger-gerrit-archive/fabric/commit/e73bfc545f163c50d3013ecb5ea49169653dee04)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/8/2016, 4:21:57 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 11/8/2016, 5:14:05 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast.go#L116)<br><strong>Comment</strong>: <pre>For consistency with the rest of the error paths in this goroutine, let's panic here.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast.go#L116)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast.go#L116)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L116](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast.go#L116)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_mock_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_mock_test.go#L30)<br><strong>Comment</strong>: <pre>Why do we need this multiplier? If it's truly needed, can we add this as a variable on the "var" definition block of the config_test.go file, similar to what we do for all the "custom" config that the tests use? (Along with a comment explaining why it's needed.)</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_mock_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_mock_test.go#L30)<br><strong>Comment</strong>: <pre>Done
When cap(batchChan) == BatchSize I was getting blocked when sending > BatchSize messages, and there did not seem to be a way to unblock (I didn't take good notes on this). Since I'm setting BlockSize to 1, it always blocks during tests. I can perform more diagnosis, but this quickly takes care of it.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_mock_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_mock_test.go#L30)<br><strong>Comment</strong>: <pre>> When cap(batchChan) == BatchSize I was getting blocked when sending > BatchSize messages, and there did not seem to be a way to unblock (I didn't take good notes on this). Since I'm setting BlockSize to 1, it always blocks during tests. I can perform more diagnosis, but this quickly takes care of it.

I don't follow.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L117](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L117)<br><strong>Comment</strong>: <pre>All of this can be replaced with this statement:

testConf.General.BatchSize = 1

The config_test.go file holds all the variables/settings that the tests use.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L117](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L117)<br><strong>Comment</strong>: <pre>I was trying to keep the tests independent of each other. If I change it in the global testConf, other tests will fail. I will use your example, and then defer a revert to the original value.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L117](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L117)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L117](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L117)<br><strong>Comment</strong>: <pre>This is a good point, and I like the fix that you came up with.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L122](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L122)<br><strong>Comment</strong>: <pre>Can you add a comment describing what this in-flight block is?</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L122](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L122)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L150](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L150)<br><strong>Comment</strong>: <pre>There's no need for that check.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L150](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L150)<br><strong>Comment</strong>: <pre>I don't know how many fill-in blocks I will get, so I don't count them in expectedNumberOfBlocks. I would of expected oldestOffset-1 fill-in blocks, but I don't always get that exact number.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L150](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L150)<br><strong>Comment</strong>: <pre>I may be missing something (see comments in review summary) because I still don't understand why this test is necessary. All of the tests kick in after the fill-in blocks have been pushed to set up the associated producer, so they should be indifferent to you. (The only tests that check for fill-in blocks are the producer-related ones, as they should, because that's within their scope.)

To put it differently, if you study all of the tests in this package you'll see a common pattern: we don't care about the fill-in blocks, we start caring about what happens right after these have been pushed.

As further proof that this check is not needed, the test I offered in the Gist link doesn't care for fill-in blocks either.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L152)<br><strong>Comment</strong>: <pre>This is an extremely long timeout value for a unit test. I would use timePadding, which is defined in config_test.go.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L152)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L152)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L152)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L155](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L155)<br><strong>Comment</strong>: <pre>This whole test can be moved after TestBroadcastBatch. Then, given that you have already tested the code for proper sending of batches, you can replace all of this for loop with the following:

for i := 0; i < expectedNumberOfBlocks; i++ {
		<-disk // We tested batch reception in a previous test, so we can ignore this for now
}

This is inline with the pattern that I'm following throughout the kafka package.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L155](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L155)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L162](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L162)<br><strong>Comment</strong>: <pre>I'm not sure why we're testing for that here. The goal of this test is to check the broadcast response overflow. If this is something that you wish to test, you're better off creating a separate test. I wouldn't want us to mix two checks into one test though.</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L162](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L162)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L162](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L162)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L162](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L162)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L183)<br><strong>Comment</strong>: <pre>"testConf.General.BatchTimeout + timePadding" is the right timeout value here, inline with what TestBroadcastIncompleteBatch does. (In fact, I should update all the tests so that their timeout values are based on variables specified in config_test.go)</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L183)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L183)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L183](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/broadcast_test.go#L183)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L69](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/orderer_mock_test.go#L69)<br><strong>Comment</strong>: <pre>Overall, I wouldn't want to introduce a new type unless absolutely necessary.

Given my comments on the way the context package is used (see below), I think it's ultimately better to add a "blocked" boolean in the "mockBroadcastStream" type definition, and modify the Send method logic so that it blocks if mbs.blocked == true. This is cleaner and inline with mbs.closed-related logic.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L71](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/orderer_mock_test.go#L71)<br><strong>Comment</strong>: <pre>This violates the guideline of the context package: "Do not store Contexts inside a struct type; instead, pass a Context explicitly to each function that needs it."</pre><strong>Commenter</strong>: Luis Sanchez - luiss@me.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L71](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/orderer_mock_test.go#L71)<br><strong>Comment</strong>: <pre>Unfortunately, I can't change the signature of the function that needs it.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L77](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/orderer_mock_test.go#L77)<br><strong>Comment</strong>: <pre>I'm curious -wWhat is the point of this select on a single case? Is there a reason why we don't simply do "<-mbbs.context.Done()", without a select?</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L81](https://github.com/hyperledger-gerrit-archive/fabric/blob/e73bfc545f163c50d3013ecb5ea49169653dee04/orderer/kafka/orderer_mock_test.go#L81)<br><strong>Comment</strong>: <pre>This violates the guideline of the context package: "The Context should be the first parameter, typically named ctx."</pre></blockquote><h3>PatchSet Number: 11</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/9/2016, 2:22:14 PM<br><strong>UnmergedRevision</strong>: [be6040a500f9c78aa2edea4fa427dff9b952745b](https://github.com/hyperledger-gerrit-archive/fabric/commit/be6040a500f9c78aa2edea4fa427dff9b952745b)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/9/2016, 2:30:38 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br></blockquote><h3>PatchSet Number: 12</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/9/2016, 3:44:29 PM<br><strong>UnmergedRevision</strong>: [1219c38d4906cbb5a7665da8cd7ebb23eaf79922](https://github.com/hyperledger-gerrit-archive/fabric/commit/1219c38d4906cbb5a7665da8cd7ebb23eaf79922)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/9/2016, 3:52:25 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: -1<br><br><strong>Approver</strong>: Luis Sanchez - luiss@me.com<br><strong>Approved</strong>: 11/9/2016, 3:45:22 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 13</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/9/2016, 8:23:36 PM<br><strong>UnmergedRevision</strong>: [454551a2343de57376dc79d38d25565af50d8489](https://github.com/hyperledger-gerrit-archive/fabric/commit/454551a2343de57376dc79d38d25565af50d8489)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/9/2016, 9:16:04 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 14</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/9/2016, 8:41:35 PM<br><strong>UnmergedRevision</strong>: [e461c102b314d1e007783b626835b55319bde6fe](https://github.com/hyperledger-gerrit-archive/fabric/commit/e461c102b314d1e007783b626835b55319bde6fe)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/9/2016, 9:37:07 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br></blockquote><h3>PatchSet Number: 15</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/10/2016, 1:39:00 PM<br><strong>UnmergedRevision</strong>: [dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e](https://github.com/hyperledger-gerrit-archive/fabric/commit/dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/10/2016, 2:10:02 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 11/11/2016, 4:25:18 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: -1<br><br><h2>Comments</h2><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_mock_test.go#L30](https://github.com/hyperledger-gerrit-archive/fabric/blob/dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e/orderer/kafka/broadcast_mock_test.go#L30)<br><strong>Comment</strong>: <pre>conf.General.BatchSize

(see comment in config_test.go as well)</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast_test.go#L171](https://github.com/hyperledger-gerrit-archive/fabric/blob/dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e/orderer/kafka/broadcast_test.go#L171)<br><strong>Comment</strong>: <pre>I don't understand this explanation.</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/config_test.go#L31](https://github.com/hyperledger-gerrit-archive/fabric/blob/dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e/orderer/kafka/config_test.go#L31)<br><strong>Comment</strong>: <pre>As I show in this Gist (see review's summary comment), this modification is not needed, but just in case we need to do something similar next time, we're better off modifying the BatchSize field in the testConf variable below (line 43).</pre><strong>Commenter</strong>: Kostas Christidis - kostas@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/orderer_mock_test.go#L45](https://github.com/hyperledger-gerrit-archive/fabric/blob/dd815ee07f8d5aa9bfe5d25ce4b112fc948bbc7e/orderer/kafka/orderer_mock_test.go#L45)<br><strong>Comment</strong>: <pre>As pointed out earlier, this is a violation of the context package's guidelines.</pre></blockquote><h3>PatchSet Number: 16</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Luis Sanchez - luiss@me.com<br><strong>Uploader</strong>: Luis Sanchez - luiss@me.com<br><strong>Created</strong>: 11/14/2016, 4:19:31 PM<br><strong>GitHubMergedRevision</strong>: [7442b127dc0712ab96a9bf89e9d696250bb60733](https://github.com/hyperledger-gerrit-archive/fabric/commit/7442b127dc0712ab96a9bf89e9d696250bb60733)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 11/14/2016, 4:52:15 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Kostas Christidis - kostas@gmail.com<br><strong>Approved</strong>: 11/14/2016, 5:01:37 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Approved</strong>: 11/17/2016, 11:24:12 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Jason Yellick<br><strong>Merged</strong>: 11/17/2016, 11:24:16 AM<br><br><strong>Approver</strong>: Gari Singh - gari.r.singh@gmail.com<br><strong>Approved</strong>: 11/17/2016, 10:27:30 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Srinivasan Muralidharan - srinivasan.muralidharan99@gmail.com<br><strong>CommentLine</strong>: [orderer/kafka/broadcast.go#L152](https://github.com/hyperledger-gerrit-archive/fabric/blob/7442b127dc0712ab96a9bf89e9d696250bb60733/orderer/kafka/broadcast.go#L152)<br><strong>Comment</strong>: <pre>Does not need to be done in this Change Set but seems important to note (1) when it would NOT be success (2) what the TODO depends upon and (3) when we should expect the fix to be done</pre></blockquote>