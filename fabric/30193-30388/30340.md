<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 30340<br><strong>Subject</strong>: [FAB-14778] QueryApprovalStatus function<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Assignee</strong>:<br><strong>Created</strong>: 3/23/2019, 7:04:48 AM<br><strong>LastUpdated</strong>: 3/27/2019, 7:32:59 PM<br><strong>CommitMessage</strong>:<br><pre>[FAB-14778] QueryApprovalStatus function

This CR introduces a new query for the new lifecycle, QueryApprovalStatus.
This query consults the implicit collections of all active orgs in the
channel and returns whether they have approved the supplied definition.
This query is useful to determine whether a chaincode definition has a
chance of being committed.

Change-Id: Ic4891f2cb51a16880ba93be384b88defd05d95a9
Signed-off-by: Alessandro Sorniotti <ale.linux@sopit.net>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/23/2019, 7:04:48 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:06:38 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/12125/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:07:11 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:12:03 AM<br><strong>Message</strong>: <pre>Patch Set 1: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:12:45 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/12125/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/12125</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:13:48 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10808/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:14:23 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:14:41 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/7464/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:15:14 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:44:18 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:56:36 AM<br><strong>Message</strong>: <pre>Patch Set 1: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/23/2019, 7:57:16 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10808/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/10808

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/7464/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/7464</pre><strong>Reviewer</strong>: Rick Rine - cr22rc@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 10:53:01 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 1:48:21 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 2:32:11 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 2:52:53 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 3:00:15 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)

Thanks Manish, see my responses below</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 3:11:45 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 3:29:27 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(3 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 3:41:02 PM<br><strong>Message</strong>: <pre>Patch Set 1: Code-Review+2

(2 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 3:41:28 PM<br><strong>Message</strong>: <pre>Removed Code-Review+2 by Manish Sethi <manish.sethi@gmail.com>
</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 4:01:02 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>Reviewed</strong>: 3/26/2019, 4:10:19 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(1 comment)</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 4:28:21 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Reviewed</strong>: 3/26/2019, 4:29:07 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:33:32 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/12322/</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:34:05 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting verify build</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:39:39 PM<br><strong>Message</strong>: <pre>Patch Set 2: F2-DocBuild+1 F1-VerifyBuild+1

Succeeded, Run IntegrationTest, Run UnitTest</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:40:22 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-build-checks-x86_64/12322/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-build-checks-x86_64/12322</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:41:53 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10957/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:42:20 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting unit tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:42:37 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/7636/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 4:43:04 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Starting Integration tests</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 5:07:13 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-UnitTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 5:23:53 PM<br><strong>Message</strong>: <pre>Patch Set 2: F3-IntegrationTest+1

Succeeded</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/26/2019, 5:24:38 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-unit-tests-x86_64/10957/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-unit-tests-x86_64/10957

https://jenkins.hyperledger.org/job/fabric-verify-integration-tests-x86_64/7636/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-verify-integration-tests-x86_64/7636</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/26/2019, 7:03:57 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2

(1 comment)</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 3/27/2019, 6:38:35 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+2</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 3/27/2019, 6:38:38 PM<br><strong>Message</strong>: <pre>Change has been successfully merged by Yacov Manevich</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/27/2019, 6:41:18 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6262/ (1/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/27/2019, 6:41:58 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4948/ (2/2)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/27/2019, 7:32:59 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/6262/ : FAILURE (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-x86_64/6262

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/4948/ : SUCCESS (skipped)

Logs: https://logs.hyperledger.org/production/vex-yul-hyp-jenkins-3/fabric-merge-end-2-end-x86_64/4948</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 3/23/2019, 7:04:48 AM<br><strong>UnmergedRevision</strong>: [91680cf5feae85ad968fd810ba2a39254ef8fb9a](https://github.com/hyperledger-gerrit-archive/fabric/commit/91680cf5feae85ad968fd810ba2a39254ef8fb9a)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/23/2019, 7:12:03 AM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/23/2019, 7:12:03 AM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/23/2019, 7:56:36 AM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/23/2019, 7:44:18 AM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L228](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L228)<br><strong>Comment</strong>: <pre>Do you want to restrict the query "QueryApprovalStatus" to next sequence only? For instance, this may be useful query even for the currentSequence if someone wants to know the potential list of orgs that would endorse the chaincode transactions.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L228](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L228)<br><strong>Comment</strong>: <pre>After discussion with Jason, the idea is that this query shall be the --dry-run version of commit: right before committing the admin can run this query with the exact same arguments (and restrictions over them) and gauge the chances of success for that operation. Given that commit is restricted to the next sequence number only, the restriction can reasonably be applied to its dry-run version too.

That said, we plan to add another query that takes only the sequence number as arguments and returns the full info about the definition with that sequence number, including the list of orgs that have approved it.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L228](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L228)<br><strong>Comment</strong>: <pre>Sure, just that the function name seems more generic than limited to DryRun. In that case its more like "CommitReadinessStatus"</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L228](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L228)<br><strong>Comment</strong>: <pre>Good point - the name is a tad misleading. I'll reach out and poll for a better name - okay if we merge it as is for now? I've created https://jira.hyperledger.org/browse/FAB-14831 to track it</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L228](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L228)<br><strong>Comment</strong>: <pre>Sure, Thanks. Added a reference to this discucssion in the Jira for a better context.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L229)<br><strong>Comment</strong>: <pre>This message may look odd when this function gets called directly as opposed to via "CommitChaincodeDefinition"</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L229)<br><strong>Comment</strong>: <pre>Why? This was the exact message that CommitChaincodeDefinition used to return here</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L229)<br><strong>Comment</strong>: <pre>Same as above ApprovalStatus vs CommitReadiness</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L229](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L229)<br><strong>Comment</strong>: <pre>ack - https://jira.hyperledger.org/browse/FAB-14831</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>This may cause wrong results... don;t you want to return this error. Earlier, when this was being used by the CommitDef function, this may not have caused wrong results but now these results will be returned to end user.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>Returning them to the user may become cumbersome... how about logging them instead?</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>Now sure whether logging may help here.. My concern is that the results returned may be wrong... Unless we clarify in the API/Doc, that a false entry does not necessarily mean that the vote is missing (we could not have determined this because of an error).

Sorry, I missed why it is cumbersome to return error? You mean to say because of this code being invoked by the "CommitChaincodeDefinition" as well? If that's the case, is it not possible a small rearrangement of the code?</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>So, IsSerialized will only return i) errors related to non-serialisability (impossible to reach given that we supply a pointer to a properly-formed ChaincodeDefinition struct and ii) GetState errors. As discussed, i) is unreachable (modulo a programming error), so ii) is the only possibility. We could 

1) fail the operation and return an error if we get an error
2) let the operation succeed and return the error as part of the protobuf response. 

I would prefer 1), 2) would mean that the response proto must cater for possibly an error per queried org, which isn't pretty. Wdyt?

Note that if we go for 1) we must also change the way Commit behaves.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>Yes, I too would prefer 1).
About changing the Commit, I would not worry much because, in that function we don't return anything to the user. Rather, we simply check for own org vote and proceed with the writes. Having said that, there could be a "miss" in the readset but not something that is not tolerable. But if you want a consistent behavior I am not averse to it.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>In order to keep the code simple and the two functions one the dry-run of the other, I'd go for a similar failure model, so I would return an error and fail in both cases if IsSerialized fails. Wdyt? 

@Jason, please weigh in as well - thx!</pre><strong>Commenter</strong>: Jason Yellick - jyellick@us.ibm.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>I agree, isSerialized really should not return an error under any sane failure.  This would be cause to alert the user that they have bigger problems than chaincode disagreement.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle.go#L240](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/core/chaincode/lifecycle/lifecycle.go#L240)<br><strong>Comment</strong>: <pre>Thanks Manish and Jason - I've changed the failure model in the next patch set.</pre><strong>Commenter</strong>: Rick Rine - cr22rc@gmail.com<br><strong>CommentLine</strong>: [protos/peer/lifecycle/lifecycle.proto#L114](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/protos/peer/lifecycle/lifecycle.proto#L114)<br><strong>Comment</strong>: <pre>Probably me needing some more education :) But shouldn't sequence be enough? I thought it represented a change.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [protos/peer/lifecycle/lifecycle.proto#L114](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/protos/peer/lifecycle/lifecycle.proto#L114)<br><strong>Comment</strong>: <pre>The idea is that orgs may disagree on the definition, and so the only meaningful question is: given this definition (with all its fields), which org has approved it?</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [protos/peer/lifecycle/lifecycle.proto#L114](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/protos/peer/lifecycle/lifecycle.proto#L114)<br><strong>Comment</strong>: <pre>To add a little more context and report about the conclusions Jason and I reached: this query is intended to be the "--dry-run" version of CommitChaincodeDefinition and so it's convenient that it has the exact same arguments. We will add another query (likely after the alpha) that only takes a sequence number and reports about the details of that definition and also the set of orgs that have approved it.</pre><strong>Commenter</strong>: Rick Rine - cr22rc@gmail.com<br><strong>CommentLine</strong>: [protos/peer/lifecycle/lifecycle.proto#L129](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/protos/peer/lifecycle/lifecycle.proto#L129)<br><strong>Comment</strong>: <pre>I can't disapprove.  Why not just a list of orgs that have approved. The org is either approved or waiting for an approval.</pre><strong>Commenter</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>CommentLine</strong>: [protos/peer/lifecycle/lifecycle.proto#L129](https://github.com/hyperledger-gerrit-archive/fabric/blob/91680cf5feae85ad968fd810ba2a39254ef8fb9a/protos/peer/lifecycle/lifecycle.proto#L129)<br><strong>Comment</strong>: <pre>Right, but we want to later integrate support to query only a subset of orgs (*), at which point it's going to be useful to know which orgs don't approve, since we can't just say that anyone who doesn't show in the list doesn't approve, they might simply not have been asked.

(*): the reason for this requires a longer explanation: there is a theoretical denial of service attack with the new lifecycle, where a malicious org may prevent a definition from being approved simply by repeatedly changing one field of their definition (e.g. constantly changing the version string). Under this scenario, the network would no longer be able to make progress. One of the considered solutions is to supply an extra argument to the commit invocation, namely,  the set of orgs whose definition is inspected to determine approval. By excluding the misbehaving org, and under the assumption that the exclusion still leaves a quorum of orgs, the network can then make progress.</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Uploader</strong>: Alessandro Sorniotti - ale.linux@sopit.net<br><strong>Created</strong>: 3/26/2019, 4:28:21 PM<br><strong>GitHubMergedRevision</strong>: [0e0b3554c064218aee666de2199aea9cd612a4b6](https://github.com/hyperledger-gerrit-archive/fabric/commit/0e0b3554c064218aee666de2199aea9cd612a4b6)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/26/2019, 4:39:39 PM<br><strong>Type</strong>: F1-VerifyBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/26/2019, 4:39:39 PM<br><strong>Type</strong>: F2-DocBuild<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/26/2019, 5:23:53 PM<br><strong>Type</strong>: F3-IntegrationTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/26/2019, 5:07:13 PM<br><strong>Type</strong>: F3-UnitTest<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Approved</strong>: 3/26/2019, 7:03:57 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 3/27/2019, 6:38:35 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Yacov Manevich<br><strong>Merged</strong>: 3/27/2019, 6:38:38 PM<br><br><h2>Comments</h2><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/chaincode/lifecycle/lifecycle_test.go#L729](https://github.com/hyperledger-gerrit-archive/fabric/blob/0e0b3554c064218aee666de2199aea9cd612a4b6/core/chaincode/lifecycle/lifecycle_test.go#L729)<br><strong>Comment</strong>: <pre>you mean "good" ;-)</pre></blockquote>