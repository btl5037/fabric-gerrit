<strong>Project</strong>: fabric<br><strong>Branch</strong>: master<br><strong>ID</strong>: 7573<br><strong>Subject</strong>: create ledger with genesis block<br><strong>Status</strong>: MERGED<br><strong>Owner</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Assignee</strong>:<br><strong>Created</strong>: 3/30/2017, 6:05:09 AM<br><strong>LastUpdated</strong>: 4/1/2017, 12:31:30 PM<br><strong>CommitMessage</strong>:<br><pre>create ledger with genesis block

https://jira.hyperledger.org/browse/FAB-2676

This CR introduces a new function in the ledgermgmt package
`CreateWithGenesisBlock(genesisBlock *common.Block)` which
allows the ledger creation and committing of genesis block
atomically.

This can be used for peer joining a channel with the genesis block
with the config tx.

Change-Id: I8f90a2b623aabca27c35448bc6eb6bc13e2dbd90
Signed-off-by: manish <manish.sethi@gmail.com>
</pre><h1>Comments</h1><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/30/2017, 6:05:09 AM<br><strong>Message</strong>: <pre>Uploaded patch set 1.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/30/2017, 6:06:52 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9020/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/30/2017, 6:07:24 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/558/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/30/2017, 6:07:39 AM<br><strong>Message</strong>: <pre>Patch Set 1:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3091/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/30/2017, 7:27:15 AM<br><strong>Message</strong>: <pre>Patch Set 1: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3091/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9020/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/558/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 3/31/2017, 8:59:11 AM<br><strong>Message</strong>: <pre>Patch Set 1:

(4 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/31/2017, 1:55:43 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(4 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/31/2017, 2:12:05 PM<br><strong>Message</strong>: <pre>Uploaded patch set 2.</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 3/31/2017, 2:12:50 PM<br><strong>Message</strong>: <pre>Patch Set 1:

(2 comments)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/31/2017, 2:13:40 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9102/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/31/2017, 2:14:12 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/639/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/31/2017, 2:14:24 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3172/ (3/3)</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 3/31/2017, 2:52:37 PM<br><strong>Message</strong>: <pre>Patch Set 2: Code-Review+1

The plan is to have committer code CreateChainFromBlock() switch from CreateLedger() to CreateWithGenesisBlock().  This will ensure ledger is created atomically with genesis block.  After the switch is made, then CreateLedger() function will be removed so that there is no ambiguity... clients should always CreateWithGenesisBlock().</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 3/31/2017, 3:22:49 PM<br><strong>Message</strong>: <pre>Patch Set 2: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/639/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3172/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9102/ : SUCCESS</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 3/31/2017, 4:11:42 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 3/31/2017, 6:03:08 PM<br><strong>Message</strong>: <pre>Patch Set 2:

Same question as Yacov.  The rest LGTM</pre><strong>Reviewer</strong>: Artem Barger - bartem@il.ibm.com<br><strong>Reviewed</strong>: 3/31/2017, 8:25:04 PM<br><strong>Message</strong>: <pre>Patch Set 2:

(1 comment)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/1/2017, 12:20:53 AM<br><strong>Message</strong>: <pre>Patch Set 2:

(2 comments)</pre><strong>Reviewer</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Reviewed</strong>: 4/1/2017, 12:26:23 AM<br><strong>Message</strong>: <pre>Uploaded patch set 3.</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 12:27:30 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9118/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 12:28:17 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/655/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 12:28:39 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3188/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 1:54:39 AM<br><strong>Message</strong>: <pre>Patch Set 3: Verified+1

Build Successful 

https://jenkins.hyperledger.org/job/fabric-verify-behave-x86_64/3188/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-verify-x86_64/9118/ : SUCCESS

https://jenkins.hyperledger.org/job/fabric-verify-end-2-end-x86_64/655/ : SUCCESS</pre><strong>Reviewer</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Reviewed</strong>: 4/1/2017, 5:17:16 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1

(1 comment)</pre><strong>Reviewer</strong>: Baohua Yang - yangbaohua@gmail.com<br><strong>Reviewed</strong>: 4/1/2017, 5:32:12 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+1</pre><strong>Reviewer</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Reviewed</strong>: 4/1/2017, 11:00:39 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Reviewed</strong>: 4/1/2017, 11:25:44 AM<br><strong>Message</strong>: <pre>Patch Set 3: Code-Review+2</pre><strong>Reviewer</strong>: Gerrit Code Review - gerrit@hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 11:25:50 AM<br><strong>Message</strong>: <pre>Change has been successfully merged by Yacov Manevich</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 11:26:55 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/110/ (1/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 11:27:35 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-x86_64/1424/ (2/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 11:28:23 AM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Started https://jenkins.hyperledger.org/job/fabric-merge-behave-x86_64/428/ (3/3)</pre><strong>Reviewer</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Reviewed</strong>: 4/1/2017, 12:31:30 PM<br><strong>Message</strong>: <pre>Patch Set 3:

Build Failed 

https://jenkins.hyperledger.org/job/fabric-merge-x86_64/1424/ : FAILURE

https://jenkins.hyperledger.org/job/fabric-merge-behave-x86_64/428/ : FAILURE (skipped)

https://jenkins.hyperledger.org/job/fabric-merge-end-2-end-x86_64/110/ : SUCCESS</pre><h1>PatchSets</h1><h3>PatchSet Number: 1</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 3/30/2017, 6:05:09 AM<br><strong>UnmergedRevision</strong>: [566128c375f5f19d4aa245b0b2436b8dbc880f86](https://github.com/hyperledger-gerrit-archive/fabric/commit/566128c375f5f19d4aa245b0b2436b8dbc880f86)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/30/2017, 7:27:15 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L232](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L232)<br><strong>Comment</strong>: <pre>This would be rare and noteworthy when it does happen, I think better to log as Info().  Same with Debug statements below, so that administrator will know about the problem and the cleanup (especially if some cleanup goes badly).</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L232](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L232)<br><strong>Comment</strong>: <pre>yes, will change this to Info. Also, just noticed the hanging %s without corresponding arg :-)</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L232](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L232)<br><strong>Comment</strong>: <pre>Done</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L260](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L260)<br><strong>Comment</strong>: <pre>Binh may still depend on the directories, so I think they should get cleaned up.  But this could be left as TODO and done in subsequent changeset.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L260](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L260)<br><strong>Comment</strong>: <pre>I had changed all over in the peer code wherever directly internal ledger structures were being used and introduced the ledgermgmt package. Rest of peer code is expected to use only ledgermgmt package and the types/APIs exposed in the ledger interface. Please let me know if you come across any usage that bypass these.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L261](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L261)<br><strong>Comment</strong>: <pre>If genesis block did not get written (case 0), then couchdb state db would never have gotten created, nothing to cleanup.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L261](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/kvledger/kv_ledger_provider.go#L261)<br><strong>Comment</strong>: <pre>couchdb state db gets created when opening a new peerLedger at line 126</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/ledgermgmt/ledger_mgmt.go#L106)<br><strong>Comment</strong>: <pre>Creating the named ledger is one of the more significant lifecycle actions, let's print the ledger id in the Info statement.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/ledgermgmt/ledger_mgmt.go#L106)<br><strong>Comment</strong>: <pre>yes, sure. Will print.</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/ledgermgmt/ledger_mgmt.go#L106](https://github.com/hyperledger-gerrit-archive/fabric/blob/566128c375f5f19d4aa245b0b2436b8dbc880f86/core/ledger/ledgermgmt/ledger_mgmt.go#L106)<br><strong>Comment</strong>: <pre>Done</pre></blockquote><h3>PatchSet Number: 2</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 3/31/2017, 2:12:05 PM<br><strong>UnmergedRevision</strong>: [b7984b5bd559be72390123cb5e689ac0f9b9cd13](https://github.com/hyperledger-gerrit-archive/fabric/commit/b7984b5bd559be72390123cb5e689ac0f9b9cd13)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 3/31/2017, 3:22:49 PM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 3/31/2017, 2:52:37 PM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><h2>Comments</h2><strong>Commenter</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L133](https://github.com/hyperledger-gerrit-archive/fabric/blob/b7984b5bd559be72390123cb5e689ac0f9b9cd13/core/ledger/kvledger/kv_ledger_provider.go#L133)<br><strong>Comment</strong>: <pre>why don't you need to close the ledger here as in line 154?</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L133](https://github.com/hyperledger-gerrit-archive/fabric/blob/b7984b5bd559be72390123cb5e689ac0f9b9cd13/core/ledger/kvledger/kv_ledger_provider.go#L133)<br><strong>Comment</strong>: <pre>Yes, need to close here as well. Thanks for catching this.</pre><strong>Commenter</strong>: Artem Barger - bartem@il.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L136](https://github.com/hyperledger-gerrit-archive/fabric/blob/b7984b5bd559be72390123cb5e689ac0f9b9cd13/core/ledger/kvledger/kv_ledger_provider.go#L136)<br><strong>Comment</strong>: <pre>I'm confused, why first you commit a block and then create a ledger?</pre><strong>Commenter</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L136](https://github.com/hyperledger-gerrit-archive/fabric/blob/b7984b5bd559be72390123cb5e689ac0f9b9cd13/core/ledger/kvledger/kv_ledger_provider.go#L136)<br><strong>Comment</strong>: <pre>create 'marker' for the ledger is done as the last step so as to if a peer crash happens at any stage during this function, at restart we would know that this was not fully created.</pre><strong>Commenter</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>CommentLine</strong>: [core/ledger/kvledger/kv_ledger_provider.go#L136](https://github.com/hyperledger-gerrit-archive/fabric/blob/b7984b5bd559be72390123cb5e689ac0f9b9cd13/core/ledger/kvledger/kv_ledger_provider.go#L136)<br><strong>Comment</strong>: <pre>right, Artem in case you weren't aware the idStore tracks which ledger ids exist.  So the physical ledger is created, the genesis block is committed, and then the idStore is updated to indicate that we have a valid, usable ledger now.</pre></blockquote><h3>PatchSet Number: 3</h3><blockquote><strong>Type</strong>: REWORK<br><strong>Author</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Uploader</strong>: Manish Sethi - manish.sethi@gmail.com<br><strong>Created</strong>: 4/1/2017, 12:26:23 AM<br><strong>GitHubMergedRevision</strong>: [4e0f96ba689f1390ebb6839b519e47fa281cefbf](https://github.com/hyperledger-gerrit-archive/fabric/commit/4e0f96ba689f1390ebb6839b519e47fa281cefbf)<br><br><strong>Approver</strong>: Hyperledger Jobbuilder - jobbuilder@jenkins.hyperledger.org<br><strong>Approved</strong>: 4/1/2017, 1:54:39 AM<br><strong>Type</strong>: Verified<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Binh Nguyen - binh1010010110@gmail.com<br><strong>Approved</strong>: 4/1/2017, 11:00:39 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Baohua Yang - yangbaohua@gmail.com<br><strong>Approved</strong>: 4/1/2017, 5:32:12 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>Approver</strong>: Yacov Manevich - yacovm@il.ibm.com<br><strong>Approved</strong>: 4/1/2017, 11:25:44 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br><strong>MergedBy</strong>: Yacov Manevich<br><strong>Merged</strong>: 4/1/2017, 11:25:50 AM<br><br><strong>Approver</strong>: David Enyeart - enyeart@us.ibm.com<br><strong>Approved</strong>: 4/1/2017, 5:17:16 AM<br><strong>Type</strong>: Code-Review<br><strong>Value</strong>: 1<br><br></blockquote>